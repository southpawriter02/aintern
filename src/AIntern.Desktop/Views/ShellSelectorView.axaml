<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             xmlns:models="using:AIntern.Core.Models.Terminal"
             x:Class="AIntern.Desktop.Views.ShellSelectorView"
             x:DataType="vm:ShellSelectorViewModel">

    <!-- ┌─────────────────────────────────────────────────────────────────────┐
         │ SHELL SELECTOR VIEW (v0.5.3f)                                       │
         │ Modal dialog for selecting shell profile.                           │
         └─────────────────────────────────────────────────────────────────────┘ -->

    <Border Background="{DynamicResource BackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="16"
            Width="420"
            MaxHeight="500">
        <Grid RowDefinitions="Auto,*,Auto">
            
            <!-- Header -->
            <TextBlock Grid.Row="0"
                       Text="Select Terminal Profile"
                       FontSize="18"
                       FontWeight="SemiBold"
                       Margin="0,0,0,16" />

            <!-- Content Area -->
            <Panel Grid.Row="1">
                
                <!-- Profile List (visible when not showing new profile form) -->
                <ScrollViewer IsVisible="{Binding !ShowNewProfileForm}">
                    <ItemsControl ItemsSource="{Binding Profiles}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="models:ShellProfile">
                                <Button HorizontalAlignment="Stretch"
                                        Padding="12,10"
                                        Margin="0,0,0,6"
                                        Background="Transparent"
                                        BorderThickness="1"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        CornerRadius="6"
                                        Command="{Binding $parent[UserControl].((vm:ShellSelectorViewModel)DataContext).SelectProfileCommand}"
                                        CommandParameter="{Binding}">
                                    <Grid ColumnDefinitions="Auto,*,Auto">
                                        
                                        <!-- Profile Icon (first letter) -->
                                        <Border Grid.Column="0"
                                                Width="40"
                                                Height="40"
                                                Background="{DynamicResource AccentBrush}"
                                                CornerRadius="6"
                                                Margin="0,0,12,0">
                                            <TextBlock Text="{Binding Name[0]}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"
                                                       Foreground="White"
                                                       FontSize="18"
                                                       FontWeight="Bold" />
                                        </Border>

                                        <!-- Name and Path -->
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding Name}"
                                                           FontWeight="Medium"
                                                           FontSize="14" />
                                                <!-- Default badge -->
                                                <Border IsVisible="{Binding IsDefault}"
                                                        Background="{DynamicResource AccentBrush}"
                                                        CornerRadius="4"
                                                        Padding="6,2">
                                                    <TextBlock Text="Default"
                                                               Foreground="White"
                                                               FontSize="10" />
                                                </Border>
                                                <!-- Built-in badge -->
                                                <Border IsVisible="{Binding IsBuiltIn}"
                                                        Background="{DynamicResource SecondaryBrush}"
                                                        CornerRadius="4"
                                                        Padding="6,2">
                                                    <TextBlock Text="Built-in"
                                                               FontSize="10"
                                                               Opacity="0.7" />
                                                </Border>
                                            </StackPanel>
                                            <TextBlock Text="{Binding ShellPath}"
                                                       FontSize="11"
                                                       Opacity="0.6"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxWidth="280" />
                                        </StackPanel>

                                        <!-- Context Menu Button -->
                                        <Button Grid.Column="2"
                                                Content="⋮"
                                                Background="Transparent"
                                                Padding="8,4"
                                                VerticalAlignment="Center">
                                            <Button.Flyout>
                                                <MenuFlyout>
                                                    <MenuItem Header="Set as Default"
                                                              Command="{Binding $parent[UserControl].((vm:ShellSelectorViewModel)DataContext).SetAsDefaultCommand}"
                                                              CommandParameter="{Binding}" />
                                                    <MenuItem Header="Duplicate"
                                                              Command="{Binding $parent[UserControl].((vm:ShellSelectorViewModel)DataContext).DuplicateProfileCommand}"
                                                              CommandParameter="{Binding}" />
                                                    <Separator />
                                                    <MenuItem Header="Delete"
                                                              Command="{Binding $parent[UserControl].((vm:ShellSelectorViewModel)DataContext).DeleteProfileCommand}"
                                                              CommandParameter="{Binding}"
                                                              IsEnabled="{Binding !IsBuiltIn}" />
                                                </MenuFlyout>
                                            </Button.Flyout>
                                        </Button>
                                    </Grid>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- New Profile Form (visible when creating new profile) -->
                <StackPanel IsVisible="{Binding ShowNewProfileForm}" Spacing="16">
                    <StackPanel Spacing="4">
                        <TextBlock Text="Profile Name" FontWeight="Medium" FontSize="12" />
                        <TextBox Text="{Binding NewProfileName}"
                                 Watermark="e.g., My PowerShell" />
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <TextBlock Text="Shell Path" FontWeight="Medium" FontSize="12" />
                        <TextBox Text="{Binding NewProfilePath}"
                                 Watermark="e.g., /bin/zsh or C:\Windows\System32\cmd.exe" />
                    </StackPanel>

                    <StackPanel Spacing="4">
                        <TextBlock Text="Arguments (optional)" FontWeight="Medium" FontSize="12" />
                        <TextBox Text="{Binding NewProfileArguments}"
                                 Watermark="e.g., --login" />
                    </StackPanel>

                    <!-- Validation Error -->
                    <TextBlock Text="{Binding ValidationError}"
                               Foreground="{DynamicResource ErrorBrush}"
                               IsVisible="{Binding ValidationError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               FontSize="12" />
                </StackPanel>
            </Panel>

            <!-- Footer Buttons -->
            <StackPanel Grid.Row="2"
                        Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Margin="0,16,0,0"
                        Spacing="8">
                
                <!-- Show when in list mode -->
                <Button Content="New Profile"
                        Command="{Binding ShowNewProfileCommand}"
                        IsVisible="{Binding !ShowNewProfileForm}" />

                <!-- Show when in create mode -->
                <Button Content="Cancel"
                        Command="{Binding CancelNewProfileCommand}"
                        IsVisible="{Binding ShowNewProfileForm}" />

                <Button Content="Create"
                        Command="{Binding CreateProfileCommand}"
                        IsVisible="{Binding ShowNewProfileForm}"
                        Classes="primary" />

                <Button Content="Open"
                        Command="{Binding ConfirmSelectionCommand}"
                        IsVisible="{Binding !ShowNewProfileForm}"
                        Classes="primary" />
            </StackPanel>
        </Grid>
    </Border>
</UserControl>
