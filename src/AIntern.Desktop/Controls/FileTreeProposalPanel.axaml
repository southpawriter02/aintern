<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AIntern.Desktop.ViewModels"
             xmlns:controls="using:AIntern.Desktop.Controls"
             xmlns:converters="using:AIntern.Desktop.Converters"
             mc:Ignorable="d"
             d:DesignWidth="600" d:DesignHeight="400"
             x:Class="AIntern.Desktop.Controls.FileTreeProposalPanel"
             x:DataType="vm:FileTreeProposalViewModel">

    <!--
    ═══════════════════════════════════════════════════════════════════════════
    FILE TREE PROPOSAL PANEL (v0.4.4e)
    Main panel for displaying and managing multi-file proposals.
    ═══════════════════════════════════════════════════════════════════════════
    -->

    <UserControl.Resources>
        <converters:IconNameConverter x:Key="IconNameConverter" />
        <converters:BoolToStringConverter x:Key="BoolToStringConverter" />
        <converters:SelectionStateToCheckStateConverter x:Key="SelectionStateConverter" />
        <converters:ValidationSeverityToBrushConverter x:Key="SeverityToBrushConverter" />
    </UserControl.Resources>

    <UserControl.Styles>
        <!-- Panel Container -->
        <Style Selector="Border.proposal-panel">
            <Setter Property="Background" Value="{DynamicResource SurfaceBackground}" />
            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
            <Setter Property="BorderThickness" Value="1,1,1,3" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Margin" Value="0,8" />
            <Setter Property="Padding" Value="16" />
        </Style>

        <!-- Error Banner -->
        <Style Selector="Border.error-banner">
            <Setter Property="Background" Value="{DynamicResource ErrorBackground}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="0,12,0,0" />
        </Style>

        <!-- Warning Banner -->
        <Style Selector="Border.warning-banner">
            <Setter Property="Background" Value="{DynamicResource WarningBackground}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="0,12,0,0" />
        </Style>

        <!-- Selection Controls -->
        <Style Selector="Button.selection-button">
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="MinWidth" Value="80" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="4" />
        </Style>
        <Style Selector="Button.selection-button:pointerover">
            <Setter Property="Background" Value="{DynamicResource ControlBackground}" />
        </Style>
        <Style Selector="Button.selection-button:disabled">
            <Setter Property="Opacity" Value="0.5" />
        </Style>

        <!-- Accent Button -->
        <Style Selector="Button.accent">
            <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Padding" Value="16,8" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>
        <Style Selector="Button.accent:pointerover">
            <Setter Property="Background" Value="{DynamicResource AccentHoverBrush}" />
        </Style>
        <Style Selector="Button.accent:disabled">
            <Setter Property="Opacity" Value="0.5" />
        </Style>

        <!-- Stats Text -->
        <Style Selector="TextBlock.stat-text">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="{DynamicResource TextMuted}" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <!-- Tree Item -->
        <Style Selector="TreeViewItem">
            <Setter Property="Padding" Value="4,2" />
        </Style>
    </UserControl.Styles>

    <Border Classes="proposal-panel">
        <Grid RowDefinitions="Auto, Auto, *, Auto, Auto">

            <!-- Row 0: Header -->
            <Grid ColumnDefinitions="Auto, *, Auto">
                <!-- Icon -->
                <PathIcon Data="{StaticResource FolderPlusIcon}"
                          Width="24" Height="24"
                          Foreground="{DynamicResource AccentBrush}"
                          VerticalAlignment="Top"
                          Margin="0,2,0,0" />

                <!-- Title and Description -->
                <StackPanel Grid.Column="1" Margin="12,0,0,0">
                    <TextBlock Text="Multi-File Proposal"
                               FontWeight="SemiBold"
                               FontSize="16"
                               Foreground="{DynamicResource TextPrimary}" />
                    <TextBlock Text="{Binding Description}"
                               Foreground="{DynamicResource TextMuted}"
                               TextWrapping="Wrap"
                               MaxLines="2"
                               TextTrimming="CharacterEllipsis"
                               IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                               Margin="0,4,0,0" />
                </StackPanel>

                <!-- Stats -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="16"
                            VerticalAlignment="Top">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="{StaticResource FileIcon}"
                                  Width="14" Height="14"
                                  Foreground="{DynamicResource TextMuted}" />
                        <TextBlock Classes="stat-text"
                                   Text="{Binding FileCount, StringFormat='{}{0} files'}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <PathIcon Data="{StaticResource FolderIcon}"
                                  Width="14" Height="14"
                                  Foreground="{DynamicResource TextMuted}" />
                        <TextBlock Classes="stat-text"
                                   Text="{Binding DirectoryCount, StringFormat='{}{0} folders'}" />
                    </StackPanel>
                </StackPanel>
            </Grid>

            <!-- Row 1: Validation/Selection -->
            <Panel Grid.Row="1">
                <!-- Error Banner -->
                <Border Classes="error-banner"
                        IsVisible="{Binding HasErrors}">
                    <Grid ColumnDefinitions="Auto, *">
                        <PathIcon Data="{StaticResource ErrorIcon}"
                                  Width="16" Height="16"
                                  Foreground="{DynamicResource ErrorForeground}" />
                        <TextBlock Grid.Column="1"
                                   Text="Some files have validation errors"
                                   Foreground="{DynamicResource ErrorForeground}"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center" />
                    </Grid>
                </Border>

                <!-- Warning Banner -->
                <Border Classes="warning-banner"
                        IsVisible="{Binding HasWarnings}">
                    <Grid ColumnDefinitions="Auto, *">
                        <PathIcon Data="{StaticResource WarningIcon}"
                                  Width="16" Height="16"
                                  Foreground="{DynamicResource WarningForeground}" />
                        <TextBlock Grid.Column="1"
                                   Text="Some files already exist and will be overwritten"
                                   Foreground="{DynamicResource WarningForeground}"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center" />
                    </Grid>
                </Border>

                <!-- Selection Controls -->
                <StackPanel Orientation="Horizontal"
                            Spacing="8"
                            Margin="0,12,0,0"
                            IsVisible="{Binding !HasErrors}">
                    <Button Content="Select All"
                            Command="{Binding SelectAllCommand}"
                            Classes="selection-button"
                            ToolTip.Tip="Select all files (Ctrl+A)" />
                    <Button Content="Deselect All"
                            Command="{Binding DeselectAllCommand}"
                            Classes="selection-button"
                            ToolTip.Tip="Deselect all files (Ctrl+D)" />

                    <Rectangle Width="1"
                               Fill="{DynamicResource BorderBrush}"
                               Margin="8,4" />

                    <Button Command="{Binding ExpandAllCommand}"
                            Classes="selection-button"
                            ToolTip.Tip="Expand all folders"
                            Padding="6,4">
                        <PathIcon Data="{StaticResource ExpandAllIcon}"
                                  Width="14" Height="14" />
                    </Button>
                    <Button Command="{Binding CollapseAllCommand}"
                            Classes="selection-button"
                            ToolTip.Tip="Collapse all folders"
                            Padding="6,4">
                        <PathIcon Data="{StaticResource CollapseAllIcon}"
                                  Width="14" Height="14" />
                    </Button>

                    <!-- Selection Summary -->
                    <TextBlock VerticalAlignment="Center"
                               Margin="12,0,0,0"
                               Foreground="{DynamicResource TextMuted}">
                        <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0} of {1} selected">
                                <Binding Path="SelectedCount" />
                                <Binding Path="FileCount" />
                            </MultiBinding>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
            </Panel>

            <!-- Row 2: File Tree -->
            <Border Grid.Row="2"
                    Background="{DynamicResource ControlBackground}"
                    CornerRadius="4"
                    Margin="0,12"
                    Padding="4"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              MaxHeight="300">
                    <TreeView x:Name="FileTree"
                              ItemsSource="{Binding TreeItems}"
                              SelectedItem="{Binding SelectedItem}"
                              SelectionMode="Single"
                              AutoScrollToSelectedItem="True">
                        <TreeView.ItemTemplate>
                            <TreeDataTemplate ItemsSource="{Binding Children}">
                                <controls:FileTreeItemControl DataContext="{Binding}" />
                            </TreeDataTemplate>
                        </TreeView.ItemTemplate>
                    </TreeView>
                </ScrollViewer>
            </Border>

            <!-- Row 3: Options -->
            <StackPanel Grid.Row="3"
                        Orientation="Horizontal"
                        Spacing="16"
                        Margin="0,0,0,12">
                <CheckBox Content="Create backup for existing files"
                          IsChecked="{Binding CreateBackups}"
                          IsEnabled="{Binding !IsApplying}"
                          ToolTip.Tip="Backup existing files before overwriting (recommended)" />
            </StackPanel>

            <!-- Row 4: Actions -->
            <Grid Grid.Row="4" ColumnDefinitions="*, Auto">
                <!-- Progress Display -->
                <StackPanel IsVisible="{Binding IsApplying}"
                            Spacing="8"
                            VerticalAlignment="Center">
                    <Grid ColumnDefinitions="*, Auto">
                        <ProgressBar Value="{Binding ApplyProgress}"
                                     Minimum="0"
                                     Maximum="100"
                                     Height="6"
                                     CornerRadius="3" />
                        <TextBlock Grid.Column="1"
                                   Text="{Binding ApplyProgress, StringFormat='{}{0:F0}%'}"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextMuted}"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center" />
                    </Grid>
                    <TextBlock Text="{Binding CurrentFile}"
                               FontSize="12"
                               Foreground="{DynamicResource TextMuted}"
                               TextTrimming="CharacterEllipsis"
                               MaxWidth="400" />
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            Spacing="8">
                    <!-- Cancel Button -->
                    <Button Content="Cancel"
                            Command="{Binding CancelCommand}"
                            IsVisible="{Binding IsApplying}"
                            ToolTip.Tip="Cancel file creation (Esc)" />

                    <!-- Preview Button -->
                    <Button Content="Preview"
                            Command="{Binding PreviewCommand}"
                            IsEnabled="{Binding !IsApplying}"
                            IsVisible="{Binding !IsApplying}"
                            ToolTip.Tip="Preview changes before applying (Ctrl+P)" />

                    <!-- Apply Button -->
                    <Button Classes="accent"
                            Command="{Binding ApplyCommand}"
                            ToolTip.Tip="Create selected files (Ctrl+Enter)">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="{Binding IsApplying,
                                       Converter={StaticResource BoolToStringConverter},
                                       ConverterParameter='Creating...|Create Files'}" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Grid>
    </Border>
</UserControl>
