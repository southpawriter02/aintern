# v0.5.2b - Terminal Renderer

**Released:** 2026-01-17

SkiaSharp-based hardware-accelerated terminal rendering with full text attribute, cursor, and selection support.

---

## Overview

This version introduces the terminal rendering layer that transforms the abstract `TerminalBuffer` model into a visual representation. Using SkiaSharp for hardware acceleration, the renderer provides smooth, efficient drawing of terminal content with full support for text attributes, 256-color palette, cursor styles, and text selection.

## New Files

### Controls/Terminal/TerminalFontMetrics.cs

Font loading, measurement, and coordinate conversion for terminal rendering.

**Features:**
- Cross-platform font fallback chain (Cascadia Mono → Consolas → Monaco → Courier New → System)
- Character cell dimension calculation (CharWidth, LineHeight, Baseline)
- Terminal size calculation from pixel dimensions
- Bidirectional coordinate conversion (PixelToCell, CellToPixel)
- Bold and italic paint creation for styled text
- IDisposable implementation for resource cleanup
- Optional ILogger integration for diagnostics

### Controls/Terminal/TerminalRenderer.cs

Avalonia control using SkiaSharp for hardware-accelerated terminal rendering.

**Features:**
- `FontFamily` and `FontSize` styled properties
- Buffer binding with automatic re-rendering on content changes
- Theme support with live updates
- Selection highlighting with configurable opacity
- Cursor rendering with Block, Underline, and Bar styles
- Focus-aware cursor display (solid when focused, outline when unfocused)
- ICustomDrawOperation for direct SkiaSharp canvas access
- UI thread marshaling for background buffer updates

**Text Attributes:**
- Bold (FakeBoldText)
- Dim (alpha reduction)
- Inverse (swap foreground/background)
- Underline (line at cell bottom)
- Strikethrough (line through center)
- Hidden (skip rendering)

**Color Support:**
- Default colors (theme foreground/background)
- ANSI 16-color palette
- 256-color palette (6×6×6 color cube + 24 grayscale)
- True color (24-bit RGB)

### Tests/Controls/Terminal/TerminalFontMetricsTests.cs

40 unit tests covering all TerminalFontMetrics functionality.

**Test Coverage:**
- Initial state validation
- Font update and fallback behavior
- Terminal size calculation
- Coordinate conversion accuracy
- Roundtrip consistency
- Paint creation
- Disposal safety

## Technical Details

### Rendering Pipeline

```
Buffer.ContentChanged → InvalidateVisual → Render → TerminalRenderOperation → SkiaSharp
```

1. Buffer content changes trigger visual invalidation
2. Avalonia's render loop calls Render()
3. TerminalRenderOperation captures render state
4. ImmediateDrawingContext provides SkiaSharp lease
5. SKCanvas receives drawing commands

### Font Metrics System

The `TerminalFontMetrics` class ensures consistent character cell sizing across platforms:

- Measures character 'M' width for fixed-width calculations
- Uses SKFontMetrics for accurate baseline positioning
- Adds 2px to line height for comfortable spacing
- Creates styled typeface variants for bold/italic

### Cursor Implementation

Cursor rendering adapts to focus state:

| State | Block | Underline | Bar |
|-------|-------|-----------|-----|
| Focused | Solid fill + inverse character | Solid bar | Solid bar |
| Unfocused | Outline only | Outline | Outline |

## Statistics

- **New Files:** 3
- **New Lines of Code:** ~1,100
- **New Unit Tests:** 40
- **Test Pass Rate:** 100%

## Dependencies

- SkiaSharp (via Avalonia.Skia)
- Avalonia.VisualTree (for focus detection)
- AIntern.Core.Models.Terminal

## Related Versions

- **v0.5.2a:** Theme & Styles (provides TerminalTheme for color resolution)
- **v0.5.1b:** Terminal Models (provides TerminalBuffer, TerminalLine, TerminalCell)
- **v0.5.2c:** Terminal Control (will wrap renderer with input handling)
