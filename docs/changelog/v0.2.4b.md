# v0.2.4b - System Prompt Service

**Release Date:** 2026-01-13
**Type:** Feature (Service Layer)
**Status:** Complete

## Overview

This release implements the service layer for system prompt management. The `SystemPromptService` provides CRUD operations, template management, current prompt selection, event notifications for UI synchronization, and persistence of the current prompt selection.

**Building on:** v0.2.4a (Models & Repository)
**Design Reference:** [v0.2.4b-system-prompt-service.md](../design/v0.2.x/v0.2.4b-system-prompt-service.md)

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Service Layer Position                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ViewModels (v0.2.4c+)                                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ SystemPromptEditorViewModel, SystemPromptSelectorViewModel  │ │
│  └─────────────────────────────┬───────────────────────────────┘ │
│                                │                                 │
│                                ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              ISystemPromptService (v0.2.4b)                  │ │
│  │                                                             │ │
│  │  CurrentPrompt ─────────► For new conversations             │ │
│  │  GetAllPromptsAsync() ──► List for UI                       │ │
│  │  CreatePromptAsync() ───► CRUD operations                   │ │
│  │  SetCurrentPromptAsync()► Update selection                  │ │
│  │                                                             │ │
│  │  Events: PromptListChanged, CurrentPromptChanged            │ │
│  └───────────────────────────┬─────────────────────────────────┘ │
│                              │                                   │
│            ┌─────────────────┴─────────────────┐                 │
│            ▼                                   ▼                 │
│  ┌─────────────────┐               ┌─────────────────────────┐   │
│  │ISystemPrompt    │               │ISettingsService          │  │
│  │Repository       │               │(persist selection)       │  │
│  │(CRUD to DB)     │               │                          │  │
│  └─────────────────┘               └─────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Files Created

### 1. PromptListChangeType.cs

**Path:** `src/AIntern.Core/Events/PromptListChangeType.cs`
**Lines:** ~77

Enum categorizing the type of change that occurred to the system prompt list.

| Value | Description |
|-------|-------------|
| `PromptCreated` | A new system prompt was created |
| `PromptUpdated` | An existing system prompt was updated |
| `PromptDeleted` | A system prompt was deleted (soft delete) |
| `DefaultChanged` | The default prompt designation changed |
| `ListRefreshed` | The prompt list was refreshed from the database |

### 2. PromptListChangedEventArgs.cs

**Path:** `src/AIntern.Core/Events/PromptListChangedEventArgs.cs`
**Lines:** ~100

Event arguments for prompt list mutations.

| Property | Type | Description |
|----------|------|-------------|
| `ChangeType` | `PromptListChangeType` | Required. Type of mutation that occurred. |
| `AffectedPromptId` | `Guid?` | ID of the affected prompt (null for ListRefreshed). |
| `AffectedPromptName` | `string?` | Name of the affected prompt. |

### 3. CurrentPromptChangedEventArgs.cs

**Path:** `src/AIntern.Core/Events/CurrentPromptChangedEventArgs.cs`
**Lines:** ~85

Event arguments for current prompt selection changes.

| Property | Type | Description |
|----------|------|-------------|
| `NewPrompt` | `SystemPrompt?` | The newly selected prompt. |
| `PreviousPrompt` | `SystemPrompt?` | The previously selected prompt. |

### 4. ISystemPromptService.cs

**Path:** `src/AIntern.Core/Interfaces/ISystemPromptService.cs`
**Lines:** ~400

Service interface for system prompt management.

#### Properties

| Member | Type | Description |
|--------|------|-------------|
| `CurrentPrompt` | `SystemPrompt?` | Currently selected prompt for new conversations. |

#### Query Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `GetAllPromptsAsync()` | `IReadOnlyList<SystemPrompt>` | All active prompts. |
| `GetUserPromptsAsync()` | `IReadOnlyList<SystemPrompt>` | User-created prompts only. |
| `GetTemplatesAsync()` | `IReadOnlyList<SystemPrompt>` | Built-in prompts only. |
| `GetByIdAsync(id)` | `SystemPrompt?` | Single prompt by ID. |
| `GetDefaultPromptAsync()` | `SystemPrompt?` | The default prompt. |
| `SearchPromptsAsync(query)` | `IReadOnlyList<SystemPrompt>` | Search by name/description. |

#### Mutation Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `CreatePromptAsync(...)` | `SystemPrompt` | Create new prompt. |
| `CreateFromTemplateAsync(...)` | `SystemPrompt` | Clone from template. |
| `UpdatePromptAsync(...)` | `SystemPrompt` | Update existing prompt. |
| `DeletePromptAsync(id)` | `Task` | Soft delete prompt. |
| `DuplicatePromptAsync(...)` | `SystemPrompt` | Clone existing prompt. |
| `SetAsDefaultAsync(id)` | `Task` | Set as default prompt. |
| `SetCurrentPromptAsync(id?)` | `Task` | Set current selection. |

#### Utility Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `FormatPromptForContext(prompt)` | `string` | Format for LLM context. |
| `InitializeAsync()` | `Task` | Load current prompt from settings. |

#### Events

| Event | Args Type | Description |
|-------|-----------|-------------|
| `PromptListChanged` | `PromptListChangedEventArgs` | Fired on list mutations. |
| `CurrentPromptChanged` | `CurrentPromptChangedEventArgs` | Fired on selection change. |

### 5. SystemPromptService.cs

**Path:** `src/AIntern.Services/SystemPromptService.cs`
**Lines:** ~750

Full implementation of `ISystemPromptService`.

#### Key Implementation Details

**Thread Safety:**
- Uses `SemaphoreSlim` for all async operations
- Same pattern as `InferenceSettingsService`

**Logging Pattern:**
```csharp
_logger.LogDebug("[ENTER] MethodName - Param: {Value}");
_logger.LogDebug("[INFO] Significant state change");
_logger.LogDebug("[SKIP] No-op condition reason");
_logger.LogDebug("[EXIT] MethodName - Result: {Result}, Duration: {Ms}ms");
_logger.LogDebug("[EVENT] EventName - Details");
```

**Auto-Increment Duplicate Names:**
- When creating from template or duplicating, if name exists, appends " (1)", " (2)", etc.
- Falls back to timestamp suffix after 100 attempts

**Initialization Flow:**
1. Load `CurrentSystemPromptId` from settings
2. If found, load prompt by ID
3. If not found or inactive, fall back to default prompt
4. If no default, use first available prompt
5. No events fired during initialization

**Delete Behavior:**
- Built-in prompts cannot be deleted (throws `InvalidOperationException`)
- If deleted prompt was current, automatically resets to default
- Fires both `PromptListChanged` and `CurrentPromptChanged` events

## Files Modified

### 1. AppSettings.cs

**Path:** `src/AIntern.Core/Models/AppSettings.cs`
**Changes:** Added `CurrentSystemPromptId` property

```csharp
/// <summary>
/// Gets or sets the ID of the currently selected system prompt.
/// </summary>
/// <value>
/// The GUID of the selected system prompt, or <c>null</c> if using the default.
/// </value>
/// <remarks>
/// <para>
/// Persisted to settings.json to restore the user's last-selected prompt on startup.
/// </para>
/// <para>Added in v0.2.4b.</para>
/// </remarks>
public Guid? CurrentSystemPromptId { get; set; }
```

### 2. ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`
**Changes:** Added `ISystemPromptService` registration

```csharp
// System Prompt: manages system prompts, templates, and current selection.
// Uses a factory to resolve scoped repository dependencies.
// The service maintains prompt selection state and fires events on changes.
// Added in v0.2.4b.
services.AddSingleton<ISystemPromptService>(sp =>
{
    var scope = sp.CreateScope();
    return new SystemPromptService(
        scope.ServiceProvider.GetRequiredService<ISystemPromptRepository>(),
        sp.GetRequiredService<ISettingsService>(),
        sp.GetRequiredService<ILogger<SystemPromptService>>());
});
```

## Event Flow

### Create Prompt
```
CreatePromptAsync() called
    ├─ Validate parameters
    ├─ Check name uniqueness
    ├─ Create entity in repository
    ├─ Fire PromptListChanged(PromptCreated)
    └─ Return created prompt
```

### Set Current Prompt
```
SetCurrentPromptAsync() called
    ├─ Load prompt from repository
    ├─ Update _currentPrompt field
    ├─ Increment usage count
    ├─ Persist to settings.json
    ├─ Fire CurrentPromptChanged
    └─ Complete
```

### Delete Prompt (when current)
```
DeletePromptAsync() called
    ├─ Verify not built-in
    ├─ Soft delete in repository
    ├─ Fire PromptListChanged(PromptDeleted)
    ├─ Reset current to default
    ├─ Fire CurrentPromptChanged
    └─ Complete
```

## Logging Specifications

| Marker | Level | Usage |
|--------|-------|-------|
| `[ENTER]` | Debug | Method entry with parameters |
| `[INFO]` | Debug/Info | Significant state changes |
| `[SKIP]` | Debug | No-op conditions (early returns) |
| `[EXIT]` | Debug/Info | Method completion with duration |
| `[EVENT]` | Debug | Event firing |
| `[INIT]` | Debug | Constructor completion |
| `[DISPOSE]` | Debug | Resource cleanup |

## Usage Examples

### Initialize on Startup

```csharp
// In App.OnFrameworkInitializationCompleted
var promptService = services.GetRequiredService<ISystemPromptService>();
await promptService.InitializeAsync();
```

### Subscribe to Events

```csharp
_promptService.PromptListChanged += (s, e) =>
{
    switch (e.ChangeType)
    {
        case PromptListChangeType.PromptCreated:
            Console.WriteLine($"Created: {e.AffectedPromptName}");
            break;
        case PromptListChangeType.PromptDeleted:
            Console.WriteLine($"Deleted: {e.AffectedPromptId}");
            break;
    }
    RefreshPromptList();
};

_promptService.CurrentPromptChanged += (s, e) =>
{
    Console.WriteLine($"Switched to: {e.NewPrompt?.Name}");
    UpdateUI();
};
```

### Create Custom Prompt

```csharp
var prompt = await _promptService.CreatePromptAsync(
    name: "Code Reviewer",
    content: "You are a senior code reviewer...",
    description: "Reviews code for bugs and style",
    category: "Code",
    tags: ["coding", "review", "professional"]);
```

### Create from Template

```csharp
// Clone built-in template
var custom = await _promptService.CreateFromTemplateAsync(
    templateId: SystemPromptTemplates.DefaultAssistantId,
    newName: "My Custom Assistant");
```

### Set Current Prompt

```csharp
// Select a specific prompt
await _promptService.SetCurrentPromptAsync(prompt.Id);

// Reset to default
await _promptService.SetCurrentPromptAsync(null);
```

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Separate events for list vs current | Different subscribers need different information |
| Auto-increment duplicate names | Better UX than throwing errors on duplicates |
| Persist CurrentSystemPromptId in settings.json | Fast startup, survives reinstall |
| Fall back to default on deleted current | Never leave user without a prompt |
| Soft delete via repository | Consistent with repository pattern |
| FormatPromptForContext() hook | Future extensibility for model-specific formatting |
| SemaphoreSlim for thread safety | Same pattern as InferenceSettingsService |
| No events during InitializeAsync | Avoid triggering subscribers before app is ready |

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | CurrentPrompt persists across app restarts | Implemented |
| AC-2 | GetUserPromptsAsync returns only custom prompts | Implemented |
| AC-3 | GetTemplatesAsync returns only built-in prompts | Implemented |
| AC-4 | CreatePromptAsync validates name uniqueness | Implemented |
| AC-5 | Cannot delete built-in prompts | Implemented |
| AC-6 | CreateFromTemplateAsync auto-increments duplicate names | Implemented |
| AC-7 | DeletePromptAsync resets CurrentPrompt if deleted | Implemented |
| AC-8 | PromptListChanged event fires on all mutations | Implemented |
| AC-9 | CurrentPromptChanged event fires on selection change | Implemented |
| AC-10 | Usage count increments on SetCurrentPromptAsync | Implemented |
| AC-11 | Build passes with 0 errors, 0 warnings | To verify |
| AC-12 | All existing tests pass | To verify |

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Core/Events/PromptListChangeType.cs` | Created | ~77 |
| `src/AIntern.Core/Events/PromptListChangedEventArgs.cs` | Created | ~100 |
| `src/AIntern.Core/Events/CurrentPromptChangedEventArgs.cs` | Created | ~85 |
| `src/AIntern.Core/Interfaces/ISystemPromptService.cs` | Created | ~400 |
| `src/AIntern.Services/SystemPromptService.cs` | Created | ~750 |
| `src/AIntern.Core/Models/AppSettings.cs` | Modified | +20 |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Modified | +15 |
| **Total** | | ~1,447 |

## Next Steps (v0.2.4c+)

| Version | Description |
|---------|-------------|
| v0.2.4c | SystemPromptEditorViewModel with service integration |
| v0.2.4d | SystemPromptSelectorViewModel and UI dropdown |
| v0.2.4e | SystemPrompt editor dialog UI |
| v0.2.4f | Integration testing and polish |

## Related Documentation

- [v0.2.4-system-prompt-editor.md](../design/v0.2.x/v0.2.4-system-prompt-editor.md) - Feature overview
- [v0.2.4a.md](v0.2.4a.md) - Models & Repository changelog
- [v0.2.4b-system-prompt-service.md](../design/v0.2.x/v0.2.4b-system-prompt-service.md) - Design specification
