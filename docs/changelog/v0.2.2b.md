# v0.2.2b Changelog - ViewModel Layer

**Release Date:** 2026-01-12
**Version:** v0.2.2b
**Status:** Complete

---

## Overview

This release implements the ViewModel layer for conversation persistence, bridging the `DatabaseConversationService` (v0.2.2a) with the UI layer. It introduces the dispatcher abstraction for testable ViewModels and three core ViewModels for the conversation list sidebar.

---

## New Files

### IDispatcher.cs

**Path:** `src/AIntern.Desktop/IDispatcher.cs`

UI thread dispatching abstraction enabling unit testing of ViewModels without requiring the Avalonia runtime.

```csharp
public interface IDispatcher
{
    Task InvokeAsync(Action action);
    Task<T> InvokeAsync<T>(Func<T> func);
    Task InvokeAsync(Func<Task> action);
}
```

**Key Features:**
- Three overloads for sync action, typed function, and async action
- Enables mock implementations for unit testing
- Decouples ViewModels from Avalonia.Threading

---

### AvaloniaDispatcher.cs

**Path:** `src/AIntern.Desktop/AvaloniaDispatcher.cs`

Production implementation of `IDispatcher` using Avalonia's `Dispatcher.UIThread`.

**Key Features:**
- All operations logged at Debug level with timing
- `[ENTER]/[EXIT]` logging pattern for troubleshooting
- Thread-safe singleton via DI

---

### ConversationSummaryViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/ConversationSummaryViewModel.cs`

ViewModel for a single conversation item in the sidebar list.

**Properties:**

| Region | Properties |
|--------|------------|
| Identity | `Id` (Guid, immutable) |
| Display | `Title`, `UpdatedAt`, `MessageCount`, `Preview`, `ModelName` |
| State | `IsSelected`, `IsPinned` |
| Rename | `IsRenaming`, `EditingTitle` |
| Computed | `DisplayTitle`, `RelativeTime`, `MessageCountText` |

**RelativeTime Formatting:**
- "Just now" - Less than 1 minute
- "5m ago" - Minutes (1-59)
- "2h ago" - Hours (1-23)
- "3d ago" - Days (1-6)
- "2w ago" - Weeks (1-3)
- "Jan 15" - Older than 30 days

**Methods:**
- `BeginRename()` - Initiates inline rename
- `CancelRename()` - Discards rename changes

---

### ConversationGroupViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/ConversationGroupViewModel.cs`

ViewModel for a date-based group of conversations.

**Properties:**

| Property | Type | Description |
|----------|------|-------------|
| `DateGroup` | `DateGroup` (enum) | Grouping category |
| `Title` | `string` | Display title ("Today", "Yesterday", etc.) |
| `IsExpanded` | `bool` | Collapse/expand state (default: true) |
| `Conversations` | `ObservableCollection<ConversationSummaryViewModel>` | Child items |
| `Count` | `int` (computed) | Auto-updates on collection change |

**Static Helper:**
- `GetTitleForGroup(DateGroup)` - Returns localized title string

---

### ConversationListViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/ConversationListViewModel.cs`

Main ViewModel for the conversation list sidebar (~530 lines).

**Observable Properties:**

| Property | Type | Purpose |
|----------|------|---------|
| `Groups` | `ObservableCollection<ConversationGroupViewModel>` | Date-grouped conversations |
| `SelectedConversation` | `ConversationSummaryViewModel?` | Currently selected item |
| `SearchQuery` | `string` | Search text (triggers debounced search) |
| `IsLoading` | `bool` | Loading state for spinner |
| `IsEmpty` | `bool` | Empty state indicator |
| `IsSearching` | `bool` | Search mode indicator |

**Commands (10 total):**

| Command | Description |
|---------|-------------|
| `LoadConversationsCommand` | Initial load and refresh |
| `CreateNewConversationCommand` | Create new conversation |
| `SelectConversationCommand` | Select and load conversation |
| `DeleteConversationCommand` | Delete conversation |
| `RenameConversationCommand` | Begin inline rename |
| `ConfirmRenameCommand` | Confirm rename operation |
| `CancelRenameCommand` | Cancel rename operation |
| `ArchiveConversationCommand` | Archive conversation |
| `TogglePinCommand` | Toggle pin status |
| `ClearSearchCommand` | Clear search query |

**Search Implementation:**
- 300ms debounce delay to reduce API calls
- Uses `CancellationTokenSource` to cancel pending searches
- Automatic cancellation on new keystroke

**Event Handling:**
- Subscribes to `IConversationService.ConversationListChanged`
- Subscribes to `IConversationService.ConversationChanged`
- Processes events on UI thread via `IDispatcher`

**Lifecycle:**
- Implements `IDisposable`
- Unsubscribes from events on dispose
- Cancels and disposes search CTS

---

## Modified Files

### ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`

**Changes:**
- Added new "UI Infrastructure" section
- Registered `IDispatcher` → `AvaloniaDispatcher` (Singleton)
- Registered `ConversationListViewModel` (Transient)

```csharp
// UI Infrastructure
services.AddSingleton<IDispatcher, AvaloniaDispatcher>();

// ViewModels
services.AddTransient<ConversationListViewModel>();
```

---

## Logging Specifications

All ViewModels follow exhaustive logging patterns:

| Level | Usage |
|-------|-------|
| Debug | `[ENTER]`/`[EXIT]` with timing, state changes |
| Information | User actions (create, delete, rename, select, pin) |
| Warning | Recoverable failures |
| Error | Unrecoverable failures with stack traces |

**Log Message Patterns:**
```
[INIT] ComponentName created
[ENTER] MethodName - Context: {Value}
[INFO] Description - {Details}
[EXIT] MethodName completed in {ElapsedMs}ms
[EVENT] EventName - Type: {Type}, Id: {Id}
[SKIP] MethodName - Reason
[CANCELLED] MethodName - operation cancelled
[ERROR] Description - {Details}
```

---

## Verification Results

| Check | Result |
|-------|--------|
| Build | ✅ 0 errors, 0 warnings |
| Tests | ✅ 120 passed, 0 failed |

---

## Dependencies

- **CommunityToolkit.Mvvm** - `[ObservableProperty]`, `[RelayCommand]`
- **Microsoft.Extensions.Logging** - `ILogger<T>`
- **System.Diagnostics** - `Stopwatch` for timing
- **Avalonia.Threading** - `Dispatcher.UIThread`

---

## Architecture Notes

### Dispatcher Pattern

The `IDispatcher` abstraction enables:
1. **Testability**: Unit tests can run without Avalonia runtime
2. **Thread Safety**: All UI updates marshalled correctly
3. **Logging**: Cross-thread operations are traceable

### ViewModel Relationships

```
ConversationListViewModel (DI-injected)
├── Groups: ObservableCollection<ConversationGroupViewModel>
│   └── ConversationGroupViewModel (created internally)
│       └── Conversations: ObservableCollection<ConversationSummaryViewModel>
│           └── ConversationSummaryViewModel (created internally)
```

### Event Flow

```
IConversationService.ConversationListChanged
    → OnConversationListChanged (async void)
        → IDispatcher.InvokeAsync
            → LoadConversationsAsync
                → UpdateGroups
```

---

## Next Steps

- **v0.2.2c**: Implement conversation list UI (AXAML views)
- **v0.2.2d**: Integrate sidebar into MainWindow
