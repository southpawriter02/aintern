# Changelog v0.2.1b

**Release Date:** 2026-01-12

Entity Classes for the Memory Management phase - defining the domain model for conversations, messages, system prompts, and inference presets.

---

## Highlights

- Four new entity classes for database persistence
- Comprehensive XML documentation with `<remarks>`, `<list>`, and `<example>` tags
- 26 unit tests verifying default values and initialization
- Feature documentation for entity classes
- Reuses existing `MessageRole` enum from `AIntern.Core.Models`

---

## Entity Relationship Diagram

```
SystemPromptEntity (1) ──────┐
                             │ optional FK (SetNull on delete)
                             ▼
ConversationEntity (1) ◄──── SystemPromptId
        │
        │ 1:N (Cascade delete)
        ▼
MessageEntity (N)
        │
        └── Role: MessageRole enum (System=0, User=1, Assistant=2)


InferencePresetEntity (standalone - no relationships)
```

---

## ConversationEntity

Represents a chat session containing multiple messages.

**Location:** `src/AIntern.Core/Entities/ConversationEntity.cs`

### Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `Id` | `Guid` | - | Primary key |
| `Title` | `string` | "New Conversation" | Display title |
| `CreatedAt` | `DateTime` | - | Creation timestamp (UTC) |
| `UpdatedAt` | `DateTime` | - | Last modification (UTC) |
| `ModelPath` | `string?` | null | Path to model file |
| `ModelName` | `string?` | null | Human-readable model name |
| `SystemPromptId` | `Guid?` | null | FK to SystemPromptEntity |
| `IsArchived` | `bool` | false | Archive flag |
| `IsPinned` | `bool` | false | Pin flag |
| `MessageCount` | `int` | 0 | Denormalized message count |
| `TotalTokenCount` | `int` | 0 | Sum of all message tokens |

### Navigation Properties

| Property | Type | Description |
|----------|------|-------------|
| `SystemPrompt` | `SystemPromptEntity?` | Associated system prompt |
| `Messages` | `ICollection<MessageEntity>` | All messages (initialized to empty list) |

### Code Example

```csharp
var conversation = new ConversationEntity
{
    Id = Guid.NewGuid(),
    Title = "How to implement DI in C#",
    CreatedAt = DateTime.UtcNow,
    UpdatedAt = DateTime.UtcNow,
    ModelName = "Llama 2 7B Chat"
};
```

---

## MessageEntity

Represents a single message within a conversation.

**Location:** `src/AIntern.Core/Entities/MessageEntity.cs`

### Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `Id` | `Guid` | - | Primary key |
| `ConversationId` | `Guid` | - | FK to ConversationEntity |
| `Role` | `MessageRole` | - | System, User, or Assistant |
| `Content` | `string` | "" | Message text |
| `SequenceNumber` | `int` | - | Order within conversation |
| `Timestamp` | `DateTime` | - | Creation time (UTC) |
| `EditedAt` | `DateTime?` | null | Last edit time |
| `TokenCount` | `int?` | null | Token count |
| `GenerationTimeMs` | `int?` | null | Generation duration (ms) |
| `TokensPerSecond` | `float?` | null | Generation speed |
| `IsEdited` | `bool` | false | Edit flag |
| `IsComplete` | `bool` | true | Completion flag |

### Navigation Properties

| Property | Type | Description |
|----------|------|-------------|
| `Conversation` | `ConversationEntity` | Parent conversation (required, `= null!`) |

### MessageRole Enum

Reuses the existing enum from `AIntern.Core.Models.ChatMessage`:

| Value | Int | Description |
|-------|-----|-------------|
| System | 0 | Hidden instructions for the model |
| User | 1 | Human input |
| Assistant | 2 | AI-generated response |

### Code Example

```csharp
using AIntern.Core.Models; // For MessageRole

var message = new MessageEntity
{
    Id = Guid.NewGuid(),
    ConversationId = conversationId,
    Role = MessageRole.User,
    Content = "How do I implement dependency injection?",
    SequenceNumber = 1,
    Timestamp = DateTime.UtcNow
};
```

---

## SystemPromptEntity

Represents a reusable system prompt template.

**Location:** `src/AIntern.Core/Entities/SystemPromptEntity.cs`

### Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `Id` | `Guid` | - | Primary key |
| `Name` | `string` | "" | Unique display name (max 100 chars) |
| `Description` | `string?` | null | Optional description (max 500 chars) |
| `Content` | `string` | "" | The prompt text (unlimited) |
| `Category` | `string` | "General" | Organization category (max 50 chars) |
| `CreatedAt` | `DateTime` | - | Creation timestamp (UTC) |
| `UpdatedAt` | `DateTime` | - | Last modification (UTC) |
| `IsDefault` | `bool` | false | Default prompt flag |
| `IsBuiltIn` | `bool` | false | Built-in template flag |
| `IsActive` | `bool` | true | Visibility flag (soft-delete) |
| `UsageCount` | `int` | 0 | Usage statistics |

### Navigation Properties

| Property | Type | Description |
|----------|------|-------------|
| `Conversations` | `ICollection<ConversationEntity>` | Conversations using this prompt (initialized to empty list) |

### Predefined Categories

| Category | Description |
|----------|-------------|
| General | General-purpose assistants |
| Code | Programming and development |
| Creative | Creative writing and brainstorming |
| Technical | Technical documentation |

### Code Example

```csharp
var prompt = new SystemPromptEntity
{
    Id = Guid.NewGuid(),
    Name = "Code Expert",
    Description = "Specialized in C# development",
    Content = "You are a senior C# developer. Help users write clean, maintainable code.",
    Category = "Code",
    CreatedAt = DateTime.UtcNow,
    UpdatedAt = DateTime.UtcNow
};
```

---

## InferencePresetEntity

Represents saved inference parameter configurations.

**Location:** `src/AIntern.Core/Entities/InferencePresetEntity.cs`

### Properties

| Property | Type | Default | Range | Description |
|----------|------|---------|-------|-------------|
| `Id` | `Guid` | - | - | Primary key |
| `Name` | `string` | "" | 1-100 chars | Unique display name |
| `Description` | `string?` | null | 0-500 chars | Use case description |
| `Temperature` | `float` | 0.7 | 0.0-2.0 | Randomness control |
| `TopP` | `float` | 0.9 | 0.0-1.0 | Nucleus sampling |
| `TopK` | `int` | 40 | 1-100 | Token selection limit |
| `RepeatPenalty` | `float` | 1.1 | 1.0-2.0 | Repetition penalty |
| `MaxTokens` | `int` | 2048 | 1-32768 | Max response length |
| `ContextSize` | `int` | 4096 | 512-131072 | Context window |
| `IsDefault` | `bool` | false | - | Default preset flag |
| `IsBuiltIn` | `bool` | false | - | Built-in flag |
| `CreatedAt` | `DateTime` | - | - | Creation timestamp |
| `UpdatedAt` | `DateTime` | - | - | Last modification |

### Built-in Presets (seeded in v0.2.1e)

| Preset | Temp | TopP | TopK | MaxTokens | Context | Use Case |
|--------|------|------|------|-----------|---------|----------|
| Balanced | 0.7 | 0.9 | 40 | 2048 | 4096 | General conversation |
| Precise | 0.2 | 0.8 | 20 | 1024 | 4096 | Factual responses |
| Creative | 1.2 | 0.95 | 60 | 4096 | 8192 | Brainstorming |
| Long-form | 0.7 | 0.9 | 40 | 8192 | 16384 | Detailed explanations |

### Code Example

```csharp
var preset = new InferencePresetEntity
{
    Id = Guid.NewGuid(),
    Name = "Creative",
    Description = "Higher temperature for creative writing",
    Temperature = 1.2f,
    TopP = 0.95f,
    MaxTokens = 4096,
    CreatedAt = DateTime.UtcNow,
    UpdatedAt = DateTime.UtcNow
};
```

---

## Unit Tests

### AIntern.Core.Tests/Entities/EntityTests.cs

26 unit tests organized by entity:

| Entity | Test Count | Coverage |
|--------|------------|----------|
| MessageRole Enum | 3 | Integer values (0, 1, 2) |
| ConversationEntity | 6 | Title, Messages collection, counts, flags |
| MessageEntity | 6 | Content, IsComplete, IsEdited, statistics |
| SystemPromptEntity | 5 | Name, Content, Category, IsActive, Conversations |
| InferencePresetEntity | 6 | Temperature, TopP, TopK, RepeatPenalty, MaxTokens, ContextSize |

### Test Pattern

All tests follow Arrange-Act-Assert with XML documentation:

```csharp
/// <summary>
/// Verifies that a new ConversationEntity has the default title "New Conversation".
/// </summary>
[Fact]
public void ConversationEntity_Constructor_SetsDefaultTitle()
{
    // Arrange & Act
    var conversation = new ConversationEntity();

    // Assert
    Assert.Equal("New Conversation", conversation.Title);
}
```

---

## Files Changed

### New Files

| Path | Description |
|------|-------------|
| `src/AIntern.Core/Entities/ConversationEntity.cs` | Chat session entity |
| `src/AIntern.Core/Entities/MessageEntity.cs` | Message entity |
| `src/AIntern.Core/Entities/SystemPromptEntity.cs` | System prompt entity |
| `src/AIntern.Core/Entities/InferencePresetEntity.cs` | Inference preset entity |
| `tests/AIntern.Core.Tests/Entities/EntityTests.cs` | 26 unit tests |
| `docs/features/entities.md` | Feature documentation |
| `docs/changelog/v0.2.1b.md` | This changelog |

### Modified Files

| Path | Changes |
|------|---------|
| `CHANGELOG.md` | Added v0.2.1b entry |

---

## Directory Structure

After v0.2.1b:

```
src/AIntern.Core/
├── Entities/                    [NEW DIRECTORY]
│   ├── ConversationEntity.cs    [NEW]
│   ├── MessageEntity.cs         [NEW]
│   ├── SystemPromptEntity.cs    [NEW]
│   └── InferencePresetEntity.cs [NEW]
├── Events/
├── Exceptions/
├── Interfaces/
└── Models/
    └── ChatMessage.cs           # Contains MessageRole enum (existing)

tests/AIntern.Core.Tests/
├── Entities/                    [NEW DIRECTORY]
│   └── EntityTests.cs           [NEW]
└── Models/

docs/features/
└── entities.md                  [NEW]
```

---

## Design Decisions

### 1. Entities in Core Project

Entities are placed in `AIntern.Core` rather than `AIntern.Data` to:
- Keep domain models independent of EF Core
- Allow Services to use entities without Data dependency
- Maintain clean separation of concerns

### 2. Reuse Existing MessageRole Enum

The existing `MessageRole` enum in `AIntern.Core.Models.ChatMessage` was reused instead of creating a duplicate in `Enums/` to:
- Avoid code duplication
- Maintain consistency with existing `ChatMessage` model
- Prevent potential enum mismatch issues

### 3. Sealed Classes

All entity classes are `sealed` to:
- Prevent accidental inheritance
- Avoid EF Core proxy issues
- Clearly indicate they are final implementations

### 4. GUID Primary Keys

GUIDs are used instead of integers to:
- Eliminate ID generation coordination
- Support disconnected scenarios
- Enable potential future sync features
- Improve security (harder to guess)

### 5. Denormalized Counts

`MessageCount` and `TotalTokenCount` are stored on ConversationEntity to:
- Avoid COUNT queries for conversation lists
- Improve read performance
- Accept minor write overhead

### 6. Soft Delete for System Prompts

`IsActive` flag enables soft-delete to:
- Preserve history for conversations using deleted prompts
- Allow recovery of accidentally deleted prompts
- Prevent deletion of built-in prompts

---

## Verification

### Build

```bash
dotnet build AIntern.sln
# Build succeeded. 0 Warning(s) 0 Error(s)
```

### Tests

```bash
dotnet test
# Total tests: 69
# Passed: 69
# - AIntern.Core.Tests: 35 passed (26 new + 9 existing)
# - AIntern.Services.Tests: 1 passed
# - AIntern.Data.Tests: 33 passed
```

---

## Metrics

| Metric | Value |
|--------|-------|
| New Entity Files | 4 |
| New Test Files | 1 |
| New Tests | 26 |
| Total Tests | 69 |
| New Documentation Files | 2 |

---

## Next Steps

This release establishes the domain model for v0.2.1c which will add:

- `AInternDbContext` - Entity Framework Core DbContext
- Fluent API entity configurations
- Database indexes and constraints
- Initial EF Core migration
