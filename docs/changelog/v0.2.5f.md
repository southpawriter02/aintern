# v0.2.5f - Export UI

**Release Date:** 2026-01-14
**Type:** Feature (UI Layer)
**Status:** Complete

## Overview

This release implements the Export UI components for the application. The feature provides an export dialog (Ctrl+E) with format selection (Markdown, JSON, PlainText, HTML), configurable options (timestamps, system prompt, metadata, token counts), and live preview.

**Building on:** v0.2.5e (Search UI)
**Design Reference:** [v0.2.5f-export-ui.md](../design/v0.2.x/v0.2.5f-export-ui.md)

## Architecture

```
+------------------------------------------------------------------+
|                        v0.2.5f Export UI                          |
+------------------------------------------------------------------+
|                                                                    |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      ExportViewModel                         │  |
|  │  Properties:                                                 │  |
|  │  ├── SelectedFormat (ExportFormat) = Markdown                │  |
|  │  ├── IncludeTimestamps (bool) = true                         │  |
|  │  ├── IncludeSystemPrompt (bool) = true                       │  |
|  │  ├── IncludeMetadata (bool) = true                           │  |
|  │  ├── IncludeTokenCounts (bool) = false                       │  |
|  │  ├── Preview (string) - live preview, max 500 chars          │  |
|  │  ├── IsExporting (bool) - disable during export              │  |
|  │  └── ShouldClose (bool) - triggers dialog close              │  |
|  │                                                              │  |
|  │  Commands:                                                   │  |
|  │  ├── ExportCommand → save file dialog → write file           │  |
|  │  └── CancelCommand → sets ShouldClose                        │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                              │                                     |
|                              ▼                                     |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      ExportDialog                            │  |
|  │  Layout (2-row Grid):                                        │  |
|  │  ├── Row 0: Content (ScrollViewer)                           │  |
|  │  │   ├── Format section (RadioButtons)                       │  |
|  │  │   ├── Options section (CheckBoxes)                        │  |
|  │  │   ├── Preview section (monospace TextBlock)               │  |
|  │  │   └── Error message (red text if any)                     │  |
|  │  └── Row 1: Buttons (Cancel + Export)                        │  |
|  │                                                              │  |
|  │  Keyboard: Escape → CancelCommand                            │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                              │                                     |
|                              ▼                                     |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      Integration                             │  |
|  │  MainWindow:                                                 │  |
|  │  ├── Ctrl+E keybinding → OpenExportCommand                   │  |
|  │  └── MainWindowViewModel.OpenExportAsync()                   │  |
|  │                                                              │  |
|  │  Supporting:                                                 │  |
|  │  └── EnumBoolConverter - RadioButton ↔ enum binding          │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                                                                    |
+------------------------------------------------------------------+
```

## Key Features

### 1. Format Selection

Four export formats are available via RadioButtons:
- **Markdown (.md)**: Rich text with headers and formatting
- **JSON (.json)**: Structured data for programmatic access
- **Plain Text (.txt)**: Simple text without formatting
- **HTML (.html)**: Web-ready with styling

### 2. Export Options

Configurable options via CheckBoxes:
- **Include timestamps**: Add timestamp to each message (default: on)
- **Include system prompt**: Include the system prompt section (default: on)
- **Include metadata**: Include conversation dates (default: on)
- **Include token counts**: Show token counts per message (default: off)

### 3. Live Preview

The preview updates automatically when:
- Format selection changes
- Any option checkbox changes
- Dialog first opens (via InitializeAsync)

Preview is limited to 500 characters with truncation.

### 4. Export Workflow

1. Generate export content via IExportService
2. Open native file save dialog (IStorageProvider)
3. Write content to selected file
4. Close dialog on success

### 5. Error Handling

- Error message displayed in red below preview
- Dialog remains open on error for retry
- IsExporting prevents multiple simultaneous exports

### 6. EnumBoolConverter

New converter enabling RadioButton ↔ enum binding:
- Convert: Returns true if enum matches parameter
- ConvertBack: Parses parameter when checked, returns DoNothing when unchecked
- Case-insensitive comparison
- Singleton pattern for efficiency

## Files Created

### 1. EnumBoolConverter.cs

**Path:** `src/AIntern.Desktop/Converters/EnumBoolConverter.cs`
**Lines:** ~160

Value converter for RadioButton binding to enum properties.

#### Key Features

| Feature | Description |
|---------|-------------|
| Singleton Pattern | `Instance` property for reuse |
| Case-insensitive | Compares enum.ToString() to parameter |
| DoNothing on uncheck | Prevents update when RadioButton unchecked |
| Full documentation | XML docs with examples |

#### Usage

```xml
<Window.Resources>
    <converters:EnumBoolConverter x:Key="EnumBoolConverter" />
</Window.Resources>

<RadioButton Content="Markdown (.md)"
             IsChecked="{Binding SelectedFormat,
                        Converter={StaticResource EnumBoolConverter},
                        ConverterParameter=Markdown}" />
```

### 2. ExportViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/ExportViewModel.cs`
**Lines:** ~500

ViewModel for export dialog with format selection, options, and live preview.

#### Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `SelectedFormat` | `ExportFormat` | Markdown | Selected export format |
| `IncludeTimestamps` | `bool` | true | Include message timestamps |
| `IncludeSystemPrompt` | `bool` | true | Include system prompt |
| `IncludeMetadata` | `bool` | true | Include conversation metadata |
| `IncludeTokenCounts` | `bool` | false | Include token counts |
| `Preview` | `string` | "" | Live preview content |
| `IsExporting` | `bool` | false | Export in progress |
| `ShouldClose` | `bool` | false | Triggers dialog close |

#### Commands

| Command | Description |
|---------|-------------|
| `ExportCommand` | Export to file (opens save dialog) |
| `CancelCommand` | Close dialog without export |

#### Methods

| Method | Description |
|--------|-------------|
| `InitializeAsync` | Load initial preview |
| `UpdatePreviewAsync` | Refresh preview with current options |
| `CreateOptions` | Build ExportOptions from properties |

### 3. ExportDialog.axaml

**Path:** `src/AIntern.Desktop/Views/ExportDialog.axaml`
**Lines:** ~190

XAML layout for export dialog.

#### Window Properties

| Property | Value |
|----------|-------|
| Width | 550 |
| Height | 500 |
| MinWidth | 400 |
| MinHeight | 400 |
| WindowStartupLocation | CenterOwner |
| CanResize | False |

#### Layout Structure

```
Grid (2 rows)
├── Row 0: ScrollViewer (Content)
│   └── StackPanel
│       ├── Format Section
│       │   └── 4 RadioButtons (Markdown, JSON, PlainText, HTML)
│       ├── Options Section
│       │   └── 4 CheckBoxes (timestamps, system prompt, metadata, tokens)
│       ├── Preview Section
│       │   └── Border with ScrollViewer + monospace TextBlock
│       └── Error Message (red, conditional visibility)
└── Row 1: Buttons
    └── StackPanel (Cancel, Export)
```

#### Styles

| Style | Target | Description |
|-------|--------|-------------|
| `section-header` | TextBlock | Bold section titles |
| `preview-border` | Border | Styled preview container |
| `accent` | Button | Colored export button |

### 4. ExportDialog.axaml.cs

**Path:** `src/AIntern.Desktop/Views/ExportDialog.axaml.cs`
**Lines:** ~150

Code-behind for ExportDialog with lifecycle management.

#### Key Methods

| Method | Description |
|--------|-------------|
| `OnOpened` | Subscribe to PropertyChanged, call InitializeAsync |
| `OnClosed` | Unsubscribe, dispose ViewModel |
| `OnViewModelPropertyChanged` | Close when ShouldClose becomes true |
| `Dispose` | Clean up event subscriptions |

### 5. EnumBoolConverterTests.cs

**Path:** `tests/AIntern.Desktop.Tests/Converters/EnumBoolConverterTests.cs`
**Lines:** ~250

Unit tests for EnumBoolConverter.

#### Test Categories

| Category | Test Count | Description |
|----------|------------|-------------|
| Instance | 2 | Singleton pattern verification |
| Convert | 6 | Match/no-match/null/case-insensitive |
| ConvertBack | 6 | Checked/unchecked/null/non-boolean |
| **Total** | **14** | |

### 6. ExportViewModelTests.cs

**Path:** `tests/AIntern.Desktop.Tests/ViewModels/ExportViewModelTests.cs`
**Lines:** ~550

Unit tests for ExportViewModel.

#### Test Categories

| Category | Test Count | Description |
|----------|------------|-------------|
| Constructor | 4 | Null checks, valid initialization |
| Property Defaults | 8 | Default values for all properties |
| InitializeAsync | 3 | Preview generation |
| Format Changed | 2 | Format change triggers preview |
| Option Changed | 4 | Option changes trigger preview |
| Cancel | 2 | Cancel behavior |
| Export | 8 | Export success/failure/cancel |
| Dispose | 3 | Cleanup verification |
| Error Handling | 3 | Error state management |
| **Total** | **37** | |

## Files Modified

### 1. MainWindowViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/MainWindowViewModel.cs`
**Lines Added:** ~50

Added IExportService dependency and OpenExportCommand:

```csharp
/// <summary>
/// Opens the export dialog (Ctrl+E).
/// </summary>
/// <remarks>
/// <para>
/// Creates a new ExportViewModel and ExportDialog, shows the dialog modally.
/// Requires an active conversation (CanExecute bound to HasActiveConversation).
/// </para>
/// <para>Added in v0.2.5f.</para>
/// </remarks>
[RelayCommand(CanExecute = nameof(HasActiveConversation))]
private async Task OpenExportAsync()
{
    var conversationId = ConversationListViewModel.SelectedConversation?.Id;
    if (conversationId is null)
    {
        return;
    }

    var exportViewModel = new ExportViewModel(
        _exportService,
        _mainWindow.StorageProvider,
        conversationId.Value,
        _loggerFactory.CreateLogger<ExportViewModel>());

    var exportDialog = new ExportDialog { DataContext = exportViewModel };
    await exportDialog.ShowDialog(_mainWindow);

    exportViewModel.Dispose();
}

/// <summary>
/// Gets whether there is an active conversation selected.
/// </summary>
private bool HasActiveConversation =>
    ConversationListViewModel.SelectedConversation is not null;
```

### 2. MainWindow.axaml

**Path:** `src/AIntern.Desktop/Views/MainWindow.axaml`
**Lines Added:** ~3

Added Ctrl+E keybinding:

```xml
<Window.KeyBindings>
    <!-- Existing bindings... -->
    <!-- Ctrl+E: Open export dialog (v0.2.5f) -->
    <KeyBinding Gesture="Ctrl+E" Command="{Binding OpenExportCommand}" />
</Window.KeyBindings>
```

### 3. ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`
**Lines Added:** ~3

Updated documentation to note ExportViewModel is created manually (not via DI) because it requires runtime parameters (conversationId):

```csharp
/// <item><see cref="ExportViewModel"/> - Created manually (requires runtime conversationId, v0.2.5f)</item>
```

### 4. CHANGELOG.md

**Path:** `CHANGELOG.md`
**Lines Added:** ~25

Added v0.2.5f entry at top.

## Logging Specifications

All methods use exhaustive logging with Stopwatch timing:

| Marker | Level | Usage |
|--------|-------|-------|
| `[INIT]` | Debug | Constructor |
| `[ENTER]` | Debug | Method entry with parameters |
| `[INFO]` | Debug | Significant state/action |
| `[SKIP]` | Debug | No-op conditions (e.g., cancelled) |
| `[EXIT]` | Debug/Info | Method completion with duration |
| `[ERROR]` | Error | Exception handling |
| `[WARN]` | Warning | Export failures |

### Example Log Output

```
[DEBUG] [INIT] ExportViewModel created - ConversationId: abc123
[DEBUG] [ENTER] InitializeAsync
[DEBUG] [EXIT] InitializeAsync in 15ms
[DEBUG] [INFO] SelectedFormat changed to: Json
[DEBUG] [ENTER] UpdatePreviewAsync
[DEBUG] [EXIT] UpdatePreviewAsync in 8ms
[DEBUG] [ENTER] ExportAsync
[DEBUG] [INFO] Export options: Format=Json, Timestamps=true, ...
[INFO] [INFO] Exported to conversation.json in 25ms
[DEBUG] [EXIT] ExportAsync in 30ms
[DEBUG] [INFO] ExportViewModel disposing
[DEBUG] [INFO] ExportViewModel disposed
```

## Usage Examples

### Opening Export via Keyboard

Press `Ctrl+E` with a conversation selected to open the export dialog.

### Exporting a Conversation

1. Select a conversation in the sidebar
2. Press `Ctrl+E` to open export dialog
3. Choose format (Markdown, JSON, etc.)
4. Toggle options as needed
5. Review the preview
6. Click "Export" button
7. Choose save location in file picker
8. File is written and dialog closes

### Programmatic Usage

```csharp
// Create and show export dialog
var exportViewModel = new ExportViewModel(
    exportService,
    storageProvider,
    conversationId,
    logger);

var dialog = new ExportDialog { DataContext = exportViewModel };
await dialog.ShowDialog(parentWindow);

exportViewModel.Dispose();
```

### Using EnumBoolConverter

```csharp
// In ViewModel
[ObservableProperty]
private ExportFormat _selectedFormat = ExportFormat.Markdown;

// In XAML
<Window.Resources>
    <converters:EnumBoolConverter x:Key="EnumBoolConverter" />
</Window.Resources>

<RadioButton Content="Markdown"
             IsChecked="{Binding SelectedFormat,
                        Converter={StaticResource EnumBoolConverter},
                        ConverterParameter=Markdown}" />
<RadioButton Content="JSON"
             IsChecked="{Binding SelectedFormat,
                        Converter={StaticResource EnumBoolConverter},
                        ConverterParameter=Json}" />
```

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| **RadioButtons for format** | Mutually exclusive selection, standard UX |
| **CheckBoxes for options** | Independent boolean toggles |
| **Live preview** | Immediate feedback on option changes |
| **500 char preview limit** | Avoids overwhelming the dialog |
| **EnumBoolConverter** | Clean MVVM binding without code-behind |
| **CanExecute check** | Prevents export without conversation |
| **Manual ViewModel creation** | Required for runtime conversationId parameter |
| **IDisposable pattern** | Ensures CancellationTokenSource cleanup |
| **Preview cancellation** | Prevents stale previews from overwriting |
| **Fixed dialog size** | Consistent layout across platforms |

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | Ctrl+E opens ExportDialog when conversation active | ✅ |
| AC-2 | Ctrl+E does nothing when no conversation | ✅ |
| AC-3 | Format radio buttons switch export format | ✅ |
| AC-4 | Option checkboxes affect export output | ✅ |
| AC-5 | Preview updates when format changes | ✅ |
| AC-6 | Preview updates when options change | ✅ |
| AC-7 | Preview shows monospace font | ✅ |
| AC-8 | Export button opens save file dialog | ✅ |
| AC-9 | File saved with correct extension | ✅ |
| AC-10 | Cancel button closes dialog | ✅ |
| AC-11 | Escape key closes dialog | ✅ |
| AC-12 | Error message displays on failure | ✅ |
| AC-13 | Comprehensive XML documentation | ✅ |
| AC-14 | Exhaustive logging with timing | ✅ |
| AC-15 | 51 unit tests (14 converter + 37 ViewModel) | ✅ |
| AC-16 | Build passes with 0 errors, 0 warnings | ✅ |

## Dependencies

### Required (Already Implemented)

| Component | Version | Purpose |
|-----------|---------|---------|
| IExportService | v0.2.5c | Export content generation |
| ExportOptions | v0.2.5c | Export configuration |
| ExportFormat | v0.2.5c | Format enum |
| ExportResult | v0.2.5c | Export result with content |
| ViewModelBase | v0.2.0 | Base class with IsBusy, ErrorMessage |
| IStorageProvider | Avalonia | Native file dialogs |

### Downstream (Future)

| Component | Version | Description |
|-----------|---------|-------------|
| Export templates | Future | Custom export templates |
| Batch export | Future | Export multiple conversations |

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Desktop/Converters/EnumBoolConverter.cs` | Create | ~160 |
| `src/AIntern.Desktop/ViewModels/ExportViewModel.cs` | Create | ~500 |
| `src/AIntern.Desktop/Views/ExportDialog.axaml` | Create | ~190 |
| `src/AIntern.Desktop/Views/ExportDialog.axaml.cs` | Create | ~150 |
| `tests/AIntern.Desktop.Tests/Converters/EnumBoolConverterTests.cs` | Create | ~250 |
| `tests/AIntern.Desktop.Tests/ViewModels/ExportViewModelTests.cs` | Create | ~550 |
| `docs/changelog/v0.2.5f.md` | Create | ~450 |
| `src/AIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Modify | +50 |
| `src/AIntern.Desktop/Views/MainWindow.axaml` | Modify | +3 |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Modify | +3 |
| `CHANGELOG.md` | Modify | +25 |
| **Total** | | **~2,331** |

## Next Steps

| Version | Description |
|---------|-------------|
| v0.2.6 | Additional features TBD |
