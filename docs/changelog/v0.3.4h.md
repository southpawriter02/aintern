# v0.3.4h: Message History Integration

**Date:** 2026-01-15

## Summary

Integrates attached contexts into the message history system for persistence and display in historical messages.

## Changes

### [ChatMessage.cs](file:///Users/turtle1/Documents/GitHub/aintern/src/AIntern.Core/Models/ChatMessage.cs)
- Added `AttachedContexts: IReadOnlyList<FileContext>` property
- Added `HasAttachedContexts` computed property

### [ChatMessageViewModel.cs](file:///Users/turtle1/Documents/GitHub/aintern/src/AIntern.Desktop/ViewModels/ChatMessageViewModel.cs)
- Added `AttachedContexts`, `IsContextExpanded` observable properties
- Added `HasAttachedContexts`, `AttachedContextCount`, `TotalAttachedTokens` computed properties
- Added `ToggleContextExpandedCommand`
- Updated constructor to populate contexts from ChatMessage
- Updated `ToChatMessage()` to include contexts

### [MessageEntity.cs](file:///Users/turtle1/Documents/GitHub/aintern/src/AIntern.Core/Entities/MessageEntity.cs)
- Added `AttachedContextsJson` property for JSON serialization

### [DatabaseConversationService.cs](file:///Users/turtle1/Documents/GitHub/aintern/src/AIntern.Services/DatabaseConversationService.cs)
- Updated `MapMessageToDomain()` to deserialize contexts from JSON
- Updated `MapMessageToEntity()` to serialize contexts to JSON

## Unit Tests

- [ChatMessageAttachmentTests.cs](file:///Users/turtle1/Documents/GitHub/aintern/tests/AIntern.Desktop.Tests/ViewModels/ChatMessageAttachmentTests.cs): 7 tests

## Test Results
- Build: âœ… Succeeded
