# v0.5.1d: Terminal Service

**Released:** 2026-01-17  
**Status:** _IMPLEMENTED_

## Overview

This release implements the Terminal Service (`TerminalService`) for the integrated terminal subsystem. The service manages terminal sessions, handles PTY operations using Pty.Net, and coordinates I/O between the UI and shell processes.

## New Components

### IShellDetectionService (`AIntern.Core.Interfaces.IShellDetectionService`)

Interface for detecting and enumerating available shells on the system.

**Methods:**
| Method | Description |
|--------|-------------|
| `DetectDefaultShellAsync()` | Detects the user's default shell |
| `GetAvailableShellsAsync()` | Enumerates all available shells |

**Types:**
- `ShellInfo` - Record containing shell path, type, name, and default arguments
- `ShellType` - Enumeration of known shell types (Bash, Zsh, Fish, PowerShell, Cmd, etc.)

### ITerminalService (`AIntern.Core.Interfaces.ITerminalService`)

Interface for managing terminal sessions.

**Properties:**
| Property | Type | Description |
|----------|------|-------------|
| `Sessions` | `IReadOnlyList<TerminalSession>` | List of active sessions |
| `ActiveSession` | `TerminalSession?` | Currently active session |

**Methods:**
| Method | Description |
|--------|-------------|
| `CreateSessionAsync()` | Creates a new terminal session |
| `CloseSessionAsync()` | Closes an existing session |
| `SetActiveSession()` | Sets the active session |
| `WriteInputAsync()` | Writes input to a session |
| `ResizeAsync()` | Resizes terminal dimensions |
| `SendSignalAsync()` | Sends a signal (SIGINT, etc.) |
| `GetBuffer()` | Gets the buffer for a session |
| `ChangeDirectoryAsync()` | Changes working directory |
| `ExecuteCommandAsync()` | Executes a command |

**Events:**
| Event | Description |
|-------|-------------|
| `OutputReceived` | Raised when output is received |
| `SessionCreated` | Raised when a session is created |
| `SessionClosed` | Raised when a session is closed |
| `SessionStateChanged` | Raised when session state changes |
| `TitleChanged` | Raised when terminal title changes |
| `BellTriggered` | Raised when bell is triggered |

**Types:**
- `TerminalSessionOptions` - Options for session creation (columns, rows, shell path, etc.)
- `TerminalSignal` - Enumeration of signals (Interrupt, Terminate, Kill, etc.)
- Event argument classes for all events

### TerminalService (`AIntern.Services.Terminal.TerminalService`)

PTY-based implementation of `ITerminalService`.

**Features:**
- **Cross-Platform PTY**: Uses Pty.Net for Windows (ConPTY/WinPTY) and macOS/Linux (native PTY)
- **Session Lifecycle**: Creation, state management, and graceful termination
- **Event-Driven I/O**: Receives data via `PtyData` event, processes through `AnsiParser`
- **Thread Safety**: `ConcurrentDictionary` for sessions, `SemaphoreSlim` for creation
- **Signal Support**: Ctrl+C, Ctrl+D, Ctrl+Z, and process termination
- **Async Disposal**: Implements `IAsyncDisposable` for proper cleanup

### DefaultShellDetectionService (`AIntern.Services.Terminal.DefaultShellDetectionService`)

Default implementation of `IShellDetectionService`.

**Supported Shells:**
| Platform | Shells |
|----------|--------|
| Windows | PowerShell 7, Windows PowerShell, cmd, Git Bash |
| macOS/Linux | bash, zsh, fish, sh |

**Detection Methods:**
- Windows: Registry, `COMSPEC` environment variable
- macOS/Linux: `SHELL` environment variable, `/etc/passwd`

## Architecture

```
┌──────────────────────────────────────────────────────────────┐
│                      TerminalService                          │
├──────────────────────────────────────────────────────────────┤
│  Sessions: ConcurrentDictionary<Guid, SessionContext>         │
├──────────────────────────────────────────────────────────────┤
│               TerminalSessionContext                          │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│  │   Session   │     PTY     │   Buffer    │   Parser    │   │
│  └─────────────┴─────────────┴─────────────┴─────────────┘   │
├──────────────────────────────────────────────────────────────┤
│                         Pty.Net                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  PtyData Event  │  PtyDisconnected Event  │  WriteAsync │ │
│  └─────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

## Unit Tests

- **TerminalServiceTests**: 19 tests covering:
  - Constructor validation
  - Initial state (empty sessions, null active session)
  - Non-existent session handling
  - Disposal behavior (ObjectDisposedException after disposal)
  - Multiple disposal safety

- **DefaultShellDetectionServiceTests**: 9 tests covering:
  - Constructor validation
  - Default shell detection (valid info, path exists)
  - Available shells enumeration (at least one, paths exist, valid types)
  - Default shell in available shells list

## Files Changed

### New Files
- `src/AIntern.Core/Interfaces/IShellDetectionService.cs`
- `src/AIntern.Core/Interfaces/ITerminalService.cs`
- `src/AIntern.Services/Terminal/TerminalService.cs`
- `src/AIntern.Services/Terminal/DefaultShellDetectionService.cs`
- `tests/AIntern.Services.Tests/Terminal/TerminalServiceTests.cs`
- `tests/AIntern.Services.Tests/Terminal/DefaultShellDetectionServiceTests.cs`

## Dependencies

- **Pty.Net (0.1.16-pre)**: Cross-platform pseudo-terminal library
- **Microsoft.Extensions.Logging**: Structured logging
- **AIntern.Core.Terminal.AnsiParser**: ANSI sequence parsing
- **AIntern.Core.Models.Terminal**: Terminal models (Session, Buffer, etc.)

## API Notes

The Pty.Net 0.1.16-pre package uses an event-based API:
- `PtyData` event for receiving output (instead of `ReaderStream`)
- `PtyDisconnected` event for process exit
- `WriteAsync(string)` for writing input (instead of `WriterStream`)
- `PtyProvider.Spawn()` for creating connections (not `SpawnAsync`)

This differs from the GitHub repository version and was discovered during implementation.
