# v0.3.3f: Find & Replace

**Released:** 2026-01-14

## Summary

This version implements the `EditorSearchManager` static utility class, which integrates
AvaloniaEdit's built-in `SearchPanel` for find and replace functionality. It provides
a centralized API for managing search panels across editors with selection-based
search initialization and keyboard navigation.

## New Files

| File | Description |
|------|-------------|
| `EditorSearchManager.cs` | Static manager for search panels |
| `EditorSearchManagerTests.cs` | Unit tests for the manager |

## Modified Files

| File | Changes |
|------|---------|
| `EditorPanel.axaml.cs` | Uses EditorSearchManager, added F3/Shift+F3/Escape handling |

---

## Implementation Details

### EditorSearchManager.cs

A static utility class that manages `SearchPanel` instances for `TextEditor` controls:

```csharp
public static class EditorSearchManager
{
    // Tracks panels by editor instance
    private static readonly Dictionary<TextEditor, SearchPanel> _searchPanels = new();

    // Core operations
    public static SearchPanel OpenFind(TextEditor editor);      // Open in find mode
    public static SearchPanel OpenReplace(TextEditor editor);   // Open in replace mode
    public static void FindNext(TextEditor editor);             // Navigate forward
    public static void FindPrevious(TextEditor editor);         // Navigate backward
    public static void Close(TextEditor editor);                // Close panel

    // State queries
    public static bool IsInstalled(TextEditor editor);          // Panel exists
    public static bool IsOpen(TextEditor editor);               // Panel visible
    public static bool IsReplaceMode(TextEditor editor);        // Replace mode active
    public static string? GetSearchPattern(TextEditor editor);  // Current pattern
    public static void SetSearchPattern(TextEditor editor, string pattern);

    // Lifecycle
    public static void Uninstall(TextEditor editor);            // Remove panel
    public static void ClearAll();                              // Remove all panels
    public static int GetInstalledPanelCount();                 // For diagnostics
}
```

### Selection Auto-Fill

When opening the find panel, if text is selected and is a single line, it automatically
becomes the search pattern:

```csharp
if (!editor.TextArea.Selection.IsEmpty)
{
    var selectedText = editor.TextArea.Selection.GetText();
    if (!string.IsNullOrEmpty(selectedText) && !selectedText.Contains('\n'))
    {
        panel.SearchPattern = selectedText;
    }
}
```

### EditorPanel Updates

Added keyboard shortcuts and integrated EditorSearchManager:

```csharp
// F3 / Shift+F3 for find next/previous
if (e.Key == Key.F3)
{
    if (e.KeyModifiers.HasFlag(KeyModifiers.Shift))
        EditorSearchManager.FindPrevious(Editor);
    else
        EditorSearchManager.FindNext(Editor);
    e.Handled = true;
    return;
}

// Escape to close search panel
if (e.Key == Key.Escape && EditorSearchManager.IsOpen(Editor))
{
    EditorSearchManager.Close(Editor);
    e.Handled = true;
    return;
}
```

---

## Keyboard Shortcuts

| Shortcut | Action | Handler |
|----------|--------|---------|
| Ctrl+F | Open Find | `EditorSearchManager.OpenFind()` |
| Ctrl+H | Open Find & Replace | `EditorSearchManager.OpenReplace()` |
| F3 | Find Next | `EditorSearchManager.FindNext()` |
| Shift+F3 | Find Previous | `EditorSearchManager.FindPrevious()` |
| Escape | Close Search Panel | `EditorSearchManager.Close()` |
| Enter | Find Next (in search box) | Built-in SearchPanel |
| Alt+R | Toggle Replace Mode | Built-in SearchPanel |
| Alt+C | Toggle Match Case | Built-in SearchPanel |
| Alt+W | Toggle Whole Word | Built-in SearchPanel |
| Alt+E | Toggle Regex | Built-in SearchPanel |

---

## SearchPanel Features

The AvaloniaEdit `SearchPanel` provides these built-in capabilities:

| Feature | Description |
|---------|-------------|
| Pattern Matching | Search for text or regex patterns |
| Highlight All | Highlights all matches in document |
| Match Count | Shows "N of M matches" |
| Navigation | Next/Previous buttons and keyboard |
| Replace | Single and Replace All |
| Options Toggle | Case, whole word, regex buttons |
| Wrap Around | Wraps at document boundaries |

---

## Unit Tests

### EditorSearchManagerTests.cs

15 tests covering:

| Category | Tests |
|----------|-------|
| Null argument validation | 11 tests (all public methods) |
| SetLogger | 1 test |
| GetInstalledPanelCount | 1 test |
| ClearAll | 2 tests |

---

## Logging

The manager supports diagnostic logging via `SetLogger()`:

```csharp
EditorSearchManager.SetLogger(logger);
```

Log messages include:
- `[SEARCH] Opening find panel`
- `[SEARCH] Opening replace panel`
- `[SEARCH] Auto-filled search pattern from selection: '{Pattern}'`
- `[SEARCH] FindNext executed`
- `[SEARCH] FindPrevious executed`
- `[SEARCH] Panel closed`
- `[SEARCH] Panel uninstalled and removed`
- `[SEARCH] SearchPanel installed for editor`

---

## Build Results

- **Errors:** 0
- **Warnings:** 1 (pre-existing)
- **New Tests:** 15

---

## Related Versions

- v0.3.3e: EditorPanel UI (base view)
- v0.3.3d: EditorConfiguration (settings)
- v0.3.3c: SyntaxHighlightingService (highlighting)
- v0.3.3b: EditorPanelViewModel (tab management)
