# v0.4.1g: ViewModel Integration

**Release Date:** January 16, 2026  
**Type:** Feature (Code Block Extraction Suite)  
**Parent:** v0.4.1 Code Block Extraction

---

## Overview

v0.4.1g implements the ViewModel layer for code block display and interaction. This bridges the streaming parser (v0.4.1f) and services with the UI, enabling real-time code block updates during LLM streaming and user actions like copy, apply, and reject.

---

## New Files

### Core Layer
| File | Purpose |
|------|---------|
| `src/AIntern.Core/Interfaces/IClipboardService.cs` | Platform-agnostic clipboard abstraction |

### Desktop Layer
| File | Purpose |
|------|---------|
| `src/AIntern.Desktop/Services/ClipboardService.cs` | Avalonia clipboard implementation |
| `src/AIntern.Desktop/Messages/CodeBlockMessages.cs` | Messenger types for inter-ViewModel communication |
| `src/AIntern.Desktop/ViewModels/CodeBlockViewModel.cs` | ViewModel for individual code blocks |
| `src/AIntern.Desktop/ViewModels/CodeProposalViewModel.cs` | Container ViewModel for block collections |

### Tests
| File | Test Count |
|------|------------|
| `tests/AIntern.Desktop.Tests/ViewModels/CodeBlockViewModelTests.cs` | 31 tests |
| `tests/AIntern.Desktop.Tests/ViewModels/CodeProposalViewModelTests.cs` | 19 tests |

---

## Modified Files

| File | Changes |
|------|---------|
| `src/AIntern.Core/Models/CodeBlockTypes.cs` | Added `Reviewing` and `Applying` to `CodeBlockStatus` enum |
| `src/AIntern.Desktop/ViewModels/ChatMessageViewModel.cs` | Added code block collection, streaming block methods, statistics, and commands |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Registered `IClipboardService` |

---

## Key Features

### 1. CodeBlockViewModel
- **Observable Properties**: Id, Content, Language, TargetFilePath, BlockType, Status, ConfidenceScore, IsStreaming
- **Computed Properties**: IsApplicable, ShowApplyButton, LineCount, FileName, StatusText, StatusIcon
- **Commands**: CopyToClipboard, ShowDiff, ApplyChanges, Reject, SelectPath, ToggleExpanded
- **Streaming Support**: AppendContent, UpdateFromPartial, CompleteStreaming
- **Status Management**: MarkAsApplying, MarkAsApplied, MarkAsError, MarkAsConflict, ResetToPending

### 2. CodeProposalViewModel
- **Aggregate Statistics**: TotalCount, ApplicableCount, AppliedCount, PendingCount, ErrorCount
- **Status Tracking**: IsFullyApplied, IsPartiallyApplied, CanApplyAll, CanRejectAll
- **Commands**: ApplyAll, RejectAll, ShowSummary
- **Auto-Updates**: Collection changes and block status changes trigger stats recalculation

### 3. ChatMessageViewModel Enhancements
- **Code Block Collection**: Observable collection of CodeBlockViewModel
- **Streaming Methods**: BeginCodeBlock, UpdateStreamingBlock, CompleteCurrentBlock
- **Statistics**: TotalBlockCount, ApplicableBlockCount, AppliedBlockCount
- **Commands**: CopyAllCode, ApplyAllCode, RejectAllCode

### 4. Messenger System
```
┌─────────────────────────────────────────────────────────────────┐
│ CopyToClipboardRequestMessage   │ Request to copy text          │
│ ClipboardCopiedMessage          │ Notification of copy          │
│ ShowDiffRequestMessage          │ Request to open diff view     │
│ ApplyChangesRequestMessage      │ Request to apply a block      │
│ ApplyAllChangesRequestMessage   │ Request to apply all blocks   │
│ CodeBlockStatusChangedMessage   │ Block status notification     │
│ SelectFilePathRequestMessage    │ Request path selection dialog │
│ PathInferenceCompletedMessage   │ Path inference result         │
└─────────────────────────────────────────────────────────────────┘
```

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     ChatViewModel                                │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                 ChatMessageViewModel                      │   │
│  │  ┌──────────────────────────────────────────────────┐    │   │
│  │  │           CodeBlockViewModel (1..n)               │    │   │
│  │  │  • Observable properties for UI binding           │    │   │
│  │  │  • Commands for user actions                      │    │   │
│  │  │  • Streaming content updates                      │    │   │
│  │  └──────────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              ↓                                   │
│                 WeakReferenceMessenger                           │
│                              ↓                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Message Handlers (v0.4.2+)                   │   │
│  │  • Clipboard operations                                   │   │
│  │  • Diff view display                                      │   │
│  │  • Apply changes                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## CodeBlockStatus Lifecycle

```
                    ┌──────────────┐
                    │   Pending    │ (Initial)
                    └──────┬───────┘
                           │
           ┌───────────────┴───────────────┐
           ↓                               ↓
   ┌──────────────┐               ┌──────────────┐
   │  Reviewing   │               │  Applying    │
   └──────┬───────┘               └──────┬───────┘
          │                              │
          ↓                    ┌─────────┴─────────┐
   ┌──────────────┐            ↓                   ↓
   │   Rejected   │    ┌──────────────┐   ┌──────────────┐
   └──────────────┘    │   Applied    │   │    Error     │
                       └──────────────┘   └──────────────┘
                                                  │
                                                  ↓
                                          ┌──────────────┐
                                          │   Conflict   │
                                          └──────────────┘
```

---

## Test Coverage

| Test Category | Count | Coverage |
|---------------|-------|----------|
| Computed Properties | 12 | IsApplicable, LineCount, FileName, StatusText, ShowApplyButton, Confidence |
| Commands | 4 | CopyToClipboard, ShowDiff, Reject, ApplyChanges |
| Streaming | 3 | AppendContent, CompleteStreaming, FromPartialBlock |
| Status Updates | 4 | MarkAsApplied, MarkAsError, MarkAsConflict, ResetToPending |
| Model Conversion | 3 | FromModel, ToModel, FromPartialBlock |
| Proposal Statistics | 10 | Counts, IsFullyApplied, AffectedFiles, ProgressText |
| Proposal Commands | 4 | CanApplyAll, CanRejectAll, RejectAll |
| Proposal Conversion | 3 | FromProposal, ToModel |
| **Total** | **50** | |

---

## Dependencies

| Dependency | Usage |
|------------|-------|
| v0.4.1a | `CodeBlock`, `CodeProposal`, `CodeBlockStatus` models |
| v0.4.1b | `ICodeBlockParserService` for non-streaming parsing |
| v0.4.1e | `IFilePathInferenceService` for path inference (future) |
| v0.4.1f | `IStreamingCodeBlockParser`, `PartialCodeBlock` |
| CommunityToolkit.Mvvm | `ObservableObject`, `RelayCommand`, `WeakReferenceMessenger` |

---

## Breaking Changes

None. All additions are new functionality.

---

## Next Steps

- **v0.4.1h**: UI Rendering - Create CodeBlockControl with syntax highlighting, action buttons, and streaming indicators
