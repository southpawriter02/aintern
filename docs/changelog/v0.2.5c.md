# v0.2.5c - Export Service Layer

**Release Date:** 2026-01-14
**Type:** Feature (Service Layer)
**Status:** Complete

## Overview

This release implements the export service layer for conversations, enabling export to multiple formats (Markdown, JSON, PlainText, HTML) with customizable options. The service provides format-specific styling including dark-themed HTML, proper timestamps, system prompt inclusion, and token count tracking.

**Building on:** v0.2.5b (Search Service)
**Design Reference:** [v0.2.5c-export-service.md](../design/v0.2.x/v0.2.5c-export-service.md)

## Architecture

```
+------------------------------------------------------------------+
|                      v0.2.5c Export Service                        |
+------------------------------------------------------------------+
|                                                                    |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      IExportService                          │  |
|  │  ├── ExportAsync(id, options) → ExportResult                 │  |
|  │  ├── GeneratePreviewAsync(id, options, maxLen) → string      │  |
|  │  ├── GetFileExtension(format) → string                       │  |
|  │  └── GetMimeType(format) → string                            │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                              │                                     |
|                              ▼                                     |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      ExportService                           │  |
|  │  Dependencies:                                               │  |
|  │  ├── IConversationRepository (load conversations)            │  |
|  │  └── ILogger<ExportService>                                  │  |
|  │                                                              │  |
|  │  Format Exporters:                                           │  |
|  │  ├── ExportToMarkdown() → headers, bold roles, separators    │  |
|  │  ├── ExportToJson() → structured JSON with messages array    │  |
|  │  ├── ExportToPlainText() → title with underline, timestamps  │  |
|  │  └── ExportToHtml() → dark theme, responsive, embedded CSS   │  |
|  │                                                              │  |
|  │  Utilities:                                                  │  |
|  │  └── SanitizeFileName() → safe cross-platform filenames      │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                              │                                     |
|                              ▼                                     |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │               IConversationRepository                        │  |
|  │  └── GetByIdWithMessagesAsync() - Load conversation data     │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                                                                    |
+------------------------------------------------------------------+
```

## Key Features

### 1. Multiple Export Formats

The service supports four export formats:

| Format | Extension | MIME Type | Description |
|--------|-----------|-----------|-------------|
| Markdown | `.md` | `text/markdown` | Headers, bold roles, horizontal separators |
| JSON | `.json` | `application/json` | Structured data with messages array |
| PlainText | `.txt` | `text/plain` | Title with underline, `[HH:mm]` timestamps |
| HTML | `.html` | `text/html` | Dark theme, responsive, embedded CSS |

### 2. Export Options

Configurable options for export behavior:

| Option | Default | Description |
|--------|---------|-------------|
| `Format` | Markdown | Output format selection |
| `IncludeTimestamps` | true | Add message timestamps |
| `IncludeSystemPrompt` | true | Include system prompt section |
| `IncludeTokenCounts` | false | Show per-message token counts |
| `IncludeMetadata` | true | Include created/updated dates |

### 3. Preview Generation

The `GeneratePreviewAsync` method provides truncated previews for UI display:
- Truncates content at specified `maxLength` (default: 500)
- Appends "... (truncated)" to indicate truncation
- Returns full content if shorter than `maxLength`
- Passes through error messages on failure

### 4. Filename Sanitization

The `SanitizeFileName` utility ensures safe filenames:
- Replaces non-alphanumeric characters with hyphens
- Collapses multiple consecutive hyphens
- Converts to lowercase
- Trims leading/trailing hyphens
- Defaults to "conversation" if empty
- Uses `[GeneratedRegex]` for performance

## Files Created

### 1. ExportFormat.cs

**Path:** `src/AIntern.Core/Enums/ExportFormat.cs`
**Lines:** ~50

Enum defining export file formats.

```csharp
public enum ExportFormat
{
    Markdown,
    Json,
    PlainText,
    Html
}
```

### 2. ExportOptions.cs

**Path:** `src/AIntern.Core/Models/ExportOptions.cs`
**Lines:** ~145

Configuration model with static factories.

#### Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `Format` | `ExportFormat` | `Markdown` | Output format |
| `IncludeTimestamps` | `bool` | `true` | Include message times |
| `IncludeSystemPrompt` | `bool` | `true` | Include system prompt |
| `IncludeTokenCounts` | `bool` | `false` | Show token counts |
| `IncludeMetadata` | `bool` | `true` | Include dates |
| `LogSummary` | `string` | (computed) | Logging summary |

#### Static Factories

| Factory | Description |
|---------|-------------|
| `Default` | All features enabled except token counts |
| `Minimal` | Content only, no extra information |

### 3. ExportResult.cs

**Path:** `src/AIntern.Core/Models/ExportResult.cs`
**Lines:** ~128

Result container for export operations.

#### Properties

| Property | Type | Description |
|----------|------|-------------|
| `Success` | `required bool` | Whether export succeeded |
| `Content` | `required string` | Exported content |
| `SuggestedFileName` | `required string` | Safe filename with extension |
| `MimeType` | `required string` | Content MIME type |
| `ErrorMessage` | `string?` | Error details if failed |

#### Static Factory

```csharp
public static ExportResult Failed(string error) => new()
{
    Success = false,
    Content = string.Empty,
    SuggestedFileName = string.Empty,
    MimeType = string.Empty,
    ErrorMessage = error
};
```

### 4. IExportService.cs

**Path:** `src/AIntern.Core/Interfaces/IExportService.cs`
**Lines:** ~155

Interface defining the export service contract.

#### Methods

| Method | Return Type | Description |
|--------|-------------|-------------|
| `ExportAsync` | `Task<ExportResult>` | Export conversation to format |
| `GeneratePreviewAsync` | `Task<string>` | Generate truncated preview |
| `GetFileExtension` | `string` | Get extension for format |
| `GetMimeType` | `string` | Get MIME type for format |

### 5. ExportService.cs

**Path:** `src/AIntern.Services/ExportService.cs`
**Lines:** ~544

Full implementation with four format exporters.

#### Dependencies

| Dependency | Purpose |
|------------|---------|
| `IConversationRepository` | Load conversations with messages |
| `ILogger<ExportService>` | Diagnostic logging |

#### Format Exporters

##### ExportToMarkdown

```markdown
# Conversation Title

**Created:** 2026-01-14 10:30
**Last Updated:** 2026-01-14 11:45

## System Prompt

You are a helpful assistant.

## Conversation

**User** (10:30):

Hello, how are you?

---

**Assistant** (10:31):

I'm doing well, thank you!

---

*Exported from AIntern*
```

##### ExportToJson

```json
{
  "title": "Conversation Title",
  "createdAt": "2026-01-14T10:30:00Z",
  "updatedAt": "2026-01-14T11:45:00Z",
  "systemPrompt": "You are a helpful assistant.",
  "messages": [
    {
      "role": "user",
      "content": "Hello, how are you?",
      "timestamp": "2026-01-14T10:30:00Z",
      "tokenCount": 5
    },
    {
      "role": "assistant",
      "content": "I'm doing well, thank you!",
      "timestamp": "2026-01-14T10:31:00Z",
      "tokenCount": 8
    }
  ],
  "exportedAt": "2026-01-14T12:00:00Z",
  "exportedBy": "AIntern"
}
```

##### ExportToPlainText

```
Conversation Title
==================

Created: 2026-01-14 10:30
Updated: 2026-01-14 11:45

System Prompt:
You are a helpful assistant.

[10:30] USER:
Hello, how are you?

[10:31] ASSISTANT:
I'm doing well, thank you!

Exported from AIntern
```

##### ExportToHtml

The HTML export includes:
- Dark theme color scheme (`#1a1a2e` background)
- Responsive layout with max-width container
- Color-coded message blocks by role:
  - User: Cyan (`#00d9ff`) accent
  - Assistant: Purple (`#7b68ee`) accent
  - System: Gold (`#ffd700`) accent
- System prompt in separate styled box
- Timestamp spans with muted color
- Footer with export attribution

### 6. ExportServiceTests.cs

**Path:** `tests/AIntern.Services.Tests/ExportServiceTests.cs`
**Lines:** ~580

Comprehensive unit tests using Moq.

#### Test Categories

| Category | Test Count | Description |
|----------|------------|-------------|
| Constructor | 2 | Null checks for dependencies |
| ExportAsync_Markdown | 7 | Title, timestamps, metadata, system prompt, tokens |
| ExportAsync_Json | 2 | Valid JSON, structure |
| ExportAsync_PlainText | 2 | Format, timestamps |
| ExportAsync_Html | 3 | Structure, CSS, encoding |
| ExportAsync_NotFound | 1 | Returns error result |
| GeneratePreviewAsync | 3 | Truncation, full content, error passthrough |
| GetFileExtension | 4 | Each format (Theory) |
| GetMimeType | 4 | Each format (Theory) |
| SanitizeFileName | 5 | Special chars, empty, spaces, unicode |
| Cancellation | 1 | Token cancellation |
| **Total** | **34** | |

#### Key Test Scenarios

```csharp
// Constructor
[Fact] Constructor_NullRepository_ThrowsArgumentNullException()
[Fact] Constructor_NullLogger_ThrowsArgumentNullException()

// Markdown export
[Fact] ExportAsync_Markdown_IncludesTitle()
[Fact] ExportAsync_Markdown_WithTimestamps_IncludesTimestamps()
[Fact] ExportAsync_Markdown_WithoutTimestamps_OmitsTimestamps()
[Fact] ExportAsync_Markdown_WithMetadata_IncludesCreatedDate()
[Fact] ExportAsync_Markdown_WithSystemPrompt_IncludesSystemPrompt()
[Fact] ExportAsync_Markdown_WithTokenCounts_IncludesTokens()

// JSON export
[Fact] ExportAsync_Json_IsValidJson()
[Fact] ExportAsync_Json_ContainsExpectedStructure()

// PlainText export
[Fact] ExportAsync_PlainText_HasTitleUnderline()
[Fact] ExportAsync_PlainText_WithTimestamps_HasBracketFormat()

// HTML export
[Fact] ExportAsync_Html_ContainsDoctype()
[Fact] ExportAsync_Html_ContainsEmbeddedCss()
[Fact] ExportAsync_Html_EscapesHtmlEntities()

// Error handling
[Fact] ExportAsync_NotFound_ReturnsErrorResult()

// Preview
[Fact] GeneratePreviewAsync_LongContent_TruncatesAtMaxLength()
[Fact] GeneratePreviewAsync_ShortContent_ReturnsFullContent()
[Fact] GeneratePreviewAsync_Error_ReturnsErrorMessage()

// Utilities
[Theory]
[InlineData(ExportFormat.Markdown, ".md")]
[InlineData(ExportFormat.Json, ".json")]
[InlineData(ExportFormat.PlainText, ".txt")]
[InlineData(ExportFormat.Html, ".html")]
public void GetFileExtension_ReturnsCorrectExtension(ExportFormat format, string expected)

[Theory]
[InlineData("Hello World", "hello-world")]
[InlineData("Test @#$% Name", "test-name")]
[InlineData("", "conversation")]
[InlineData("Multiple   Spaces", "multiple-spaces")]
public void SanitizeFileName_HandlesInput(string input, string expected)

// Cancellation
[Fact] ExportAsync_Cancelled_ThrowsOperationCanceledException()
```

## Files Modified

### 1. ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`
**Lines Added:** +15

Added IExportService registration in the CORE SERVICES section after ISearchService.

```csharp
// Export: provides conversation export to multiple formats.
// Uses a factory to resolve scoped repository dependency.
// The service supports Markdown, JSON, PlainText, and HTML formats.
// Added in v0.2.5c.
services.AddSingleton<IExportService>(sp =>
{
    // Create a scope to resolve scoped services (repositories).
    var scope = sp.CreateScope();
    return new ExportService(
        scope.ServiceProvider.GetRequiredService<IConversationRepository>(),
        sp.GetRequiredService<ILogger<ExportService>>());
});
```

### 2. CHANGELOG.md

**Path:** `CHANGELOG.md`
**Lines Added:** +25

Added v0.2.5c entry at top of changelog.

## Logging Specifications

All methods use exhaustive logging with Stopwatch timing:

| Marker | Level | Usage |
|--------|-------|-------|
| `[INIT]` | Debug | Constructor |
| `[ENTER]` | Debug | Method entry with parameters |
| `[SKIP]` | Debug | No-op conditions (not found) |
| `[EXIT]` | Debug/Info | Method completion with duration |
| `[ERROR]` | Error | Exception handling |

### Example Log Output

```
[DEBUG] [INIT] ExportService created
[DEBUG] [ENTER] ExportAsync - ConversationId: {guid}, Format=Markdown, Timestamps=True, SystemPrompt=True, TokenCounts=False, Metadata=True
[INFO] [EXIT] ExportAsync - Exported to Markdown (2450 bytes) in 3.45ms
[DEBUG] [ENTER] GeneratePreviewAsync - ConversationId: {guid}, MaxLength: 500
[DEBUG] [EXIT] GeneratePreviewAsync - Truncated to 500 of 2450 chars in 4.12ms
```

## Usage Examples

### Basic Export

```csharp
var exportService = serviceProvider.GetRequiredService<IExportService>();

// Export to Markdown with default options
var result = await exportService.ExportAsync(conversationId, ExportOptions.Default);

if (result.Success)
{
    await File.WriteAllTextAsync(result.SuggestedFileName, result.Content);
}
```

### Custom Options

```csharp
var options = new ExportOptions
{
    Format = ExportFormat.Html,
    IncludeTimestamps = true,
    IncludeSystemPrompt = true,
    IncludeTokenCounts = true,
    IncludeMetadata = true
};

var result = await exportService.ExportAsync(conversationId, options);
```

### Generate Preview

```csharp
// Show preview in UI before saving
var preview = await exportService.GeneratePreviewAsync(
    conversationId,
    options,
    maxLength: 500);

previewTextBox.Text = preview;
```

### Minimal Export

```csharp
// Content only, no extra information
var result = await exportService.ExportAsync(conversationId, ExportOptions.Minimal);
```

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| **Separate ExportFormat enum** | Reusable across models and service |
| **ExportResult.Failed() factory** | Consistent error handling pattern |
| **Embedded CSS in HTML** | Standalone file, no external dependencies |
| **Dark theme HTML** | Matches application aesthetic |
| **Lowercase sanitized filenames** | Cross-platform file system safety |
| **Source-generated regex** | Performance optimization with `[GeneratedRegex]` |
| **Singleton service** | Stateless, can be shared across app lifecycle |
| **Factory pattern for DI** | Resolves scoped repository into singleton service |
| **Static factory for Minimal** | Common use case for simple exports |

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | ExportFormat enum has 4 values | ✅ |
| AC-2 | ExportOptions has all 5 properties with defaults | ✅ |
| AC-3 | ExportResult has required properties and Failed factory | ✅ |
| AC-4 | IExportService interface defined with 4 methods | ✅ |
| AC-5 | Markdown export includes title, messages, separators | ✅ |
| AC-6 | JSON export is valid JSON with messages array | ✅ |
| AC-7 | PlainText export has title underline and [HH:mm] format | ✅ |
| AC-8 | HTML export has embedded dark-theme CSS | ✅ |
| AC-9 | IncludeTimestamps option affects output | ✅ |
| AC-10 | IncludeSystemPrompt option affects output | ✅ |
| AC-11 | IncludeMetadata option affects output | ✅ |
| AC-12 | SuggestedFileName is safe for file system | ✅ |
| AC-13 | GeneratePreviewAsync truncates at maxLength | ✅ |
| AC-14 | Missing conversation returns error result | ✅ |
| AC-15 | ExportService registered in DI container | ✅ |
| AC-16 | Comprehensive XML documentation | ✅ |
| AC-17 | Exhaustive logging with timing | ✅ |
| AC-18 | 28+ unit tests | ✅ (34) |
| AC-19 | Build passes with 0 errors, 0 warnings | ⏳ |

## Dependencies

### Required (Already Implemented)

| Component | Version | Purpose |
|-----------|---------|---------|
| IConversationRepository | v0.2.1d | Load conversations |
| ConversationEntity | v0.2.1b | Conversation data |
| MessageEntity | v0.2.1b | Message data |
| SystemPromptEntity | v0.2.1b | System prompt data |
| MessageRole | v0.1.0 | Message role enum |

### Downstream (Future)

| Component | Version | Description |
|-----------|---------|-------------|
| Export UI components | v0.2.5d+ | Export dialog and button |
| Export button in header | v0.2.5d+ | Conversation header integration |

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Core/Enums/ExportFormat.cs` | Create | ~50 |
| `src/AIntern.Core/Models/ExportOptions.cs` | Create | ~145 |
| `src/AIntern.Core/Models/ExportResult.cs` | Create | ~128 |
| `src/AIntern.Core/Interfaces/IExportService.cs` | Create | ~155 |
| `src/AIntern.Services/ExportService.cs` | Create | ~544 |
| `tests/AIntern.Services.Tests/ExportServiceTests.cs` | Create | ~580 |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Modify | +15 |
| `CHANGELOG.md` | Modify | +25 |
| **Total** | | **~1,642** |

## Next Steps

| Version | Description |
|---------|-------------|
| v0.2.5d | Export UI components and integration |
| v0.2.5e | Search UI components |
| v0.2.6 | Additional features TBD |
