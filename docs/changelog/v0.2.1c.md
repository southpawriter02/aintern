# Changelog v0.2.1c

**Release Date:** 2026-01-12

DbContext and Entity Framework Core configurations - establishing the complete database schema mapping for conversations, messages, system prompts, and inference presets.

---

## Highlights

- AInternDbContext with four DbSet properties and automatic timestamp management
- Four entity configuration classes using Fluent API
- 19 database indexes for optimized query performance
- Unique constraints on Name columns and composite sequence numbers
- Cascade delete for messages, SetNull for system prompt references
- 22 unit tests with SQLite in-memory database
- Comprehensive logging at Debug, Information, Warning, and Error levels

---

## AInternDbContext

**Location:** `src/AIntern.Data/AInternDbContext.cs`

### Features

| Feature | Description |
|---------|-------------|
| Expression-bodied DbSets | `Conversations => Set<ConversationEntity>()` |
| Dual constructors | Options-based (DI) and parameterless (design-time) |
| Auto-discovery | `ApplyConfigurationsFromAssembly` for configurations |
| Timestamp automation | SaveChanges overrides manage CreatedAt/UpdatedAt |
| ILogger integration | Comprehensive logging via Microsoft.Extensions.Logging |

### DbSet Properties

```csharp
public DbSet<ConversationEntity> Conversations => Set<ConversationEntity>();
public DbSet<MessageEntity> Messages => Set<MessageEntity>();
public DbSet<SystemPromptEntity> SystemPrompts => Set<SystemPromptEntity>();
public DbSet<InferencePresetEntity> InferencePresets => Set<InferencePresetEntity>();
```

### Automatic Timestamps

- **On Add**: Sets `CreatedAt` and `UpdatedAt` to `DateTime.UtcNow`
- **On Modify**: Updates `UpdatedAt` to `DateTime.UtcNow`
- Handles `MessageEntity.Timestamp` for messages

---

## Entity Configurations

### ConversationConfiguration

**Location:** `src/AIntern.Data/Configurations/ConversationConfiguration.cs`

**Table:** `Conversations`

| Column | Type | Constraint |
|--------|------|------------|
| Id | BLOB (GUID) | PRIMARY KEY |
| Title | TEXT(200) | NOT NULL, DEFAULT 'New Conversation' |
| ModelPath | TEXT(500) | NULL |
| ModelName | TEXT(100) | NULL |
| SystemPromptId | BLOB | NULL, FK → SystemPrompts |
| CreatedAt | TEXT | NOT NULL |
| UpdatedAt | TEXT | NOT NULL |
| IsArchived | INTEGER | NOT NULL, DEFAULT 0 |
| IsPinned | INTEGER | NOT NULL, DEFAULT 0 |
| MessageCount | INTEGER | NOT NULL, DEFAULT 0 |
| TotalTokenCount | INTEGER | NOT NULL, DEFAULT 0 |

**Indexes (6):**
1. `IX_Conversations_UpdatedAt` (DESC)
2. `IX_Conversations_IsArchived`
3. `IX_Conversations_IsPinned`
4. `IX_Conversations_SystemPromptId`
5. `IX_Conversations_CreatedAt`
6. `IX_Conversations_List` (IsArchived, IsPinned DESC, UpdatedAt DESC)

---

### MessageConfiguration

**Location:** `src/AIntern.Data/Configurations/MessageConfiguration.cs`

**Table:** `Messages`

| Column | Type | Constraint |
|--------|------|------------|
| Id | BLOB (GUID) | PRIMARY KEY |
| ConversationId | BLOB | NOT NULL, FK → Conversations (CASCADE) |
| Role | INTEGER | NOT NULL (0=System, 1=User, 2=Assistant) |
| Content | TEXT | NOT NULL |
| SequenceNumber | INTEGER | NOT NULL |
| Timestamp | TEXT | NOT NULL |
| EditedAt | TEXT | NULL |
| TokenCount | INTEGER | NULL |
| GenerationTimeMs | INTEGER | NULL |
| TokensPerSecond | REAL | NULL |
| IsEdited | INTEGER | NOT NULL, DEFAULT 0 |
| IsComplete | INTEGER | NOT NULL, DEFAULT 1 |

**Indexes (4):**
1. `IX_Messages_ConversationId`
2. `IX_Messages_Timestamp`
3. `IX_Messages_Role`
4. `IX_Messages_ConversationId_SequenceNumber` (**UNIQUE**)

---

### SystemPromptConfiguration

**Location:** `src/AIntern.Data/Configurations/SystemPromptConfiguration.cs`

**Table:** `SystemPrompts`

| Column | Type | Constraint |
|--------|------|------------|
| Id | BLOB (GUID) | PRIMARY KEY |
| Name | TEXT(100) | NOT NULL, **UNIQUE** |
| Description | TEXT(500) | NULL |
| Content | TEXT | NOT NULL |
| Category | TEXT(50) | NOT NULL, DEFAULT 'General' |
| CreatedAt | TEXT | NOT NULL |
| UpdatedAt | TEXT | NOT NULL |
| IsDefault | INTEGER | NOT NULL, DEFAULT 0 |
| IsBuiltIn | INTEGER | NOT NULL, DEFAULT 0 |
| IsActive | INTEGER | NOT NULL, DEFAULT 1 |
| UsageCount | INTEGER | NOT NULL, DEFAULT 0 |

**Indexes (6):**
1. `IX_SystemPrompts_Name` (**UNIQUE**)
2. `IX_SystemPrompts_IsDefault`
3. `IX_SystemPrompts_Category`
4. `IX_SystemPrompts_IsActive`
5. `IX_SystemPrompts_UsageCount`
6. `IX_SystemPrompts_ActiveList` (IsActive, Category, UpdatedAt DESC)

---

### InferencePresetConfiguration

**Location:** `src/AIntern.Data/Configurations/InferencePresetConfiguration.cs`

**Table:** `InferencePresets`

| Column | Type | Constraint |
|--------|------|------------|
| Id | BLOB (GUID) | PRIMARY KEY |
| Name | TEXT(100) | NOT NULL, **UNIQUE** |
| Description | TEXT(500) | NULL |
| Temperature | REAL | NOT NULL, DEFAULT 0.7 |
| TopP | REAL | NOT NULL, DEFAULT 0.9 |
| TopK | INTEGER | NOT NULL, DEFAULT 40 |
| RepeatPenalty | REAL | NOT NULL, DEFAULT 1.1 |
| MaxTokens | INTEGER | NOT NULL, DEFAULT 2048 |
| ContextSize | INTEGER | NOT NULL, DEFAULT 4096 |
| IsDefault | INTEGER | NOT NULL, DEFAULT 0 |
| IsBuiltIn | INTEGER | NOT NULL, DEFAULT 0 |
| CreatedAt | TEXT | NOT NULL |
| UpdatedAt | TEXT | NOT NULL |

**Indexes (3):**
1. `IX_InferencePresets_Name` (**UNIQUE**)
2. `IX_InferencePresets_IsDefault`
3. `IX_InferencePresets_List` (IsBuiltIn DESC, UpdatedAt DESC)

---

## Relationship Summary

| Relationship | Delete Behavior | Description |
|--------------|-----------------|-------------|
| SystemPrompt → Conversations | SetNull | Deleting a prompt sets `SystemPromptId` to null |
| Conversation → Messages | Cascade | Deleting a conversation deletes all its messages |

```
SystemPromptEntity (1) ──────┐
                             │ optional FK (SetNull)
                             ▼
ConversationEntity (1) ◄──── SystemPromptId
        │
        │ 1:N (Cascade)
        ▼
MessageEntity (N)


InferencePresetEntity (standalone)
```

---

## Index Summary

| Table | Count | Key Indexes |
|-------|-------|-------------|
| Conversations | 6 | List composite for main query |
| Messages | 4 | Unique (ConversationId, SequenceNumber) |
| SystemPrompts | 6 | Unique Name, ActiveList composite |
| InferencePresets | 3 | Unique Name, List composite |
| **Total** | **19** | |

---

## Unit Tests

**Location:** `tests/AIntern.Data.Tests/AInternDbContextTests.cs`

### Test Summary (22 tests)

| Category | Count | Tests |
|----------|-------|-------|
| Constructor Tests | 2 | WithOptions, Parameterless |
| DbSet Property Tests | 4 | Conversations, Messages, SystemPrompts, InferencePresets |
| Timestamp Tests | 2 | SetsCreatedAtOnAdd, UpdatesUpdatedAtOnModify |
| Relationship Tests | 2 | SetNullOnDelete, CascadeOnDelete |
| Unique Constraint Tests | 3 | MessageSequence, SystemPromptName, InferencePresetName |
| Configuration Default Tests | 8 | RoleStoredAsInteger, DefaultCategory, DefaultTemperature, etc. |
| Model Configuration Tests | 1 | CreatesAllTables |

### Test Infrastructure

- SQLite in-memory database for fast, isolated tests
- `IDisposable` pattern for connection cleanup
- `NullLogger<T>` for silent test execution

---

## Files Changed

### New Files (7)

| Path | Lines | Description |
|------|-------|-------------|
| `src/AIntern.Data/AInternDbContext.cs` | ~280 | Main DbContext class |
| `src/AIntern.Data/Configurations/ConversationConfiguration.cs` | ~215 | Conversation mapping |
| `src/AIntern.Data/Configurations/MessageConfiguration.cs` | ~170 | Message mapping |
| `src/AIntern.Data/Configurations/SystemPromptConfiguration.cs` | ~180 | System prompt mapping |
| `src/AIntern.Data/Configurations/InferencePresetConfiguration.cs` | ~195 | Inference preset mapping |
| `tests/AIntern.Data.Tests/AInternDbContextTests.cs` | ~445 | 22 unit tests |
| `docs/features/dbcontext.md` | ~250 | Feature documentation |

### Directories Created

| Path | Purpose |
|------|---------|
| `src/AIntern.Data/Configurations/` | Entity configuration classes |

---

## Logging Events

| Level | Message | When |
|-------|---------|------|
| Debug | "AInternDbContext instance created with options" | Constructor |
| Debug | "Applying entity configurations from assembly" | OnModelCreating |
| Debug | "Updated timestamps for {n} added and {m} modified entities" | SaveChanges |
| Information | "Entity configurations applied for tables: ..." | OnModelCreating |
| Warning | "AInternDbContext created with parameterless constructor" | Design-time |

---

## Verification

### Build

```bash
dotnet build AIntern.sln
# Build succeeded. 0 Warning(s) 0 Error(s)
```

### Tests

```bash
dotnet test
# Total tests: 91
# Passed: 91
# - AIntern.Core.Tests: 35 passed
# - AIntern.Services.Tests: 1 passed
# - AIntern.Data.Tests: 55 passed (33 existing + 22 new)
```

---

## Metrics

| Metric | Value |
|--------|-------|
| New Source Files | 5 |
| New Test Files | 1 |
| New Tests | 22 |
| Total Tests | 91 |
| Database Indexes | 19 |
| Documentation Files | 2 |

---

## Design Decisions

### 1. Expression-Bodied DbSets

**Decision:** Use `=> Set<T>()` instead of `{ get; set; }`.
**Rationale:** Cleaner syntax, prevents accidental reassignment.

### 2. Dual Constructors

**Decision:** Provide both options-based and parameterless constructors.
**Rationale:** Options-based for DI, parameterless for EF Core design-time tools.

### 3. Configuration Auto-Discovery

**Decision:** Use `ApplyConfigurationsFromAssembly` instead of explicit registration.
**Rationale:** Reduces boilerplate, automatically picks up new configurations.

### 4. Timestamp Automation

**Decision:** Override SaveChanges methods to manage timestamps.
**Rationale:** Consistent timestamp handling without manual updates.

### 5. Separate Configuration Classes

**Decision:** One `IEntityTypeConfiguration<T>` per entity.
**Rationale:** Better organization, single responsibility, easier maintenance.

---

## Next Steps

This release prepares for v0.2.1d which will add:

- Initial EF Core migration (InitialCreate)
- Migration file verification
- SQL script generation
- Database creation validation
