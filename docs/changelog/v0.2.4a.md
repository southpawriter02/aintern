# Changelog: v0.2.4a - Models and Repository

**Release Date:** 2026-01-13
**Previous Version:** v0.2.3e (Settings Panel UI)
**Design Document:** [v0.2.4a-models-repository.md](../design/v0.2.x/v0.2.4a-models-repository.md)

---

## Overview

v0.2.4a implements the complete system prompt infrastructure:

- **SystemPrompt Domain Model**: Full validation, Duplicate(), computed properties, and entity mapping
- **SystemPromptEntity Enhancement**: Added TagsJson column and navigation property
- **SystemPromptConfiguration**: Comprehensive EF Core configuration with 6 indexes
- **ISystemPromptRepository**: Full repository interface with 16 methods
- **SystemPromptRepository**: Complete implementation with soft-delete and built-in protection
- **SystemPromptTemplates**: 8 built-in prompt templates with well-known GUIDs

This completes the foundation for the system prompt management feature, enabling users to select from built-in templates or create custom system prompts for their conversations.

---

## Architecture

```
+----------------------------------------------------------------------+
|                      v0.2.4a Architecture                             |
+----------------------------------------------------------------------+
|                                                                       |
|  DOMAIN MODEL LAYER (AIntern.Core)                                    |
|  =================================                                    |
|                                                                       |
|  Models/SystemPrompt.cs                            (~470 lines)       |
|  +-- Properties (12): Id, Name, Content, Description, Category,       |
|  |   Tags, CreatedAt, UpdatedAt, IsDefault, IsBuiltIn, IsActive,      |
|  |   UsageCount                                                       |
|  +-- Constants: NameMaxLength, DescriptionMaxLength, ContentMaxLength |
|  +-- Computed: CharacterCount, EstimatedTokenCount                    |
|  +-- Methods: Validate(), Duplicate(newName?), FromEntity(), ToEntity |
|                                                                       |
|  ValidationResult.cs                               (enhanced)         |
|  +-- Static: Success, Failure(params), Failure(IReadOnlyList)         |
|  +-- Instance: FirstError, GetAllErrors(separator)                    |
|                                                                       |
|  Entities/SystemPromptEntity.cs                    (enhanced)         |
|  +-- Added: TagsJson (JSON-serialized tags array)                     |
|  +-- Added: Navigation to Conversations                               |
|                                                                       |
|  Templates/SystemPromptTemplates.cs                (~480 lines)       |
|  +-- Well-known GUIDs (8 static readonly Guid fields)                 |
|  +-- GetAllTemplates() -> IReadOnlyList<SystemPromptEntity>           |
|  +-- 8 factory methods: CreateDefaultAssistant(), CreateSeniorIntern, |
|  |   CreateCodeExpert(), CreateTechnicalWriter(), CreateRubberDuck(), |
|  |   CreateSocraticTutor(), CreateCodeReviewer(), CreateDebugger()    |
|                                                                       |
|  DATA LAYER (AIntern.Data)                                            |
|  =========================                                            |
|                                                                       |
|  Configurations/SystemPromptConfiguration.cs       (~250 lines)       |
|  +-- Table: "SystemPrompts" with comment                              |
|  +-- Columns: 11 properties with constraints and defaults             |
|  +-- Indexes: 6 (Name unique, IsDefault, Category, IsActive,          |
|  |   UsageCount, ActiveList composite)                                |
|                                                                       |
|  Repositories/ISystemPromptRepository.cs           (~280 lines)       |
|  +-- Read (9): GetByIdAsync, GetDefaultAsync, GetAllActiveAsync,      |
|  |   GetByCategoryAsync, GetCategoriesAsync, SearchAsync,             |
|  |   NameExistsAsync, GetByNameAsync, GetUserPromptsAsync,            |
|  |   GetBuiltInPromptsAsync                                           |
|  +-- Write (4): CreateAsync, UpdateAsync, DeleteAsync, HardDeleteAsync|
|  +-- Actions (3): SetAsDefaultAsync, IncrementUsageCountAsync,        |
|  |   RestoreAsync                                                     |
|                                                                       |
|  Repositories/SystemPromptRepository.cs            (~350+ lines)      |
|  +-- Full implementation of ISystemPromptRepository                   |
|  +-- Soft-delete via IsActive flag                                    |
|  +-- Built-in protection (prevents hard delete of IsBuiltIn=true)     |
|  +-- Atomic default switching                                         |
|  +-- Comprehensive logging                                            |
|                                                                       |
+----------------------------------------------------------------------+
```

---

## Files Created

### 1. SystemPrompt.cs (Domain Model)

**Path:** `src/AIntern.Core/Models/SystemPrompt.cs`
**Lines:** ~470

#### Purpose

Rich domain model for system prompts with validation, duplication, and entity mapping.

#### Key Features

| Feature | Description |
|---------|-------------|
| **12 Properties** | Id, Name, Content, Description, Category, Tags, timestamps, flags, UsageCount |
| **Constants** | NameMaxLength (100), DescriptionMaxLength (500), ContentMaxLength (50000), CategoryMaxLength (50) |
| **Computed Properties** | CharacterCount, EstimatedTokenCount (~4 chars/token) |
| **Validate()** | Returns ValidationResult with all constraint violations |
| **Duplicate()** | Creates deep copy with new ID, reset flags, and optional new name |
| **FromEntity()** | Static factory method from SystemPromptEntity |
| **ToEntity()** | Instance method to convert to SystemPromptEntity |

#### Validation Rules

```csharp
public ValidationResult Validate()
{
    var errors = new List<string>();

    if (string.IsNullOrWhiteSpace(Name))
        errors.Add("Name is required.");
    else if (Name.Length > NameMaxLength)
        errors.Add($"Name must not exceed {NameMaxLength} characters.");

    if (string.IsNullOrWhiteSpace(Content))
        errors.Add("Content is required.");
    else if (Content.Length > ContentMaxLength)
        errors.Add($"Content must not exceed {ContentMaxLength:N0} characters.");

    if (Description != null && Description.Length > DescriptionMaxLength)
        errors.Add($"Description must not exceed {DescriptionMaxLength} characters.");

    if (string.IsNullOrWhiteSpace(Category))
        errors.Add("Category is required.");
    else if (Category.Length > CategoryMaxLength)
        errors.Add($"Category must not exceed {CategoryMaxLength} characters.");

    return errors.Count == 0
        ? ValidationResult.Success
        : ValidationResult.Failure(errors);
}
```

#### Duplicate Behavior

```csharp
public SystemPrompt Duplicate(string? newName = null)
{
    return new SystemPrompt
    {
        Id = Guid.NewGuid(),                    // New unique ID
        Name = newName ?? $"{Name} (Copy)",     // New name
        Content = Content,                       // Copy content
        Description = Description,
        Category = Category,
        Tags = [.. Tags],                        // Deep copy tags
        CreatedAt = DateTime.UtcNow,            // Reset timestamps
        UpdatedAt = DateTime.UtcNow,
        IsBuiltIn = false,                       // Never built-in
        IsDefault = false,                       // Never default
        IsActive = true,
        UsageCount = 0                           // Reset usage
    };
}
```

---

### 2. SystemPromptTemplates.cs

**Path:** `src/AIntern.Core/Templates/SystemPromptTemplates.cs`
**Lines:** ~480

#### Purpose

Provides 8 built-in system prompt templates seeded during database initialization.

#### Well-Known GUIDs

| Template | GUID |
|----------|------|
| Default Assistant | `00000002-0000-0000-0000-000000000001` |
| The Senior Intern | `00000002-0000-0000-0000-000000000002` |
| Code Expert | `00000002-0000-0000-0000-000000000003` |
| Technical Writer | `00000002-0000-0000-0000-000000000004` |
| Rubber Duck | `00000002-0000-0000-0000-000000000005` |
| Socratic Tutor | `00000002-0000-0000-0000-000000000006` |
| Code Reviewer | `00000002-0000-0000-0000-000000000007` |
| Debugger | `00000002-0000-0000-0000-000000000008` |

#### Template Categories

| Category | Templates |
|----------|-----------|
| **General** | Default Assistant (IsDefault=true), Socratic Tutor |
| **Creative** | The Senior Intern |
| **Code** | Code Expert, Rubber Duck, Code Reviewer, Debugger |
| **Technical** | Technical Writer |

#### Template Content Examples

**Default Assistant:**
```
You are a helpful, harmless, and honest AI assistant. You provide clear,
accurate, and thoughtful responses to help users with their questions
and tasks. When you don't know something, you say so. When asked to do
something harmful or unethical, you politely decline.
```

**The Senior Intern:**
```
You are "The Senior Intern" - an AI assistant with the knowledge of a senior
developer but the enthusiasm of a new hire. You're technically brilliant but
sometimes make sarcastic observations about code quality or architecture
decisions...
```

---

### 3. SystemPromptConfiguration.cs

**Path:** `src/AIntern.Data/Configurations/SystemPromptConfiguration.cs`
**Lines:** ~250

#### Purpose

EF Core configuration defining table schema, column constraints, and indexes.

#### Table Configuration

| Column | Type | Constraints |
|--------|------|-------------|
| Id | GUID | Primary Key |
| Name | string(100) | Required, Unique |
| Content | text | Required |
| Description | string(500) | Optional |
| Category | string(50) | Required, Default="General" |
| TagsJson | string(1000) | Optional, JSON array |
| CreatedAt | datetime | Required |
| UpdatedAt | datetime | Required |
| IsDefault | bool | Required, Default=false |
| IsBuiltIn | bool | Required, Default=false |
| IsActive | bool | Required, Default=true |
| UsageCount | int | Required, Default=0 |

#### Indexes

| Index Name | Columns | Properties |
|------------|---------|------------|
| `IX_SystemPrompts_Name` | Name | Unique |
| `IX_SystemPrompts_IsDefault` | IsDefault | Standard |
| `IX_SystemPrompts_Category` | Category | Standard |
| `IX_SystemPrompts_IsActive` | IsActive | Standard |
| `IX_SystemPrompts_UsageCount` | UsageCount | Standard |
| `IX_SystemPrompts_ActiveList` | IsActive, Category, UpdatedAt | Composite, UpdatedAt DESC |

---

### 4. ISystemPromptRepository.cs

**Path:** `src/AIntern.Data/Repositories/ISystemPromptRepository.cs`
**Lines:** ~280

#### Purpose

Repository interface providing complete abstraction over system prompt data operations.

#### Read Operations (9 methods)

| Method | Returns | Description |
|--------|---------|-------------|
| `GetByIdAsync(id)` | `SystemPromptEntity?` | Find by primary key |
| `GetDefaultAsync()` | `SystemPromptEntity?` | Get the default active prompt |
| `GetAllActiveAsync()` | `IReadOnlyList<>` | All active prompts, ordered by category/name |
| `GetByCategoryAsync(category)` | `IReadOnlyList<>` | Active prompts in category |
| `GetCategoriesAsync()` | `IReadOnlyList<string>` | Distinct categories |
| `SearchAsync(searchTerm)` | `IReadOnlyList<>` | Search name/description |
| `NameExistsAsync(name, excludeId?)` | `bool` | Check name uniqueness |
| `GetByNameAsync(name)` | `SystemPromptEntity?` | Find by exact name (v0.2.4a) |
| `GetUserPromptsAsync()` | `IReadOnlyList<>` | Non-built-in active prompts (v0.2.4a) |
| `GetBuiltInPromptsAsync()` | `IReadOnlyList<>` | Built-in active prompts (v0.2.4a) |

#### Write Operations (4 methods)

| Method | Description |
|--------|-------------|
| `CreateAsync(prompt)` | Insert new prompt |
| `UpdateAsync(prompt)` | Update existing prompt |
| `DeleteAsync(id)` | Soft-delete (sets IsActive=false) |
| `HardDeleteAsync(id)` | Permanent delete (protected for built-ins) |

#### Action Operations (3 methods)

| Method | Description |
|--------|-------------|
| `SetAsDefaultAsync(id)` | Atomically switch default prompt |
| `IncrementUsageCountAsync(id)` | Increment usage counter |
| `RestoreAsync(id)` | Undelete (sets IsActive=true) |

---

### 5. SystemPromptRepository.cs

**Path:** `src/AIntern.Data/Repositories/SystemPromptRepository.cs`
**Lines:** ~350+

#### Purpose

Complete implementation of ISystemPromptRepository with comprehensive logging.

#### Key Implementation Details

**Soft Delete:**
```csharp
public async Task DeleteAsync(Guid id, CancellationToken cancellationToken = default)
{
    // Sets IsActive = false instead of removing
    await _context.SystemPrompts
        .Where(p => p.Id == id)
        .ExecuteUpdateAsync(setters =>
            setters.SetProperty(p => p.IsActive, false),
            cancellationToken);
}
```

**Built-in Protection:**
```csharp
public async Task HardDeleteAsync(Guid id, CancellationToken cancellationToken = default)
{
    var prompt = await _context.SystemPrompts.FindAsync([id], cancellationToken);
    if (prompt == null) return;

    if (prompt.IsBuiltIn)
    {
        _logger.LogWarning("Attempted to hard delete built-in prompt: {PromptId}", id);
        return;  // Silently refuse to delete built-in prompts
    }

    _context.SystemPrompts.Remove(prompt);
    await _context.SaveChangesAsync(cancellationToken);
}
```

**Atomic Default Switching:**
```csharp
public async Task SetAsDefaultAsync(Guid id, CancellationToken cancellationToken = default)
{
    // Clear existing default
    await _context.SystemPrompts
        .Where(p => p.IsDefault)
        .ExecuteUpdateAsync(setters =>
            setters.SetProperty(p => p.IsDefault, false),
            cancellationToken);

    // Set new default
    await _context.SystemPrompts
        .Where(p => p.Id == id)
        .ExecuteUpdateAsync(setters =>
            setters.SetProperty(p => p.IsDefault, true),
            cancellationToken);
}
```

---

## Files Modified

### 1. SystemPromptEntity.cs

**Path:** `src/AIntern.Core/Entities/SystemPromptEntity.cs`
**Changes:** Enhanced with TagsJson and navigation property

#### Added Properties

```csharp
/// <summary>
/// Gets or sets the tags as a JSON-serialized array.
/// </summary>
/// <remarks>
/// <para>Tags provide searchable keywords for finding prompts.</para>
/// <para>Stored as a JSON array, e.g., <c>["coding", "helpful", "technical"]</c>.</para>
/// <para>Maximum length: 1000 characters (enforced by EF Core config).</para>
/// <para>Added in v0.2.4a.</para>
/// </remarks>
public string? TagsJson { get; set; }

/// <summary>
/// Gets or sets the conversations using this system prompt.
/// </summary>
public ICollection<ConversationEntity> Conversations { get; set; } = new List<ConversationEntity>();
```

### 2. ValidationResult.cs

**Path:** `src/AIntern.Core/ValidationResult.cs`
**Changes:** Enhanced for reuse by SystemPrompt.Validate()

This record was already present but enhanced with:
- Static `Success` property for caching
- `Failure(params string[])` overload
- `Failure(IReadOnlyList<string>)` overload
- `FirstError` property
- `GetAllErrors(separator)` method

---

## Logging Specifications

All repository operations use the project's exhaustive logging pattern:

| Level | Format | Usage |
|-------|--------|-------|
| Debug | `[ENTER] MethodName - Param: {Value}` | Method entry |
| Debug | `[INFO] Description` | State changes |
| Debug | `[EXIT] MethodName - Duration: {Ms}ms` | Method exit |
| Warning | `[WARNING] Description` | Built-in protection, empty results |

### Example Log Output

```
[DEBUG] Getting system prompt by ID: 00000002-0000-0000-0000-000000000001
[DEBUG] System prompt found: Default Assistant
[DEBUG] Setting prompt as default: 00000002-0000-0000-0000-000000000003
[DEBUG] Cleared existing default prompt
[DEBUG] Set new default: Code Expert
[WARNING] Attempted to hard delete built-in prompt: 00000002-0000-0000-0000-000000000001
```

---

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| **Tags as JSON** | Simple storage without extra join table; parsed in domain model |
| **Well-known GUIDs** | Stable references across database resets; predictable for tests |
| **~4 chars/token estimate** | Rough approximation, good enough for UI display |
| **Soft-delete via IsActive** | Preserves data; allows restoration; protects referential integrity |
| **Built-in protection** | Prevents accidental deletion of shipped templates |
| **Category string (not enum)** | Allows future categories without code changes |
| **Separate domain/entity** | Clean separation of validation, computed props from persistence |

---

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | SystemPrompt.Validate() checks name/content/description/category lengths | Implemented |
| AC-2 | SystemPrompt.Duplicate() creates independent copy with new ID | Implemented |
| AC-3 | CharacterCount and EstimatedTokenCount compute correctly | Implemented |
| AC-4 | Repository CRUD operations work correctly | Implemented |
| AC-5 | Built-in prompts protected from hard delete | Implemented |
| AC-6 | Search finds prompts by name or description | Implemented |
| AC-7 | SetAsDefaultAsync clears previous default atomically | Implemented |
| AC-8 | 8 built-in templates with well-known GUIDs | Implemented |
| AC-9 | Name uniqueness enforced via index | Implemented |
| AC-10 | TagsJson column stores JSON array | Implemented |
| AC-11 | FromEntity/ToEntity mapping works correctly | Implemented |
| AC-12 | Build passes with 0 errors, 0 warnings | Verified |

---

## Dependencies

### Required Components

| Component | Usage |
|-----------|-------|
| `AInternDbContext` | EF Core database context |
| `ValidationResult` | Validation return type |
| `System.Text.Json` | Tags serialization |
| `Microsoft.EntityFrameworkCore` | Data access |

### Downstream Consumers (future versions)

| Component | Description |
|-----------|-------------|
| SystemPromptService | Business logic layer (v0.2.4b) |
| SystemPromptViewModel | UI binding (v0.2.4c) |
| DatabaseInitializer | Seeding built-in templates |

---

## Migration Notes

### From Previous Version

No breaking changes. New components are additive.

### Database Migration

The enhanced `SystemPromptEntity` requires a migration to add:
- `TagsJson` column (nullable, max 1000 chars)

Existing data will have NULL for TagsJson initially.

---

## Next Steps (v0.2.4b+)

| Version | Description |
|---------|-------------|
| v0.2.4b | System prompt service layer |
| v0.2.4c | System prompt ViewModel |
| v0.2.4d | System prompt selector UI |

---

## Files Summary

| File | Action | Est. Lines |
|------|--------|------------|
| `Core/Models/SystemPrompt.cs` | Created | ~470 |
| `Core/Templates/SystemPromptTemplates.cs` | Created | ~480 |
| `Data/Configurations/SystemPromptConfiguration.cs` | Created | ~250 |
| `Data/Repositories/ISystemPromptRepository.cs` | Created | ~280 |
| `Data/Repositories/SystemPromptRepository.cs` | Created | ~350+ |
| `Core/Entities/SystemPromptEntity.cs` | Modified | +20 |
| `Core/ValidationResult.cs` | Enhanced | existing |
| **Total New/Modified Lines** | | **~1850+** |
