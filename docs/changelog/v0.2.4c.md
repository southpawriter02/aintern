# v0.2.4c - Editor ViewModels

**Release Date:** 2026-01-13
**Type:** Feature (ViewModel Layer)
**Status:** Complete

## Overview

This release implements the ViewModel layer for the system prompt editor. Three ViewModels provide UI state management for the full editor window (`SystemPromptEditorViewModel`), list items (`SystemPromptViewModel`), and the chat header dropdown selector (`SystemPromptSelectorViewModel`).

**Building on:** v0.2.4b (System Prompt Service)
**Design Reference:** [v0.2.4c-editor-viewmodels.md](../design/v0.2.x/v0.2.4c-editor-viewmodels.md)

## Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                     v0.2.4c ViewModel Layer                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              SystemPromptEditorViewModel (~550 lines)          │  │
│  │                                                                │  │
│  │  ┌──────────────────┐    ┌──────────────────────────────────┐ │  │
│  │  │ UserPrompts      │    │ Editor State                     │ │  │
│  │  │ Templates        │    │ ─ PromptName, EditorContent      │ │  │
│  │  │ SelectedPrompt   │    │ ─ IsDirty, IsEditing, IsNewPrompt│ │  │
│  │  └──────────────────┘    │ ─ _originalPrompt (dirty track)  │ │  │
│  │                          └──────────────────────────────────┘ │  │
│  │  ┌──────────────────────────────────────────────────────────┐ │  │
│  │  │ Commands: CreateNew, Save, Delete, Duplicate, SetDefault │ │  │
│  │  └──────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                   │                                  │
│                                   ▼                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              SystemPromptSelectorViewModel (~200 lines)        │  │
│  │  AvailablePrompts, SelectedPrompt, SelectPromptCommand         │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                   │                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              SystemPromptViewModel (~320 lines)                │  │
│  │  Id, Name, Content, IsBuiltIn, ContentPreview, CategoryIcon   │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                   │                                  │
│                                   ▼                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │           ISystemPromptService (from v0.2.4b)                  │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

## Files Created

### 1. SystemPromptViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/SystemPromptViewModel.cs`
**Lines:** ~320

ViewModel representing a system prompt in UI lists (editor sidebar, selector dropdown).

#### Identity Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique identifier (init-only) |

#### Observable Properties

| Property | Type | Description |
|----------|------|-------------|
| `Name` | `string` | Display name |
| `Content` | `string` | Prompt text |
| `Description` | `string?` | Optional description |
| `Category` | `string` | Categorization ("General", "Code", etc.) |
| `IsBuiltIn` | `bool` | Is a template |
| `IsDefault` | `bool` | Is the default prompt |
| `IsSelected` | `bool` | Selection state in lists |
| `UsageCount` | `int` | Usage statistics |

#### Computed Properties

| Property | Type | Description |
|----------|------|-------------|
| `CharacterCount` | `int` | `Content.Length` |
| `EstimatedTokenCount` | `int` | `CharacterCount / 4` |
| `ContentPreview` | `string` | First 100 chars + "..." |
| `TypeLabel` | `string` | "Template" or "Custom" |
| `CategoryIcon` | `string` | Icon key based on category |

#### Constructors

| Constructor | Description |
|-------------|-------------|
| `SystemPromptViewModel()` | Empty ViewModel for special items |
| `SystemPromptViewModel(SystemPrompt)` | Maps from domain model |

### 2. SystemPromptEditorViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/SystemPromptEditorViewModel.cs`
**Lines:** ~550

Full editor ViewModel with CRUD operations, dirty tracking, and validation.

#### Dependencies

| Dependency | Type | Purpose |
|------------|------|---------|
| `ISystemPromptService` | Interface | CRUD operations |
| `IDispatcher` | Interface | UI thread marshaling |
| `ILogger<SystemPromptEditorViewModel>` | Interface | Exhaustive logging |

#### Prompt Lists

| Property | Type | Description |
|----------|------|-------------|
| `UserPrompts` | `ObservableCollection<SystemPromptViewModel>` | Custom prompts |
| `Templates` | `ObservableCollection<SystemPromptViewModel>` | Built-in prompts |
| `SelectedPrompt` | `SystemPromptViewModel?` | Currently selected |

#### Editor State

| Property | Type | Description |
|----------|------|-------------|
| `PromptName` | `string` | Editable name |
| `PromptDescription` | `string` | Editable description |
| `PromptCategory` | `string` | Editable category |
| `EditorContent` | `string` | Editable content |
| `IsDirty` | `bool` | Has unsaved changes |
| `IsEditing` | `bool` | In edit mode |
| `IsNewPrompt` | `bool` | Creating new prompt |
| `IsLoading` | `bool` | Loading state |

#### Computed Properties

| Property | Type | Description |
|----------|------|-------------|
| `CharacterCount` | `int` | `EditorContent.Length` |
| `EstimatedTokenCount` | `int` | `CharacterCount / 4` |
| `CharacterCountText` | `string` | Formatted character count |
| `TokenCountText` | `string` | Formatted token estimate |
| `HasContent` | `bool` | Content is not empty |
| `HasValidName` | `bool` | Name is not empty |
| `CanSave` | `bool` | `HasValidName && HasContent && IsDirty` |
| `CanEdit` | `bool` | Can edit current prompt |
| `CanDelete` | `bool` | Can delete current prompt |
| `CanSetDefault` | `bool` | Can set as default |

#### Commands

| Command | CanExecute | Description |
|---------|------------|-------------|
| `InitializeCommand` | Always | Load prompts on startup |
| `LoadPromptsCommand` | Always | Refresh lists from service |
| `CreateNewPromptCommand` | Always | Initialize empty editor |
| `SavePromptCommand` | `CanSave` | Create or update prompt |
| `DeletePromptCommand` | `CanDelete` | Delete with reset |
| `DuplicatePromptCommand` | `SelectedPrompt != null` | Clone existing prompt |
| `SetAsDefaultCommand` | `CanSetDefault` | Mark as default |
| `CreateFromTemplateCommand` | Always | Clone from template |
| `DiscardChangesCommand` | `IsDirty` | Revert to original |

#### Event Subscriptions

| Event | Source | Handler |
|-------|--------|---------|
| `PromptListChanged` | `ISystemPromptService` | `OnPromptListChanged` |

### 3. SystemPromptSelectorViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/SystemPromptSelectorViewModel.cs`
**Lines:** ~200

Quick selector ViewModel for the chat header dropdown.

#### Dependencies

| Dependency | Type | Purpose |
|------------|------|---------|
| `ISystemPromptService` | Interface | Prompt operations |
| `IDispatcher` | Interface | UI thread marshaling |
| `ILogger<SystemPromptSelectorViewModel>` | Interface | Logging |

#### Properties

| Property | Type | Description |
|----------|------|-------------|
| `AvailablePrompts` | `ObservableCollection<SystemPromptViewModel>` | All prompts + "None" option |
| `SelectedPrompt` | `SystemPromptViewModel?` | Currently selected |
| `IsLoading` | `bool` | Loading state |

#### Computed Properties

| Property | Type | Description |
|----------|------|-------------|
| `HasPromptSelected` | `bool` | Has selection (not "None") |
| `DisplayText` | `string` | Selected name or "No system prompt" |
| `ContentPreview` | `string` | Selected prompt preview |
| `SelectedCategory` | `string` | Selected prompt category |
| `IsBuiltInSelected` | `bool` | Is template selected |

#### Commands

| Command | Description |
|---------|-------------|
| `InitializeCommand` | Load prompts and sync state |
| `SelectPromptCommand` | Apply selection to service |
| `RefreshPromptsCommand` | Refresh from service |

#### Event Subscriptions

| Event | Source | Handler |
|-------|--------|---------|
| `PromptListChanged` | `ISystemPromptService` | `OnPromptListChanged` |
| `CurrentPromptChanged` | `ISystemPromptService` | `OnCurrentPromptChanged` |

## Files Modified

### 1. ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`
**Changes:** Added ViewModel DI registrations

```csharp
// System Prompt Editor: manages prompt editing state with service integration.
// Transient so each editor window gets its own instance with independent state.
// Subscribes to ISystemPromptService events for list synchronization.
// Added in v0.2.4c.
services.AddTransient<SystemPromptEditorViewModel>();

// System Prompt Selector: quick selector for the chat header dropdown.
// Singleton to share selection state across the application.
// Subscribes to ISystemPromptService events for automatic synchronization.
// Added in v0.2.4c.
services.AddSingleton<SystemPromptSelectorViewModel>();
```

## Key Implementation Details

### Dirty Tracking Strategy

The editor tracks unsaved changes by comparing current editor values against `_originalPrompt`:

```csharp
private void UpdateDirtyState()
{
    if (_originalPrompt == null && !IsNewPrompt)
    {
        IsDirty = false;
        return;
    }

    if (IsNewPrompt)
    {
        IsDirty = !string.IsNullOrWhiteSpace(PromptName) ||
                  !string.IsNullOrWhiteSpace(EditorContent);
        return;
    }

    IsDirty = PromptName != _originalPrompt!.Name ||
              EditorContent != _originalPrompt.Content ||
              (PromptDescription ?? "") != (_originalPrompt.Description ?? "") ||
              PromptCategory != _originalPrompt.Category;
}
```

### Property Change Notification

When observable properties change, computed properties and commands are notified:

```csharp
partial void OnEditorContentChanged(string value)
{
    _logger.LogDebug("[INFO] EditorContent changed, Length: {Length}", value?.Length ?? 0);

    UpdateDirtyState();

    // Notify computed properties
    OnPropertyChanged(nameof(CharacterCount));
    OnPropertyChanged(nameof(EstimatedTokenCount));
    OnPropertyChanged(nameof(CharacterCountText));
    OnPropertyChanged(nameof(TokenCountText));
    OnPropertyChanged(nameof(HasContent));
    OnPropertyChanged(nameof(CanSave));

    // Notify command CanExecute
    SavePromptCommand.NotifyCanExecuteChanged();
}
```

### Event Handler Pattern with UI Thread

Service events trigger async reloads with proper UI thread marshaling:

```csharp
private async void OnPromptListChanged(object? sender, PromptListChangedEventArgs e)
{
    _logger.LogDebug("[EVENT] PromptListChanged - Type: {Type}, AffectedId: {Id}",
        e.ChangeType, e.AffectedPromptId);

    try
    {
        await LoadPromptsAsync();
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "[EVENT] Failed to reload prompts after list change");
    }
}
```

### Selector "No Prompt" Option

The selector includes a special "No prompt" option at the beginning:

```csharp
// Add "No prompt" option first.
AvailablePrompts.Add(new SystemPromptViewModel
{
    Id = Guid.Empty,
    Name = NoPromptDisplayName,
    Content = string.Empty,
    Description = NoPromptDescription,
    Category = string.Empty,
    IsBuiltIn = false,
    IsDefault = false
});
```

## Logging Specifications

All ViewModels follow the exhaustive logging pattern:

| Marker | Level | Usage |
|--------|-------|-------|
| `[ENTER]` | Debug | Method entry with parameters |
| `[INFO]` | Debug | Significant state changes |
| `[SKIP]` | Debug | No-op conditions (early returns) |
| `[EXIT]` | Debug | Method completion with duration |
| `[EVENT]` | Debug | Event handling |
| `[INIT]` | Debug | Constructor completion |
| `[DISPOSE]` | Debug | Resource cleanup |

Example log output:
```
[INIT] SystemPromptEditorViewModel created
[ENTER] InitializeAsync
[ENTER] LoadPromptsAsync
[EXIT] LoadPromptsAsync - Loaded 5 user, 3 templates, Duration: 12ms
[EXIT] InitializeAsync - Loaded 8 prompts total, Duration: 15ms
[INFO] SelectedPrompt changed to: My Custom Prompt (Id: abc123...)
[INFO] EditorContent changed, Length: 256
[INFO] IsDirty changed to: True
```

## Usage Examples

### Initialize Editor on Window Open

```csharp
public partial class SystemPromptEditorWindow : Window
{
    public SystemPromptEditorWindow(SystemPromptEditorViewModel viewModel)
    {
        DataContext = viewModel;
        InitializeComponent();

        // Load prompts when window opens
        Loaded += async (s, e) => await viewModel.InitializeAsync();
    }
}
```

### Bind Selector in Chat Header

```xaml
<ComboBox ItemsSource="{Binding PromptSelector.AvailablePrompts}"
          SelectedItem="{Binding PromptSelector.SelectedPrompt}"
          IsEnabled="{Binding !PromptSelector.IsLoading}">
    <ComboBox.ItemTemplate>
        <DataTemplate>
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding Name}" />
                <TextBlock Text="{Binding TypeLabel}"
                           Opacity="0.6"
                           Margin="8,0,0,0" />
            </StackPanel>
        </DataTemplate>
    </ComboBox.ItemTemplate>
</ComboBox>
```

### Handle Selection Change

```csharp
// In ChatViewModel
public ChatViewModel(
    ILlmService llmService,
    SystemPromptSelectorViewModel promptSelector)
{
    PromptSelector = promptSelector;

    // Selection changes automatically call SetCurrentPromptAsync
    // which persists to settings and fires events
}
```

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| Separate UserPrompts/Templates lists | Cleaner UI grouping in editor sidebar |
| `_originalPrompt` for dirty tracking | Simple comparison without service calls |
| CanExecute on RelayCommands | Disable buttons when invalid state |
| ContentPreview 100 chars | Balance between info and space |
| Selector includes "None" option | Allow disabling system prompt |
| Transient EditorViewModel | Each editor window gets its own state |
| Singleton SelectorViewModel | Share state across chat windows |
| IDispatcher for UI thread | ObservableCollection must be modified on UI thread |
| Exhaustive logging | Match existing service patterns |

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | UserPrompts shows only custom prompts | Implemented |
| AC-2 | Templates shows only built-in prompts | Implemented |
| AC-3 | CanEdit=false for built-in prompts | Implemented |
| AC-4 | IsDirty tracks changes correctly | Implemented |
| AC-5 | CanSave=true only when valid and dirty | Implemented |
| AC-6 | CharacterCount/TokenCount update on content change | Implemented |
| AC-7 | CreateNewPromptAsync initializes empty editor | Implemented |
| AC-8 | SavePromptAsync creates or updates correctly | Implemented |
| AC-9 | Selector includes "No prompt" option | Implemented |
| AC-10 | Event handlers refresh on service changes | Implemented |
| AC-11 | Build passes with 0 errors, 0 warnings | To verify |
| AC-12 | All existing tests pass | To verify |

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Desktop/ViewModels/SystemPromptViewModel.cs` | Created | ~320 |
| `src/AIntern.Desktop/ViewModels/SystemPromptEditorViewModel.cs` | Created | ~550 |
| `src/AIntern.Desktop/ViewModels/SystemPromptSelectorViewModel.cs` | Created | ~200 |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Modified | +15 |
| **Total** | | ~1,085 |

## Next Steps (v0.2.4d+)

| Version | Description |
|---------|-------------|
| v0.2.4d | System prompt editor dialog UI (AXAML) |
| v0.2.4e | System prompt selector dropdown UI |
| v0.2.4f | Integration testing and polish |

## Related Documentation

- [v0.2.4-system-prompt-editor.md](../design/v0.2.x/v0.2.4-system-prompt-editor.md) - Feature overview
- [v0.2.4a.md](v0.2.4a.md) - Models & Repository changelog
- [v0.2.4b.md](v0.2.4b.md) - System Prompt Service changelog
- [v0.2.4c-editor-viewmodels.md](../design/v0.2.x/v0.2.4c-editor-viewmodels.md) - Design specification
