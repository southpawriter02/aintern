# v0.5.1e – Shell Detection Service

**Release Date:** 2026-01-17

## Summary

Enhanced shell detection service with caching, version detection, and comprehensive cross-platform shell discovery. This version completes the shell detection system with production-ready features including executable validation and automatic version extraction.

## Features Added

### Enhanced IShellDetectionService Interface

- **`GetDefaultShellAsync`** – Returns just the shell path for convenience
- **`IsShellAvailableAsync`** – Validates shell executability with timeout
- **Updated `ShellInfo` record** – Added `Name` and `IsDefault` properties
- **`Nushell` shell type** – Added support for Nushell detection

### ShellDetectionService (New)

Full-featured shell detection service with:

- **Result Caching** – Both default shell and available shells cached for lifetime
- **Thread-Safe Access** – Lock-based cache synchronization
- **Version Detection** – Extracts versions via `--version` command
- **Executable Validation** – Verifies shells respond to version queries
- **Exhaustive Logging** – Debug-level logs for all detection steps

### Platform-Specific Detection

#### Windows
- PowerShell Core (`pwsh.exe`) – via PATH search
- Windows PowerShell (`powershell.exe`) – via System folder
- Command Prompt (`cmd.exe`) – via COMSPEC or System folder
- Git Bash – checks common installation paths
- WSL (`wsl.exe`) – via System folder
- Nushell (`nu.exe`) – via PATH search

#### macOS
- `$SHELL` environment variable (primary)
- `dscl` directory services query (fallback)
- `/bin/zsh` default (Catalina+)
- PowerShell Core via Homebrew/local bin
- Fish shell via Homebrew/local bin

#### Linux
- `$SHELL` environment variable (primary)
- `/etc/passwd` user entry (fallback)
- `/bin/bash` default
- PowerShell Core via snap/local bin
- Fish and Nushell via common paths

## Files Modified

### Core Interfaces
- `src/AIntern.Core/Interfaces/IShellDetectionService.cs`
  - Added `GetDefaultShellAsync` method
  - Added `IsShellAvailableAsync` method
  - Added `Name` and `IsDefault` to `ShellInfo`
  - Added `Nushell` to `ShellType` enum

### Services
- `src/AIntern.Services/Terminal/ShellDetectionService.cs` **(NEW)**
  - Full caching implementation
  - Version detection via process execution
  - Platform-specific detection methods
- `src/AIntern.Services/Terminal/DefaultShellDetectionService.cs`
  - Updated to implement new interface methods
  - Simple file existence check for validation

## Unit Tests Added

### ShellDetectionServiceTests (24 tests)
- Constructor validation
- `GetDefaultShellAsync` caching and path validation
- `DetectDefaultShellAsync` ShellInfo validation
- `GetAvailableShellsAsync` enumeration and ordering
- `IsShellAvailableAsync` for valid/invalid paths
- `ShellInfo` ToString formatting
- `ShellType` enum value validation

### DefaultShellDetectionServiceTests (7 new tests)
- `GetDefaultShellAsync` tests
- `IsShellAvailableAsync` tests

**Total new tests:** 31

## API Examples

### Getting Default Shell
```csharp
var shellPath = await _shellDetection.GetDefaultShellAsync();
// Returns: "/bin/zsh" (macOS) or "C:\Windows\System32\cmd.exe" (Windows)
```

### Getting Available Shells
```csharp
var shells = await _shellDetection.GetAvailableShellsAsync();
foreach (var shell in shells)
{
    Console.WriteLine($"{shell.Name}: {shell.Path} ({shell.Version ?? "unknown"})");
    if (shell.IsDefault) Console.WriteLine("  (default)");
}
```

### Validating a Shell
```csharp
var isValid = await _shellDetection.IsShellAvailableAsync("/usr/local/bin/fish");
// Returns true if fish responds to --version within 5 seconds
```

## Performance Characteristics

| Operation | First Call | Cached |
|-----------|-----------|--------|
| `GetDefaultShellAsync` | 50-200ms | <1ms |
| `GetAvailableShellsAsync` | 500ms-2s | <1ms |
| `IsShellAvailableAsync` | 50-100ms | N/A |

## Dependencies

- `Microsoft.Extensions.Logging.Abstractions`
- `System.Diagnostics.Process` (built-in)
- `System.Runtime.InteropServices` (built-in)

## Breaking Changes

- `ShellInfo.Name` is now a required property
- `ShellInfo.IsDefault` property added (defaults to false)

## Migration Notes

Update any code creating `ShellInfo` objects to include the `Name` property:

```csharp
// Before (v0.5.1d)
var shell = new ShellInfo
{
    Path = "/bin/bash",
    ShellType = ShellType.Bash
};

// After (v0.5.1e)
var shell = new ShellInfo
{
    Name = "Bash",
    Path = "/bin/bash",
    ShellType = ShellType.Bash,
    IsDefault = true
};
```

## Related Specifications

- [v0.5.1e-shell-detection.md](../design/v0.5.x/v0.5.1e-shell-detection.md) – Design specification
- [v0.5.1d-terminal-service.md](../design/v0.5.x/v0.5.1d-terminal-service.md) – Consumer of this service
