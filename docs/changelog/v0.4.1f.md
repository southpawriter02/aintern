# v0.4.1f Changelog: Streaming Parser

## Summary

Implemented an incremental streaming parser for detecting and extracting code blocks during LLM token generation. This enables real-time UI updates showing code blocks as they stream, rather than waiting for the complete response.

---

## New Files

### Models

| File | Description |
|------|-------------|
| `AIntern.Core/Models/StreamingParserState.cs` | Parser state machine enum and FenceType enum |
| `AIntern.Core/Models/PartialCodeBlock.cs` | In-progress code block model with content accumulation |

### Events

| File | Description |
|------|-------------|
| `AIntern.Core/Events/CodeBlockEvents.cs` (modified) | Added streaming events: BlockStarted, ContentAdded, BlockCompleted |

### Interfaces

| File | Description |
|------|-------------|
| `AIntern.Core/Interfaces/IStreamingCodeBlockParser.cs` | Interface for incremental code block parsing |

### Implementation

| File | Description |
|------|-------------|
| `AIntern.Services/StreamingCodeBlockParser.cs` | State machine-based parser implementation |
| `AIntern.Services/Factories/StreamingParserFactory.cs` | Factory for creating parser instances |

### Tests

| File | Test Count |
|------|------------|
| `AIntern.Services.Tests/StreamingCodeBlockParserTests.cs` | 30 |

---

## Key Features

### State Machine Architecture

```
┌─────────┐    ```    ┌──────────────┐   \n    ┌─────────────┐
│  TEXT   │ ────────► │ FENCE_OPENING│ ────────► │ CODE_CONTENT│
└─────────┘           └──────────────┘           └─────────────┘
     ▲                                                  │
     │ complete                                         │ ```
     │                                                  ▼
     │                ┌──────────────┐           ┌─────────────┐
     └──────────────── │    TEXT      │ ◄──────── │FENCE_CLOSING│
                       └──────────────┘   \n      └─────────────┘
```

### Fence Syntax Support

| Syntax | Example | Description |
|--------|---------|-------------|
| Basic | ` ``` ` | No language specified |
| Language | ` ```csharp ` | Language identifier |
| Path | ` ```csharp:src/User.cs ` | Language + file path |
| Quoted | ` ```csharp:"src/My Dir/File.cs" ` | Quoted path (spaces) |
| Tilde | ` ~~~ ` | Alternative fence style |
| Extended | ` ```` ` | 4+ backticks for nesting |

### Events

| Event | Trigger | Data |
|-------|---------|------|
| `BlockStarted` | Opening fence + newline | `PartialCodeBlock`, Language, Path |
| `ContentAdded` | Each character in code | Content string, block reference |
| `BlockCompleted` | Closing fence or EOF | `CodeBlock`, Duration, WasTruncated |
| `ParseError` | Malformed input | Error message, position |

### API Overview

```csharp
// Create parser via factory
var parser = _parserFactory.Create(messageId);

// Subscribe to events
parser.BlockStarted += (s, e) => CreateCodeBlockUI(e.Block);
parser.ContentAdded += (s, e) => UpdateCodeBlockUI(e.Content);
parser.BlockCompleted += (s, e) => FinalizeCodeBlockUI(e.Block);

// Feed tokens during streaming
await foreach (var token in llm.GenerateStreamingAsync(...))
{
    parser.FeedToken(token);
}

// Finalize
parser.Complete();
var blocks = parser.GetCompletedBlocks();
```

---

## Modified Files

| File | Change |
|------|--------|
| `AIntern.Core/Events/CodeBlockEvents.cs` | Added 4 streaming event args classes |
| `AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | DI registration |

---

## Dependencies

| Version | Component | Usage |
|---------|-----------|-------|
| v0.4.1a | CodeBlock, TextRange | Completed block model |
| v0.4.1c | ILanguageDetectionService | Language normalization |
| v0.4.1d | IBlockClassificationService | Block type classification |

---

## Verification

| Check | Status |
|-------|--------|
| Build | ✅ 0 errors |
| Unit Tests | ✅ 30 passing |
| DI Registration | ✅ Verified |
