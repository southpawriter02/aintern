# v0.5.1c: Implement ANSI Parser

**Released:** 2026-01-17  
**Status:** _IMPLEMENTED_

## Overview

This release implements the ANSI escape sequence parser (`AnsiParser`) for the integrated terminal. The parser processes VT100/ANSI escape sequences from the PTY output stream and translates them into operations on the `TerminalBuffer`.

## New Components

### AnsiParserState (`AIntern.Core.Terminal.AnsiParserState`)

A 12-state enumeration defining the parser's state machine:

| State | Description |
|-------|-------------|
| `Ground` | Normal character processing |
| `Escape` | After ESC (0x1B) received |
| `EscapeIntermediate` | ESC followed by intermediate bytes |
| `CsiEntry` | CSI (Control Sequence Introducer) entry |
| `CsiParam` | Collecting CSI parameters |
| `CsiIntermediate` | CSI intermediate bytes |
| `OscString` | OSC (Operating System Command) collection |
| `DcsEntry` | DCS (Device Control String) entry |
| `DcsParam` | DCS parameter collection |
| `DcsIntermediate` | DCS intermediate bytes |
| `DcsPassthrough` | DCS passthrough mode |
| `SosPmApcString` | SOS/PM/APC string collection |

### AnsiParser (`AIntern.Core.Terminal.AnsiParser`)

A sealed class that parses VT100/ANSI escape sequences.

**Features:**
- **C0 Control Characters**: NUL, BEL, BS, HT, LF, VT, FF, CR, ESC, CAN, SUB
- **CSI Sequences**: Cursor movement (A-H, d, f, G), screen clearing (J, K), line operations (L, M), character operations (@, P, X), scrolling (S, T, r), cursor save/restore (s, u), and styling (m)
- **SGR Styling**: Basic attributes (bold, dim, italic, underline, blink, inverse, hidden, strikethrough), standard/bright colors (30-37, 40-47, 90-97, 100-107), 256-color palette (38/48;5;n), and 24-bit true color (38/48;2;r;g;b)
- **DEC Private Modes**: Cursor visibility (?25), auto-wrap (?7), origin mode (?6)
- **OSC Commands**: Window title (0, 1, 2), working directory (7), hyperlinks (8)

**Events:**
- `Bell` - Raised when BEL (0x07) is received
- `TitleChanged` - Raised when terminal title changes via OSC
- `WorkingDirectoryChanged` - Raised when working directory changes via OSC 7
- `HyperlinkDetected` - Raised when hyperlink is detected via OSC 8

## TerminalBuffer Extensions

Added 10 new methods to support parser operations:

| Method | CSI Sequence | Description |
|--------|--------------|-------------|
| `CursorUp(int)` | CSI A (CUU) | Move cursor up |
| `CursorDown(int)` | CSI B (CUD) | Move cursor down |
| `CursorForward(int)` | CSI C (CUF) | Move cursor forward |
| `CursorBack(int)` | CSI D (CUB) | Move cursor back |
| `InsertLines(int)` | CSI L (IL) | Insert blank lines |
| `DeleteLines(int)` | CSI M (DL) | Delete lines |
| `InsertChars(int)` | CSI @ (ICH) | Insert blank characters |
| `DeleteChars(int)` | CSI P (DCH) | Delete characters |
| `EraseChars(int)` | CSI X (ECH) | Erase characters in place |
| `ClearWithScrollback()` | CSI 3 J (ED 3) | Clear screen and scrollback |

## Unit Tests

- **AnsiParserStateTests**: 5 tests verifying state enumeration
- **AnsiParserTests**: 43 tests covering:
  - Constructor validation
  - C0 control character handling
  - Printable text writing
  - CSI cursor movement
  - CSI screen/line clearing
  - SGR color and attribute handling (including 256-color and true color)
  - DEC private mode set/reset
  - OSC command parsing
  - Escape sequence handling
  - Error recovery from invalid sequences
  - Line and character operations

## Files Changed

### New Files
- `src/AIntern.Core/Terminal/AnsiParserState.cs`
- `src/AIntern.Core/Terminal/AnsiParser.cs`
- `tests/AIntern.Core.Tests/Terminal/AnsiParserStateTests.cs`
- `tests/AIntern.Core.Tests/Terminal/AnsiParserTests.cs`

### Modified Files
- `src/AIntern.Core/Models/Terminal/TerminalBuffer.cs` - Added cursor/character operation methods

### Removed Files
- `src/AIntern.Core/Terminal/README.md` - Replaced by actual implementation

## Dependencies

No new dependencies. Uses existing:
- `AIntern.Core.Models.Terminal.TerminalBuffer`
- `AIntern.Core.Models.Terminal.TerminalAttributes`
- `AIntern.Core.Models.Terminal.TerminalColor`
