# v0.2.4e - Chat Integration

**Release Date:** 2026-01-13
**Type:** Feature (UI/ViewModel Integration)
**Status:** Complete

## Overview

This release integrates the system prompt feature into the chat interface, providing a quick dropdown selector in the chat header and displaying the active system prompt in a collapsible expander. The LLM context is now built with the system prompt prepended, following standard LLM conventions.

**Building on:** v0.2.4d (Editor Window UI)
**Design Reference:** [v0.2.4-system-prompt-editor.md](../design/v0.2.x/v0.2.4-system-prompt-editor.md)

## Architecture

```
+---------------------------------------------------------------------+
|                           MainWindow                                 |
+---------------------------------------------------------------------+
| +----------------------------------------------------------------+  |
| |  ChatView (Row 0: Header, Row 1: Expander, Row 2: Messages)    |  |
| | +------------------------------------------------------------+ |  |
| | | SystemPromptSelector (Dropdown + Edit Button)              | |  |
| | | Using: [v Default Assistant          ] [Edit]              | |  |
| | +------------------------------------------------------------+ |  |
| | +------------------------------------------------------------+ |  |
| | | System Prompt Expander (Collapsible)                       | |  |
| | | [>] Using: Default Assistant                               | |  |
| | |     "You are a helpful AI assistant..."                    | |  |
| | +------------------------------------------------------------+ |  |
| | +------------------------------------------------------------+ |  |
| | | Messages List (existing)                                   | |  |
| | | ...                                                        | |  |
| | +------------------------------------------------------------+ |  |
| +----------------------------------------------------------------+  |
+---------------------------------------------------------------------+
```

## LLM Context Flow

```
User sends message
    |
    v
ChatViewModel.SendMessageAsync()
    |
    v
BuildContextWithSystemPrompt()
    |
    +-- ISystemPromptService.CurrentPrompt != null?
    |       |
    |       Yes --> Yield ChatMessage(Role: System, Content: formatted prompt)
    |       |       Increment usage count async
    |       |
    |       No --> Skip system message
    |
    v
Yield all conversation messages from IConversationService
    |
    v
ILlmService.GenerateStreamingAsync(context, options)
```

## Files Created

### 1. SystemPromptSelector.axaml

**Path:** `src/AIntern.Desktop/Views/SystemPromptSelector.axaml`
**Lines:** 139

A UserControl providing quick dropdown selection of system prompts in the chat header.

#### Layout Structure

```
UserControl
└── Border (ControlBackground, CornerRadius=4, Padding=8,6)
    └── Grid (ColumnDefinitions="Auto,*,Auto")
        ├── TextBlock (Col 0) - "Using:" label
        ├── ComboBox (Col 1) - Prompt dropdown
        │   └── ItemTemplate (SystemPromptViewModel)
        │       └── Grid (3 columns)
        │           ├── PathIcon (StarIcon) - Default indicator
        │           ├── StackPanel - Name + Category
        │           └── Border - "Built-in" badge
        └── Button (Col 2) - Edit button (opens editor)
```

#### Data Bindings

| UI Element | Binding | Mode | Description |
|------------|---------|------|-------------|
| ComboBox.ItemsSource | `AvailablePrompts` | OneWay | Collection of prompts |
| ComboBox.SelectedItem | `SelectedPrompt` | TwoWay | Current selection |
| Star PathIcon.IsVisible | `IsDefault` | OneWay | Default indicator |
| Name TextBlock.Text | `Name` | OneWay | Prompt name |
| Category TextBlock.Text | `Category` | OneWay | Category label |
| Category TextBlock.IsVisible | `Category` (StringConverters) | OneWay | Hide if empty |
| Built-in Border.IsVisible | `IsBuiltIn` | OneWay | Badge visibility |

#### Dynamic Resources

| Resource | Usage |
|----------|-------|
| `ControlBackground` | Border background |
| `TextMuted` | "Using:" label |
| `AccentBrush` | Star icon foreground |
| `SidebarBackground` | Built-in badge background |

### 2. SystemPromptSelector.axaml.cs

**Path:** `src/AIntern.Desktop/Views/SystemPromptSelector.axaml.cs`
**Lines:** 183

Code-behind with routed event for Edit button click propagation.

#### Class Definition

```csharp
public partial class SystemPromptSelector : UserControl
```

#### Routed Event

```csharp
public static readonly RoutedEvent<RoutedEventArgs> EditButtonClickEvent =
    RoutedEvent.Register<SystemPromptSelector, RoutedEventArgs>(
        nameof(EditButtonClick),
        RoutingStrategies.Bubble);

public event EventHandler<RoutedEventArgs>? EditButtonClick
{
    add => AddHandler(EditButtonClickEvent, value);
    remove => RemoveHandler(EditButtonClickEvent, value);
}
```

#### Event Flow

```
User clicks Edit button
    |
    v
OnEditButtonClick (code-behind)
    |
    v
RaiseEvent(new RoutedEventArgs(EditButtonClickEvent, this))
    |
    v
Event bubbles up visual tree
    |
    v
ChatView.OnPromptSelectorEditButtonClick handler
    |
    v
MainWindowViewModel.OpenSystemPromptEditorCommand.Execute()
```

#### Methods

| Method | Purpose | Logging |
|--------|---------|---------|
| `SystemPromptSelector()` | Default constructor | [INIT] |
| `SystemPromptSelector(ILogger?)` | DI constructor | [INIT] |
| `OnEditButtonClick` | Raises EditButtonClickEvent | [ENTER]/[INFO]/[EXIT] |

## Files Modified

### 1. ChatView.axaml

**Path:** `src/AIntern.Desktop/Views/ChatView.axaml`
**Changes:** Expanded from 2-row to 4-row Grid layout (+50 lines)

#### New Layout

| Row | Content | Description |
|-----|---------|-------------|
| 0 | SystemPromptSelector | Quick dropdown in header |
| 1 | Expander | Collapsible prompt content |
| 2 | Messages List | Existing message display |
| 3 | Input Area | Existing input controls |

#### Row 0: System Prompt Selector Header

```xml
<Border Grid.Row="0"
        Background="{DynamicResource SidebarBackground}"
        BorderBrush="{DynamicResource BorderBrush}"
        BorderThickness="0,0,0,1"
        Padding="12,8">
    <views:SystemPromptSelector x:Name="PromptSelector"
                                DataContext="{Binding SystemPromptSelectorViewModel}" />
</Border>
```

#### Row 1: System Prompt Display Expander

```xml
<Border Grid.Row="1"
        IsVisible="{Binding ShowSystemPromptMessage}"
        Background="{DynamicResource SystemPromptBackgroundColor}"
        Padding="12"
        Margin="12,12,12,0"
        CornerRadius="8">
    <Expander IsExpanded="False">
        <Expander.Header>
            <StackPanel Orientation="Horizontal" Spacing="8">
                <PathIcon Data="{StaticResource PromptIcon}"
                          Width="16" Height="16"
                          Foreground="{DynamicResource TextMuted}" />
                <TextBlock Text="{Binding SystemPromptName, StringFormat='Using: {0}'}"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource TextMuted}" />
            </StackPanel>
        </Expander.Header>
        <TextBlock Text="{Binding SystemPromptContent}"
                   TextWrapping="Wrap"
                   Foreground="{DynamicResource TextMuted}"
                   FontSize="12"
                   Margin="24,8,0,0" />
    </Expander>
</Border>
```

### 2. ChatView.axaml.cs

**Path:** `src/AIntern.Desktop/Views/ChatView.axaml.cs`
**Changes:** Added Edit button event handler (+60 lines)

#### New Event Handler

```csharp
/// <summary>
/// Handles the Edit button click from the SystemPromptSelector control.
/// Opens the SystemPromptEditorWindow as a dialog.
/// </summary>
private void OnPromptSelectorEditButtonClick(object? sender, RoutedEventArgs e)
{
    var sw = Stopwatch.StartNew();
    _logger?.LogDebug("[ENTER] OnPromptSelectorEditButtonClick");

    try
    {
        var window = TopLevel.GetTopLevel(this) as Window;

        if (window?.DataContext is MainWindowViewModel mainViewModel)
        {
            if (mainViewModel.OpenSystemPromptEditorCommand.CanExecute(null))
            {
                mainViewModel.OpenSystemPromptEditorCommand.Execute(null);
            }
        }
    }
    catch (Exception ex)
    {
        _logger?.LogError(ex, "[ERROR] OnPromptSelectorEditButtonClick failed");
    }
    finally
    {
        sw.Stop();
        _logger?.LogDebug("[EXIT] OnPromptSelectorEditButtonClick - {ElapsedMs}ms", sw.ElapsedMilliseconds);
    }
}
```

#### Constructor Changes

```csharp
// Wire up the SystemPromptSelector's Edit button click handler
if (this.FindControl<SystemPromptSelector>("PromptSelector") is { } selector)
{
    selector.EditButtonClick += OnPromptSelectorEditButtonClick;
    _logger?.LogDebug("[INIT] PromptSelector EditButtonClick handler attached");
}
```

### 3. ChatViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/ChatViewModel.cs`
**Changes:** Added system prompt integration (~150 lines)

#### New Dependencies

| Dependency | Purpose |
|------------|---------|
| `ISystemPromptService` | Access current prompt, format content |
| `SystemPromptSelectorViewModel` | Expose for header dropdown binding |

#### New Properties

| Property | Type | Description |
|----------|------|-------------|
| `SystemPromptSelectorViewModel` | `SystemPromptSelectorViewModel` | Selector ViewModel for binding |
| `ShowSystemPromptMessage` | `bool` | Expander visibility |
| `SystemPromptContent` | `string?` | Prompt content for expander |
| `SystemPromptName` | `string?` | Prompt name for header |

#### New Methods

##### InitializeSystemPromptDisplay

```csharp
/// <summary>
/// Initializes the system prompt display state from the current service selection.
/// </summary>
private void InitializeSystemPromptDisplay()
{
    var currentPrompt = _systemPromptService.CurrentPrompt;

    if (currentPrompt != null)
    {
        ShowSystemPromptMessage = true;
        SystemPromptName = currentPrompt.Name;
        SystemPromptContent = currentPrompt.Content;
    }
    else
    {
        ShowSystemPromptMessage = false;
        SystemPromptName = null;
        SystemPromptContent = null;
    }
}
```

##### BuildContextWithSystemPrompt

```csharp
/// <summary>
/// Builds the LLM context with the system prompt prepended to the conversation.
/// </summary>
private IEnumerable<ChatMessage> BuildContextWithSystemPrompt()
{
    var currentPrompt = _systemPromptService.CurrentPrompt;

    // Prepend system prompt if one is selected
    if (currentPrompt != null)
    {
        var formattedContent = _systemPromptService.FormatPromptForContext(currentPrompt);

        yield return new ChatMessage
        {
            Id = Guid.NewGuid(),
            Role = MessageRole.System,
            Content = formattedContent ?? currentPrompt.Content,
            Timestamp = DateTime.UtcNow
        };

        // Note: Usage count is automatically incremented by ISystemPromptService
        // when the prompt is selected via SetCurrentPromptAsync (see v0.2.4b)
    }

    // Yield all conversation messages from the service
    foreach (var message in _conversationService.GetMessages())
    {
        yield return message;
    }
}
```

#### New Event Handler

```csharp
/// <summary>
/// Handles system prompt changes from the ISystemPromptService.
/// </summary>
private void OnCurrentPromptChanged(object? sender, CurrentPromptChangedEventArgs e)
{
    _dispatcher.InvokeAsync(() =>
    {
        if (e.NewPrompt != null)
        {
            ShowSystemPromptMessage = true;
            SystemPromptName = e.NewPrompt.Name;
            SystemPromptContent = e.NewPrompt.Content;
        }
        else
        {
            ShowSystemPromptMessage = false;
            SystemPromptName = null;
            SystemPromptContent = null;
        }
    });
}
```

#### Disposal Updates

```csharp
public void Dispose()
{
    // ... existing cleanup ...

    // v0.2.4e: Unsubscribe from system prompt service events
    _systemPromptService.CurrentPromptChanged -= OnCurrentPromptChanged;
}
```

### 4. MainWindowViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/MainWindowViewModel.cs`
**Changes:** Added editor command and window reference (~80 lines)

#### New Dependencies

| Dependency | Purpose |
|------------|---------|
| `ISystemPromptService` | Pass to editor ViewModel |
| `IDispatcher` | Pass to editor ViewModel |

#### New Fields

```csharp
// Reference to the main window for dialog display (v0.2.4e)
private Window? _mainWindow;
```

#### New Methods

##### SetMainWindow

```csharp
/// <summary>
/// Sets the main window reference for dialog display.
/// </summary>
public void SetMainWindow(Window window)
{
    _mainWindow = window ?? throw new ArgumentNullException(nameof(window));
    _logger?.LogDebug("[INFO] Main window reference set");
}
```

##### OpenSystemPromptEditorAsync

```csharp
/// <summary>
/// Opens the System Prompt Editor window as a modal dialog.
/// </summary>
[RelayCommand]
private async Task OpenSystemPromptEditorAsync()
{
    if (_mainWindow == null)
    {
        _logger?.LogWarning("[WARN] Main window reference not set");
        return;
    }

    var editorViewModel = new SystemPromptEditorViewModel(
        _systemPromptService,
        _dispatcher,
        _logger != null
            ? Microsoft.Extensions.Logging.LoggerFactory.Create(b => { }).CreateLogger<SystemPromptEditorViewModel>()
            : null);

    var editorWindow = new SystemPromptEditorWindow
    {
        DataContext = editorViewModel
    };

    await editorWindow.ShowDialog(_mainWindow);
}
```

#### InitializeAsync Updates

```csharp
public async Task InitializeAsync()
{
    // ... existing initialization ...

    // v0.2.4e: Initialize system prompt selector
    await ChatViewModel.SystemPromptSelectorViewModel.InitializeAsync();
}
```

### 5. Dark.axaml

**Path:** `src/AIntern.Desktop/Themes/Dark.axaml`
**Changes:** Added system prompt background color (+12 lines)

#### New Color Resource

```xml
<!-- ============================================================== -->
<!-- System Prompt Selector Colors (v0.2.4e)                        -->
<!-- Colors for the chat header system prompt display.              -->
<!-- ============================================================== -->

<!-- System Prompt Background - Used for the collapsible system prompt
     content display in the chat header. Subtle differentiation from
     the main chat background to indicate system context.
     Usage: <Border Background="{DynamicResource SystemPromptBackgroundColor}"> -->
<SolidColorBrush x:Key="SystemPromptBackgroundColor" Color="#1A2D3D" />
```

## Logging Specifications

All code files use exhaustive logging with standard markers:

| Marker | Level | Usage |
|--------|-------|-------|
| `[ENTER]` | Debug | Method entry with parameters |
| `[INFO]` | Debug/Info | Significant state changes or actions |
| `[SKIP]` | Debug | No-op conditions (early returns) |
| `[EXIT]` | Debug | Method completion with duration |
| `[ERROR]` | Error | Exception handling |
| `[INIT]` | Debug | Constructor completion |
| `[EVENT]` | Debug | Event handler invocation |

### Example Log Output

```
[INIT] ChatViewModel construction started
[INIT] Subscribed to ISystemPromptService.CurrentPromptChanged event
[ENTER] InitializeSystemPromptDisplay
[INFO] Initialized system prompt display - Name: Default Assistant, ContentLength: 127
[EXIT] InitializeSystemPromptDisplay - 2ms
[INIT] ChatViewModel construction completed - 15ms

[ENTER] BuildContextWithSystemPrompt
[INFO] Prepending system prompt - Name: Default Assistant, FormattedLength: 127
[EXIT] BuildContextWithSystemPrompt - 1ms

[ENTER] OnCurrentPromptChanged - NewPrompt: The Senior Intern, PreviousPrompt: Default Assistant
[INFO] System prompt display updated - Name: The Senior Intern
[EXIT] OnCurrentPromptChanged - 3ms
```

## Event Flow Summary

### Prompt Selection Change

```
User selects prompt in ComboBox
    |
    v
SystemPromptSelectorViewModel.SelectedPrompt setter
    |
    v
ISystemPromptService.SetCurrentPromptAsync()
    |
    v
Service raises CurrentPromptChanged event
    |
    v
ChatViewModel.OnCurrentPromptChanged handler
    |
    v
Update UI properties (ShowSystemPromptMessage, Name, Content)
```

### Edit Button Click

```
User clicks Edit button
    |
    v
SystemPromptSelector.OnEditButtonClick
    |
    v
RoutedEvent bubbles up
    |
    v
ChatView.OnPromptSelectorEditButtonClick
    |
    v
MainWindowViewModel.OpenSystemPromptEditorCommand
    |
    v
SystemPromptEditorWindow.ShowDialog()
```

### Message Send with System Prompt

```
User types message and presses Enter
    |
    v
ChatViewModel.SendMessageAsync()
    |
    v
BuildContextWithSystemPrompt()
    |
    v
[System Message] + [Conversation Messages]
    |
    v
ILlmService.GenerateStreamingAsync(context)
```

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | System prompt selector appears in chat header | Implemented |
| AC-2 | Dropdown shows all available prompts with star for default | Implemented |
| AC-3 | Selecting a prompt updates the service state | Implemented |
| AC-4 | Expander shows/hides based on prompt selection | Implemented |
| AC-5 | Expander displays prompt name and content | Implemented |
| AC-6 | Edit button opens SystemPromptEditorWindow | Implemented |
| AC-7 | System prompt is prepended to LLM context | Implemented |
| AC-8 | Event subscriptions cleaned up on dispose | Implemented |
| AC-9 | Build passes with 0 errors, 0 warnings | Verified |

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Desktop/Views/SystemPromptSelector.axaml` | Created | 139 |
| `src/AIntern.Desktop/Views/SystemPromptSelector.axaml.cs` | Created | 183 |
| `src/AIntern.Desktop/Views/ChatView.axaml` | Modified | +50 |
| `src/AIntern.Desktop/Views/ChatView.axaml.cs` | Modified | +60 |
| `src/AIntern.Desktop/ViewModels/ChatViewModel.cs` | Modified | +150 |
| `src/AIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Modified | +80 |
| `src/AIntern.Desktop/Themes/Dark.axaml` | Modified | +12 |
| **Total** | | ~674 |

## Dependencies

### Service Dependencies

| Service | Usage |
|---------|-------|
| `ISystemPromptService` | Prompt access, formatting, usage tracking |
| `IDispatcher` | UI thread marshaling for event handlers |

### ViewModel Dependencies

| ViewModel | Provider | Lifetime |
|-----------|----------|----------|
| `SystemPromptSelectorViewModel` | DI Container | Singleton |
| `SystemPromptEditorViewModel` | Constructor | Transient (per window) |

## Next Steps (v0.2.4f+)

| Version | Description |
|---------|-------------|
| v0.2.4f | Integration testing and polish |
| v0.2.5 | System prompt variable substitution |

## Related Documentation

- [v0.2.4-system-prompt-editor.md](../design/v0.2.x/v0.2.4-system-prompt-editor.md) - Feature overview
- [v0.2.4a.md](v0.2.4a.md) - Models & Repository changelog
- [v0.2.4b.md](v0.2.4b.md) - System Prompt Service changelog
- [v0.2.4c.md](v0.2.4c.md) - Editor ViewModels changelog
- [v0.2.4d.md](v0.2.4d.md) - Editor Window UI changelog
