# v0.2.3b Changelog - Settings Service

**Release Date:** 2026-01-13
**Version:** v0.2.3b
**Status:** Complete

---

## Overview

This release creates the `IInferenceSettingsService` interface and implementation for managing live inference settings with preset support, event-driven notifications, and persistence. The service acts as the single source of truth for inference parameters at runtime.

**Building on:** v0.2.3a (Models & Repository)
**Design Reference:** [v0.2.3b-settings-service.md](../design/v0.2.x/v0.2.3b-settings-service.md)

---

## New Files

### InferenceSettingsChangedEventArgs.cs

**Path:** `src/AIntern.Core/Events/InferenceSettingsChangedEventArgs.cs`

Event arguments raised when inference settings are modified (~160 lines).

**Classes:**
```csharp
public sealed class InferenceSettingsChangedEventArgs : EventArgs
{
    public required InferenceSettings NewSettings { get; init; }
    public required InferenceSettingsChangeType ChangeType { get; init; }
    public string? ChangedParameter { get; init; }
}

public enum InferenceSettingsChangeType
{
    ParameterChanged,    // Single parameter via Update method
    PresetApplied,       // Preset loaded via ApplyPresetAsync
    ResetToDefaults,     // Reset via ResetToDefaultsAsync
    AllChanged           // Multiple parameters via UpdateAll
}
```

**Usage:**
```csharp
_settingsService.SettingsChanged += (sender, e) =>
{
    switch (e.ChangeType)
    {
        case InferenceSettingsChangeType.ParameterChanged:
            Console.WriteLine($"{e.ChangedParameter} changed to {e.NewSettings.Temperature}");
            break;
        case InferenceSettingsChangeType.PresetApplied:
            Console.WriteLine("Preset applied - all settings updated");
            break;
    }
};
```

---

### PresetChangedEventArgs.cs

**Path:** `src/AIntern.Core/Events/PresetChangedEventArgs.cs`

Event arguments raised when preset operations occur (~165 lines).

**Classes:**
```csharp
public sealed class PresetChangedEventArgs : EventArgs
{
    public InferencePreset? NewPreset { get; init; }
    public InferencePreset? PreviousPreset { get; init; }
    public required PresetChangeType ChangeType { get; init; }
}

public enum PresetChangeType
{
    Applied,          // Preset activated via ApplyPresetAsync
    Created,          // New preset via SaveAsPresetAsync
    Updated,          // Preset modified via UpdatePresetAsync
    Deleted,          // Preset removed via DeletePresetAsync
    DefaultChanged    // Default preset changed via SetDefaultPresetAsync
}
```

**Event Args by Change Type:**
| ChangeType | NewPreset | PreviousPreset |
|------------|-----------|----------------|
| Applied | Active preset | Previous active |
| Created | New preset | null |
| Updated | Updated preset | Previous state |
| Deleted | null | Deleted preset |
| DefaultChanged | New default | Previous default |

---

### IInferenceSettingsService.cs

**Path:** `src/AIntern.Core/Interfaces/IInferenceSettingsService.cs`

Interface for managing inference settings with preset support and event notification (~350 lines).

**Properties:**
```csharp
public interface IInferenceSettingsService
{
    // Current live settings - authoritative source for inference operations
    InferenceSettings CurrentSettings { get; }

    // Active preset (null = custom settings after modification)
    InferencePreset? ActivePreset { get; }

    // True if settings differ from last-applied preset
    bool HasUnsavedChanges { get; }
}
```

**Parameter Updates (7 methods + UpdateAll):**
```csharp
// Each method clamps to valid range and fires SettingsChanged if value changed
void UpdateTemperature(float value);      // 0.0-2.0
void UpdateTopP(float value);             // 0.0-1.0
void UpdateTopK(int value);               // 0-100
void UpdateRepetitionPenalty(float value); // 1.0-2.0
void UpdateMaxTokens(int value);          // 64-8192
void UpdateContextSize(uint value);       // 512-32768
void UpdateSeed(int value);               // -1 or 0+
void UpdateAll(InferenceSettings settings); // All at once
```

**Preset Operations (7 async methods):**
```csharp
Task<IReadOnlyList<InferencePreset>> GetPresetsAsync(CancellationToken ct = default);
Task ApplyPresetAsync(Guid presetId, CancellationToken ct = default);
Task<InferencePreset> SaveAsPresetAsync(string name, string? description = null,
    string? category = null, CancellationToken ct = default);
Task UpdatePresetAsync(Guid presetId, CancellationToken ct = default);
Task DeletePresetAsync(Guid presetId, CancellationToken ct = default);
Task ResetToDefaultsAsync(CancellationToken ct = default);
Task SetDefaultPresetAsync(Guid presetId, CancellationToken ct = default);
Task InitializeAsync(CancellationToken ct = default);
```

**Events:**
```csharp
event EventHandler<InferenceSettingsChangedEventArgs>? SettingsChanged;
event EventHandler<PresetChangedEventArgs>? PresetChanged;
```

---

### InferenceSettingsService.cs

**Path:** `src/AIntern.Services/InferenceSettingsService.cs`

Full implementation of `IInferenceSettingsService` with exhaustive logging (~750 lines).

**Dependencies:**
```csharp
public InferenceSettingsService(
    IInferencePresetRepository presetRepository,  // Preset CRUD operations
    ISettingsService settingsService,              // ActivePresetId persistence
    ILogger<InferenceSettingsService> logger)      // Diagnostic output
```

**Internal State:**
```csharp
private InferenceSettings _currentSettings = new();  // Live settings
private InferencePreset? _activePreset;              // Current preset (null = custom)
private InferenceSettings? _presetSnapshot;          // For change detection
private readonly SemaphoreSlim _lock = new(1, 1);    // Thread safety
private bool _isInitialized;                         // Double-init prevention
private const float FloatEpsilon = 0.001f;           // Float comparison tolerance
```

**Parameter Update Pattern:**
```csharp
public void UpdateTemperature(float value)
{
    var stopwatch = Stopwatch.StartNew();
    _logger.LogDebug("[ENTER] UpdateTemperature - Value: {Value}", value);

    // Clamp to valid range
    var clamped = Math.Clamp(value,
        ParameterConstants.Temperature.Min,
        ParameterConstants.Temperature.Max);

    if (Math.Abs(clamped - value) > FloatEpsilon)
    {
        _logger.LogDebug("[INFO] Temperature clamped: {Original} -> {Clamped}", value, clamped);
    }

    // Check if value actually changed
    if (Math.Abs(_currentSettings.Temperature - clamped) < FloatEpsilon)
    {
        stopwatch.Stop();
        _logger.LogDebug("[SKIP] Temperature unchanged: {Value}, Duration: {Ms}ms",
            clamped, stopwatch.ElapsedMilliseconds);
        return;
    }

    var oldValue = _currentSettings.Temperature;
    _currentSettings.Temperature = clamped;

    stopwatch.Stop();
    _logger.LogDebug(
        "[EXIT] UpdateTemperature - OldValue: {Old}, NewValue: {New}, Duration: {Ms}ms",
        oldValue, clamped, stopwatch.ElapsedMilliseconds);

    OnSettingsChanged(InferenceSettingsChangeType.ParameterChanged,
        nameof(InferenceSettings.Temperature));
}
```

**ApplyPresetAsync Pattern:**
```csharp
public async Task ApplyPresetAsync(Guid presetId, CancellationToken cancellationToken = default)
{
    var stopwatch = Stopwatch.StartNew();
    _logger.LogDebug("[ENTER] ApplyPresetAsync - PresetId: {PresetId}", presetId);

    await _lock.WaitAsync(cancellationToken);
    try
    {
        // Load preset from repository
        var entity = await _presetRepository.GetByIdAsync(presetId, cancellationToken);
        if (entity == null)
        {
            _logger.LogWarning("[EXIT] ApplyPresetAsync - Preset not found: {PresetId}", presetId);
            throw new InvalidOperationException($"Preset not found: {presetId}");
        }

        var preset = InferencePreset.FromEntity(entity);
        var previousPreset = _activePreset;

        // Clone settings from preset
        _currentSettings = preset.Options.Clone();
        _activePreset = preset;
        _presetSnapshot = preset.Options.Clone();

        // Persist active preset ID to settings.json
        var appSettings = _settingsService.CurrentSettings;
        appSettings.ActivePresetId = presetId;
        await _settingsService.SaveSettingsAsync(appSettings);

        // Increment usage count for analytics
        await _presetRepository.IncrementUsageAsync(presetId, cancellationToken);

        stopwatch.Stop();
        _logger.LogInformation(
            "[EXIT] ApplyPresetAsync - Applied '{PresetName}', Duration: {Ms}ms",
            preset.Name, stopwatch.ElapsedMilliseconds);

        // Fire events
        OnSettingsChanged(InferenceSettingsChangeType.PresetApplied);
        OnPresetChanged(preset, previousPreset, PresetChangeType.Applied);
    }
    finally
    {
        _lock.Release();
    }
}
```

**HasUnsavedChanges Logic:**
```csharp
public bool HasUnsavedChanges
{
    get
    {
        // No changes possible if no preset is active or no snapshot exists
        if (_activePreset == null || _presetSnapshot == null)
        {
            return false;
        }
        return !SettingsEqual(_currentSettings, _presetSnapshot);
    }
}

private static bool SettingsEqual(InferenceSettings a, InferenceSettings b)
{
    return Math.Abs(a.Temperature - b.Temperature) < FloatEpsilon &&
           Math.Abs(a.TopP - b.TopP) < FloatEpsilon &&
           a.TopK == b.TopK &&
           Math.Abs(a.RepetitionPenalty - b.RepetitionPenalty) < FloatEpsilon &&
           a.MaxTokens == b.MaxTokens &&
           a.ContextSize == b.ContextSize &&
           a.Seed == b.Seed;
}
```

**InitializeAsync Flow:**
```
┌─────────────────────────────────────────────────────────────────────┐
│                        InitializeAsync                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. Check _isInitialized flag (prevent double init)                  │
│     │                                                                │
│  2. Acquire _lock (thread safety)                                    │
│     │                                                                │
│  3. Load settings from ISettingsService                              │
│     │                                                                │
│  4. Check ActivePresetId                                             │
│     ├── Has Value ──► Load preset from repository                    │
│     │                 ├── Found ──► Apply preset, return             │
│     │                 └── Not Found ──► Continue to fallback         │
│     │                                                                │
│     └── Null ──► Continue to fallback                                │
│                                                                      │
│  5. Fallback: Load default preset                                    │
│     ├── GetDefaultAsync() ──► Use if found                           │
│     └── GetByIdAsync(BalancedPresetId) ──► Final fallback            │
│                                                                      │
│  6. Set _isInitialized = true                                        │
│     │                                                                │
│  7. Release _lock                                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Modified Files

### AppSettings.cs

**Path:** `src/AIntern.Core/Models/AppSettings.cs`

Added `ActivePresetId` property for persistence (~20 lines added).

**New Property:**
```csharp
#region Inference Settings

// ... existing properties ...

/// <summary>
/// Gets or sets the ID of the last active inference preset.
/// </summary>
/// <value>
/// The GUID of the active preset, or <c>null</c> if using default settings.
/// </value>
/// <remarks>
/// <para>
/// Persisted to settings.json to restore the user's last-used preset on startup.
/// Set by <see cref="Interfaces.IInferenceSettingsService.ApplyPresetAsync"/> when
/// a preset is applied.
/// </para>
/// <para>
/// If this is null or the referenced preset no longer exists,
/// <see cref="Interfaces.IInferenceSettingsService.InitializeAsync"/> falls back
/// to the default preset (Balanced).
/// </para>
/// </remarks>
public Guid? ActivePresetId { get; set; }

#endregion
```

---

### ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`

Added DI registration for `IInferenceSettingsService` (~15 lines added).

**New Registration:**
```csharp
// Inference Settings: manages live inference parameters with preset support.
// Uses a factory to resolve scoped repository dependencies.
// The service coordinates between repository (presets), settings service
// (persistence), and consumers (LlmService, ViewModels).
services.AddSingleton<IInferenceSettingsService>(sp =>
{
    // Create a scope to resolve scoped services (repositories).
    var scope = sp.CreateScope();
    return new InferenceSettingsService(
        scope.ServiceProvider.GetRequiredService<IInferencePresetRepository>(),
        sp.GetRequiredService<ISettingsService>(),
        sp.GetRequiredService<ILogger<InferenceSettingsService>>());
});
```

**Why Singleton with Scoped Repository:**
- The service needs to maintain state across the application lifetime
- Repository is scoped because it depends on DbContext
- Factory pattern creates a scope to resolve the scoped repository
- The repository is passed to the singleton constructor

---

## Architecture

```
┌──────────────────────────────────────────────────────────────────────┐
│                      v0.2.3b Architecture                             │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  AIntern.Core/Events/                                                 │
│  ├── InferenceSettingsChangedEventArgs.cs                             │
│  │   ├── NewSettings: InferenceSettings (cloned)                      │
│  │   ├── ChangeType: InferenceSettingsChangeType                      │
│  │   └── ChangedParameter: string? (for ParameterChanged)             │
│  │                                                                    │
│  └── PresetChangedEventArgs.cs                                        │
│      ├── NewPreset: InferencePreset?                                  │
│      ├── PreviousPreset: InferencePreset?                             │
│      └── ChangeType: PresetChangeType                                 │
│                                                                       │
│  AIntern.Core/Interfaces/                                             │
│  └── IInferenceSettingsService.cs                                     │
│      ├── CurrentSettings: InferenceSettings                           │
│      ├── ActivePreset: InferencePreset?                               │
│      ├── HasUnsavedChanges: bool                                      │
│      ├── Parameter Updates (7 methods + UpdateAll)                    │
│      ├── Preset Operations (7 async methods)                          │
│      └── Events (SettingsChanged, PresetChanged)                      │
│                                                                       │
│  AIntern.Services/                                                    │
│  └── InferenceSettingsService.cs                                      │
│      ├── Dependencies: IInferencePresetRepository, ISettingsService   │
│      ├── State: _currentSettings, _activePreset, _presetSnapshot      │
│      ├── Thread Safety: SemaphoreSlim for async operations            │
│      ├── Clamping: All updates use ParameterConstants                 │
│      └── Change Detection: Float epsilon comparison (0.001f)          │
│                                                                       │
│  AIntern.Core/Models/                                                 │
│  └── AppSettings.cs                                                   │
│      └── + ActivePresetId: Guid? (for persistence)                    │
│                                                                       │
│  AIntern.Desktop/Extensions/                                          │
│  └── ServiceCollectionExtensions.cs                                   │
│      └── + IInferenceSettingsService registration                     │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Thread Safety Model

| Operation | Protection | Notes |
|-----------|------------|-------|
| Parameter Updates | None (lock-free) | Synchronous, single-threaded UI |
| Preset Operations | SemaphoreSlim | Async database operations |
| Event Firing | Cloned data | NewSettings is always a clone |
| HasUnsavedChanges | Read-only | Compares against snapshot |
| InitializeAsync | Double-check locking | Prevents double initialization |

**SemaphoreSlim Usage:**
```csharp
await _lock.WaitAsync(cancellationToken);
try
{
    // Protected database operations
}
finally
{
    _lock.Release();
}
```

---

## Logging Specifications

All code follows exhaustive logging patterns:

| Level | Format | Usage |
|-------|--------|-------|
| Debug | `[ENTER] MethodName - Param: {Value}` | Method entry |
| Debug | `[INFO] Description` | State changes |
| Debug | `[SKIP] Reason` | No-op conditions |
| Debug | `[EXIT] MethodName - Result, Duration: {Ms}ms` | Method exit |
| Debug | `[EVENT] EventName - Type: {Type}` | Event firing |
| Information | Description | Significant operations |
| Warning | Description | Recoverable issues |
| Error | Description: {Message} | Failures |

**Example Log Output:**
```
[ENTER] UpdateTemperature - Value: 1.5
[EXIT] UpdateTemperature - OldValue: 0.7, NewValue: 1.5, Duration: 0ms
[EVENT] SettingsChanged - Type: ParameterChanged, Parameter: Temperature

[ENTER] ApplyPresetAsync - PresetId: 00000001-0000-0000-0000-000000000001
[INFO] ApplyPresetAsync - Loading preset 'Precise' with Temp=0.2, TopP=0.8, TopK=20
[EXIT] ApplyPresetAsync - Applied 'Precise', Duration: 45ms
[EVENT] SettingsChanged - Type: PresetApplied, Parameter: (all)
[EVENT] PresetChanged - Type: Applied, New: Precise, Previous: Balanced

[ENTER] InitializeAsync
[INFO] InitializeAsync - ActivePresetId from settings: 00000001-0000-0000-0000-000000000002
[INFO] InitializeAsync - Loading saved preset 'Balanced'
[EXIT] InitializeAsync - Loaded preset 'Balanced', Duration: 32ms
```

---

## Event Flow Diagrams

### Parameter Update Event Flow
```
User Input ──► UpdateTemperature(1.5f)
                    │
                    ▼
              Clamp Value
                    │
                    ▼
              Value Changed? ──No──► [SKIP] Return
                    │
                   Yes
                    ▼
              Update _currentSettings
                    │
                    ▼
              Fire SettingsChanged Event
                    │
                    ▼
              Subscribers Receive:
              ├── NewSettings (cloned)
              ├── ChangeType = ParameterChanged
              └── ChangedParameter = "Temperature"
```

### Preset Apply Event Flow
```
User Selects Preset ──► ApplyPresetAsync(presetId)
                              │
                              ▼
                        Acquire Lock
                              │
                              ▼
                        Load from Repository
                              │
                              ▼
                        Clone Settings
                              │
                              ▼
                        Persist ActivePresetId
                              │
                              ▼
                        Increment UsageCount
                              │
                              ▼
                        Release Lock
                              │
                              ▼
                        Fire Events:
                        ├── SettingsChanged (PresetApplied)
                        └── PresetChanged (Applied)
```

---

## API Reference

### IInferenceSettingsService

| Member | Type | Description |
|--------|------|-------------|
| `CurrentSettings` | Property | Live inference settings |
| `ActivePreset` | Property | Currently active preset (null = custom) |
| `HasUnsavedChanges` | Property | True if modified since preset applied |
| `UpdateTemperature` | Method | Update with clamping (0.0-2.0) |
| `UpdateTopP` | Method | Update with clamping (0.0-1.0) |
| `UpdateTopK` | Method | Update with clamping (0-100) |
| `UpdateRepetitionPenalty` | Method | Update with clamping (1.0-2.0) |
| `UpdateMaxTokens` | Method | Update with clamping (64-8192) |
| `UpdateContextSize` | Method | Update with clamping (512-32768) |
| `UpdateSeed` | Method | Update with clamping (-1 minimum) |
| `UpdateAll` | Method | Update all parameters at once |
| `GetPresetsAsync` | Method | Get all presets |
| `ApplyPresetAsync` | Method | Load and apply a preset |
| `SaveAsPresetAsync` | Method | Save current settings as new preset |
| `UpdatePresetAsync` | Method | Update existing preset with current settings |
| `DeletePresetAsync` | Method | Delete a user-created preset |
| `ResetToDefaultsAsync` | Method | Reset to default preset |
| `SetDefaultPresetAsync` | Method | Set a preset as the new default |
| `InitializeAsync` | Method | Initialize with last-used preset |
| `SettingsChanged` | Event | Fired when any setting changes |
| `PresetChanged` | Event | Fired on preset operations |

---

## Exception Handling

| Method | Exception | Condition |
|--------|-----------|-----------|
| `ApplyPresetAsync` | `InvalidOperationException` | Preset not found |
| `SaveAsPresetAsync` | `InvalidOperationException` | Name already exists |
| `UpdatePresetAsync` | `InvalidOperationException` | Preset not found or is built-in |
| `DeletePresetAsync` | `InvalidOperationException` | Preset not found or is built-in |
| `SetDefaultPresetAsync` | `InvalidOperationException` | Preset not found |
| `ResetToDefaultsAsync` | `InvalidOperationException` | No presets available |

**Built-in Preset Protection:**
```csharp
// Cannot update built-in presets
if (entity.IsBuiltIn)
{
    _logger.LogWarning("[EXIT] UpdatePresetAsync - Cannot update built-in preset: {Name}", entity.Name);
    throw new InvalidOperationException($"Cannot update built-in preset: {entity.Name}");
}

// Cannot delete built-in presets
if (entity.IsBuiltIn)
{
    _logger.LogWarning("[EXIT] DeletePresetAsync - Cannot delete built-in preset: {Name}", entity.Name);
    throw new InvalidOperationException($"Cannot delete built-in preset: {entity.Name}");
}
```

---

## Verification Checklist

| Check | Result |
|-------|--------|
| Build | 0 errors, 0 warnings |
| InferenceSettingsChangedEventArgs | Created with all properties |
| PresetChangedEventArgs | Created with all properties |
| IInferenceSettingsService | All 8 update methods defined |
| IInferenceSettingsService | All 8 preset operations defined |
| IInferenceSettingsService | Both events defined |
| InferenceSettingsService | Implements IAsyncDisposable |
| InferenceSettingsService | All methods have exhaustive logging |
| Parameter clamping | Uses ParameterConstants for all 7 parameters |
| Change detection | Uses FloatEpsilon (0.001f) for floats |
| Thread safety | SemaphoreSlim for async operations |
| HasUnsavedChanges | Correctly compares against snapshot |
| AppSettings.ActivePresetId | Property added with documentation |
| DI registration | Singleton with scoped repository factory |
| InitializeAsync | Loads from settings.json |
| InitializeAsync | Falls back to default preset |

---

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Core/Events/InferenceSettingsChangedEventArgs.cs` | Created | ~160 |
| `src/AIntern.Core/Events/PresetChangedEventArgs.cs` | Created | ~165 |
| `src/AIntern.Core/Interfaces/IInferenceSettingsService.cs` | Created | ~350 |
| `src/AIntern.Services/InferenceSettingsService.cs` | Created | ~750 |
| `src/AIntern.Core/Models/AppSettings.cs` | Modified | +20 |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Modified | +15 |
| **Total** | | ~1,460 |

---

## Dependencies

- **Microsoft.Extensions.Logging** - ILogger for diagnostic output
- **System.Diagnostics** - Stopwatch for timing
- **AIntern.Core** - ParameterConstants, InferenceSettings, InferencePreset
- **AIntern.Data** - IInferencePresetRepository

---

## Usage Examples

### Basic Initialization
```csharp
// In App.xaml.cs or startup
var settingsService = services.GetRequiredService<IInferenceSettingsService>();
await settingsService.InitializeAsync();
```

### Subscribing to Changes
```csharp
_settingsService.SettingsChanged += (sender, e) =>
{
    // Update UI with new settings
    TemperatureSlider.Value = e.NewSettings.Temperature;
    TopPSlider.Value = e.NewSettings.TopP;
};

_settingsService.PresetChanged += (sender, e) =>
{
    if (e.ChangeType == PresetChangeType.Applied)
    {
        // Update preset selector
        PresetSelector.SelectedItem = e.NewPreset;
    }
};
```

### Applying a Preset
```csharp
// Apply the Precise preset
await _settingsService.ApplyPresetAsync(InferencePreset.PrecisePresetId);

// Current settings now match Precise preset
// HasUnsavedChanges is false
```

### Modifying Parameters
```csharp
// Modify temperature (fires SettingsChanged)
_settingsService.UpdateTemperature(1.5f);

// HasUnsavedChanges is now true (if preset was active)
```

### Saving Custom Preset
```csharp
// Save current settings as new preset
var newPreset = await _settingsService.SaveAsPresetAsync(
    "My Custom Settings",
    "Optimized for creative writing",
    "Creative");

// newPreset.Id can be used to apply it later
await _settingsService.ApplyPresetAsync(newPreset.Id);
```

---

## Next Steps

- **v0.2.3c**: Create InferenceSettingsViewModel with bindable properties
- **v0.2.3d**: Build ParameterSlider control and PresetSelector
- **v0.2.3e**: Wire UI to service layer with live preview
