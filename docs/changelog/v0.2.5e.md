# v0.2.5e - Search UI

**Release Date:** 2026-01-14
**Type:** Feature (UI Layer)
**Status:** Complete

## Overview

This release implements the Search UI components for the application. The feature provides a spotlight-style search dialog (Ctrl+K) with debounced search, filter tabs, keyboard navigation, and grouped results.

**Building on:** v0.2.5d (Migration Service)
**Design Reference:** [v0.2.5e-search-ui.md](../design/v0.2.x/v0.2.5e-search-ui.md)

## Architecture

```
+------------------------------------------------------------------+
|                        v0.2.5e Search UI                          |
+------------------------------------------------------------------+
|                                                                    |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      SearchViewModel                         │  |
|  │  Properties:                                                 │  |
|  │  ├── Query (string) - with 300ms debounce                    │  |
|  │  ├── IsSearching (bool)                                      │  |
|  │  ├── SearchStatus (string)                                   │  |
|  │  ├── SelectedResult (SearchResult?)                          │  |
|  │  ├── FilterType (SearchResultType?)                          │  |
|  │  ├── ConversationResults (ObservableCollection)              │  |
|  │  └── MessageResults (ObservableCollection)                   │  |
|  │                                                              │  |
|  │  Commands:                                                   │  |
|  │  ├── SetFilterCommand                                        │  |
|  │  ├── NavigateUpCommand                                       │  |
|  │  ├── NavigateDownCommand                                     │  |
|  │  ├── SelectResultCommand                                     │  |
|  │  └── CloseCommand                                            │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                              │                                     |
|                              ▼                                     |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      SearchDialog                            │  |
|  │  Layout (4-row Grid):                                        │  |
|  │  ├── Row 0: Search input (TextBox with icon)                 │  |
|  │  ├── Row 1: Filter tabs (All | Conversations | Messages)     │  |
|  │  ├── Row 2: Results (ScrollViewer with grouped items)        │  |
|  │  └── Row 3: Status bar (result count + timing)               │  |
|  │                                                              │  |
|  │  Keyboard:                                                   │  |
|  │  ├── Up/Down - Navigate results                              │  |
|  │  ├── Enter - Select result                                   │  |
|  │  └── Escape - Close dialog                                   │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                              │                                     |
|                              ▼                                     |
|  ┌──────────────────────────────────────────────────────────────┐  |
|  │                      Integration                             │  |
|  │  MainWindow:                                                 │  |
|  │  ├── Ctrl+K keybinding → OpenSearchCommand                   │  |
|  │  └── MainWindowViewModel.OpenSearchAsync()                   │  |
|  └──────────────────────────────────────────────────────────────┘  |
|                                                                    |
+------------------------------------------------------------------+
```

## Key Features

### 1. Debounced Search

The search input implements a 300ms debounce delay:
- Timer starts when user types
- Previous timer cancelled if new input arrives
- Search executes after 300ms of no changes
- Previous search cancelled when new search starts

### 2. Search Cancellation

The ViewModel maintains a `CancellationTokenSource` that:
- Cancels previous search when new query entered
- Prevents stale results from overwriting newer results
- Properly cleaned up on dispose

### 3. Filter Tabs

Three filter options are available:
- **All**: Shows both conversations and messages
- **Conversations**: Only conversation title matches
- **Messages**: Only message content matches

Changing the filter immediately re-executes the search.

### 4. Keyboard Navigation

Full keyboard support for efficient search:
- **Up Arrow**: Move selection up, wraps to bottom
- **Down Arrow**: Move selection down, wraps to top
- **Enter**: Select current result and close dialog
- **Escape**: Close dialog without selection

### 5. Grouped Results

Results are displayed in two groups:
- Conversations section (from FTS5 conversation search)
- Messages section (from FTS5 message search)

Navigation moves through both groups seamlessly.

### 6. Spotlight-Style Dialog

The search dialog uses modern spotlight/command palette styling:
- Borderless window (SystemDecorations: BorderOnly)
- Fixed size (600x500)
- Centered over owner window
- Semi-transparent background overlay

## Files Created

### 1. SearchViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/SearchViewModel.cs`
**Lines:** ~550

ViewModel for search dialog with debounced search.

#### Properties

| Property | Type | Description |
|----------|------|-------------|
| `Query` | `string` | Search query text (triggers debounce) |
| `IsSearching` | `bool` | True during search operation |
| `SearchStatus` | `string` | Status text (count + timing) |
| `SelectedResult` | `SearchResult?` | Currently selected result |
| `FilterType` | `SearchResultType?` | Active filter (null = All) |
| `DialogResult` | `SearchResult?` | Result when dialog closes |
| `ShouldClose` | `bool` | Triggers dialog close |
| `ConversationResults` | `ObservableCollection<SearchResult>` | Conversation matches |
| `MessageResults` | `ObservableCollection<SearchResult>` | Message matches |

#### Commands

| Command | Description |
|---------|-------------|
| `SetFilterCommand` | Sets filter type (All/Conversation/Message) |
| `NavigateUpCommand` | Move selection up with wrap-around |
| `NavigateDownCommand` | Move selection down with wrap-around |
| `SelectResultCommand` | Select current result and close |
| `CloseCommand` | Close without selection |

### 2. SearchDialog.axaml

**Path:** `src/AIntern.Desktop/Views/SearchDialog.axaml`
**Lines:** ~280

XAML layout for spotlight-style search dialog.

#### Window Properties

| Property | Value |
|----------|-------|
| Width | 600 |
| Height | 500 |
| WindowStartupLocation | CenterOwner |
| SystemDecorations | BorderOnly |
| CanResize | False |

#### Layout Structure

```
Grid (4 rows)
├── Row 0: Search Input Border
│   └── Grid (Icon | TextBox | ProgressRing)
├── Row 1: Filter Tabs
│   └── StackPanel (All | Conversations | Messages buttons)
├── Row 2: Results Area
│   └── ScrollViewer
│       └── StackPanel
│           ├── Conversations Header + ItemsControl
│           └── Messages Header + ItemsControl
└── Row 3: Status Bar
    └── TextBlock (SearchStatus)
```

### 3. SearchDialog.axaml.cs

**Path:** `src/AIntern.Desktop/Views/SearchDialog.axaml.cs`
**Lines:** ~230

Code-behind for SearchDialog with lifecycle management.

#### Key Methods

| Method | Description |
|--------|-------------|
| `OnOpened` | Focuses search input, subscribes to ShouldClose |
| `OnClosed` | Unsubscribes from events, disposes ViewModel |
| `OnViewModelPropertyChanged` | Closes dialog when ShouldClose becomes true |
| `Dispose` | Cleans up event subscriptions |

### 4. SearchViewModelTests.cs

**Path:** `tests/AIntern.Desktop.Tests/ViewModels/SearchViewModelTests.cs`
**Lines:** ~400

Comprehensive unit tests for SearchViewModel.

#### Test Categories

| Category | Test Count | Description |
|----------|------------|-------------|
| Constructor | 3 | Null checks, valid initialization |
| SetFilter | 5 | All filter value scenarios |
| Navigation (Empty) | 2 | Up/Down with no results |
| Navigation (Results) | 8 | Up/Down, wrap-around, cross-group |
| SelectResult | 3 | Select, close, null handling |
| Close | 2 | Close behavior |
| Query Changed | 2 | Empty/whitespace clears results |
| Dispose | 2 | Multiple dispose, cleanup |
| FilterType | 1 | Empty query doesn't trigger search |
| Collections | 3 | Initialization, adding results |
| **Total** | **31** | |

## Files Modified

### 1. MainWindowViewModel.cs

**Path:** `src/AIntern.Desktop/ViewModels/MainWindowViewModel.cs`
**Lines Added:** ~40

Added ISearchService dependency and OpenSearchCommand:

```csharp
/// <summary>
/// Opens the search dialog (Ctrl+K).
/// </summary>
/// <remarks>
/// <para>
/// Creates a new SearchViewModel and SearchDialog, shows the dialog modally,
/// and navigates to the selected result if one was chosen.
/// </para>
/// <para>Added in v0.2.5e.</para>
/// </remarks>
[RelayCommand]
private async Task OpenSearchAsync()
{
    var searchViewModel = new SearchViewModel(_searchService, ...);
    var searchDialog = new SearchDialog { DataContext = searchViewModel };
    var result = await searchDialog.ShowDialog<SearchResult?>(_mainWindow);

    if (result != null)
    {
        // Navigate to selected conversation
        var conversation = ConversationListViewModel.Groups
            .SelectMany(g => g.Items)
            .FirstOrDefault(c => c.Id == result.ConversationId);

        if (conversation != null)
        {
            await ConversationListViewModel.SelectConversationCommand.ExecuteAsync(conversation);
        }
    }

    searchViewModel.Dispose();
}
```

### 2. MainWindow.axaml

**Path:** `src/AIntern.Desktop/Views/MainWindow.axaml`
**Lines Added:** ~3

Added Ctrl+K keybinding:

```xml
<Window.KeyBindings>
    <!-- Existing bindings... -->
    <!-- Ctrl+K: Open search dialog (v0.2.5e) -->
    <KeyBinding Gesture="Ctrl+K" Command="{Binding OpenSearchCommand}" />
</Window.KeyBindings>
```

### 3. ServiceCollectionExtensions.cs

**Path:** `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs`
**Lines Added:** ~5

Added SearchViewModel registration:

```csharp
// Search: spotlight-style search dialog ViewModel with debounced search.
// Transient so each dialog gets its own instance with fresh state.
// Uses ISearchService for FTS5 search operations.
// Added in v0.2.5e.
services.AddTransient<SearchViewModel>();
```

### 4. CHANGELOG.md

**Path:** `CHANGELOG.md`
**Lines Added:** ~20

Added v0.2.5e entry at top.

## Logging Specifications

All methods use exhaustive logging with Stopwatch timing:

| Marker | Level | Usage |
|--------|-------|-------|
| `[INIT]` | Debug | Constructor |
| `[ENTER]` | Debug | Method entry with parameters |
| `[INFO]` | Debug | Significant state/action |
| `[SKIP]` | Debug | No-op conditions (e.g., cancelled) |
| `[EXIT]` | Debug/Info | Method completion with duration |
| `[ERROR]` | Error | Exception handling |

### Example Log Output

```
[DEBUG] [INIT] SearchViewModel created
[DEBUG] [INFO] Query changed, starting debounce timer
[DEBUG] [ENTER] ExecuteSearchAsync - Query: hello, Filter: All
[DEBUG] [EXIT] ExecuteSearchAsync - 5 results in 12ms
[DEBUG] [INFO] NavigateDown - Selected index: 1
[DEBUG] [ENTER] SelectResult
[INFO] [INFO] Result selected: Conversation - Hello World
[DEBUG] [EXIT] SelectResult
[DEBUG] [INFO] SearchViewModel disposing
[DEBUG] [INFO] SearchViewModel disposed
```

## Usage Examples

### Opening Search via Keyboard

Press `Ctrl+K` from anywhere in the main window to open the search dialog.

### Searching for Content

1. Type your search query in the input box
2. Results appear after 300ms debounce
3. Use Up/Down arrows to navigate
4. Press Enter to select and navigate to result
5. Press Escape to cancel

### Filtering Results

Click the filter tabs to narrow results:
- "All" - Show all matching results
- "Conversations" - Only conversation titles
- "Messages" - Only message content

### Programmatic Usage

```csharp
// Create and show search dialog
var searchViewModel = new SearchViewModel(searchService, logger);
var dialog = new SearchDialog { DataContext = searchViewModel };

var result = await dialog.ShowDialog<SearchResult?>(parentWindow);

if (result != null)
{
    // Navigate to result
    await NavigateToConversation(result.ConversationId);
}

searchViewModel.Dispose();
```

## Design Decisions

| Decision | Rationale |
|----------|-----------|
| **300ms debounce** | Balances responsiveness with avoiding excessive searches |
| **CancellationToken** | Prevents stale results from overwriting newer ones |
| **Transient ViewModel** | Fresh instance per dialog, no state retention needed |
| **Spotlight-style dialog** | Familiar UX pattern (Cmd+K, Ctrl+P in other apps) |
| **Borderless window** | Clean, modern appearance |
| **Grouped results** | Clear visual organization by type |
| **Wrap-around navigation** | Intuitive keyboard behavior |
| **IDisposable pattern** | Ensures timer and CTS cleanup |
| **Direct Dispatcher.UIThread** | Simpler than injecting IDispatcher for this use case |

## Acceptance Criteria

| ID | Criterion | Status |
|----|-----------|--------|
| AC-1 | SearchViewModel has required properties | ✅ |
| AC-2 | 300ms debounce on query changes | ✅ |
| AC-3 | Previous search cancelled on new query | ✅ |
| AC-4 | Filter tabs work (All, Conversations, Messages) | ✅ |
| AC-5 | Up/Down keyboard navigation works | ✅ |
| AC-6 | Navigation wraps around at ends | ✅ |
| AC-7 | Enter selects result and closes dialog | ✅ |
| AC-8 | Escape closes dialog | ✅ |
| AC-9 | Ctrl+K opens search from MainWindow | ✅ |
| AC-10 | Results grouped by type | ✅ |
| AC-11 | Status bar shows count and timing | ✅ |
| AC-12 | SearchViewModel registered in DI | ✅ |
| AC-13 | Comprehensive XML documentation | ✅ |
| AC-14 | Exhaustive logging with timing | ✅ |
| AC-15 | 31 unit tests | ✅ |
| AC-16 | Build passes with 0 errors, 0 warnings | ✅ |

## Dependencies

### Required (Already Implemented)

| Component | Version | Purpose |
|-----------|---------|---------|
| ISearchService | v0.2.5b | FTS5 search operations |
| SearchQuery | v0.2.5b | Query factory methods |
| SearchResult | v0.2.5b | Result model |
| SearchResults | v0.2.5b | Results with Summary |
| ViewModelBase | v0.2.0 | Base class with IsBusy, ErrorMessage |

### Downstream (Future)

| Component | Version | Description |
|-----------|---------|-------------|
| Message highlighting | Future | Scroll to specific message in chat |
| Search history | Future | Remember recent searches |

## Files Summary

| File | Action | Lines |
|------|--------|-------|
| `src/AIntern.Desktop/ViewModels/SearchViewModel.cs` | Create | ~550 |
| `src/AIntern.Desktop/Views/SearchDialog.axaml` | Create | ~280 |
| `src/AIntern.Desktop/Views/SearchDialog.axaml.cs` | Create | ~230 |
| `tests/AIntern.Desktop.Tests/ViewModels/SearchViewModelTests.cs` | Create | ~400 |
| `docs/changelog/v0.2.5e.md` | Create | ~400 |
| `src/AIntern.Desktop/ViewModels/MainWindowViewModel.cs` | Modify | +40 |
| `src/AIntern.Desktop/Views/MainWindow.axaml` | Modify | +3 |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Modify | +5 |
| `CHANGELOG.md` | Modify | +20 |
| **Total** | | **~1,928** |

## Next Steps

| Version | Description |
|---------|-------------|
| v0.2.6 | Additional features TBD |
