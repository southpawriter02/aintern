# v0.4.2c: Inline Diff Service

**Release Date:** January 16, 2026  
**Type:** Feature (Diff Engine)  
**Parent:** v0.4.2 Diff Engine

---

## Overview

v0.4.2c implements character-level inline diff computation for modified lines. This enables precise highlighting of exactly what changed within a line, making it easier for users to understand specific modifications like variable renames, value changes, or minor syntax adjustments.

---

## New Files

### Core Interfaces & Models
| File | Purpose | Lines |
|------|---------|-------|
| `src/AIntern.Core/Interfaces/IInlineDiffService.cs` | Inline diff interface | ~55 |
| `src/AIntern.Core/Models/InlineSegment.cs` | Rendering model for text segments | ~80 |

### Service Implementation
| File | Purpose | Lines |
|------|---------|-------|
| `src/AIntern.Services/InlineDiffService.cs` | DiffPlex-based character diff | ~165 |

### Unit Tests
| File | Test Count |
|------|------------|
| `tests/AIntern.Core.Tests/Models/InlineSegmentTests.cs` | 6 |
| `tests/AIntern.Services.Tests/InlineDiffServiceTests.cs` | 14 |
| **Total** | **20** |

---

## Key Features

### 1. IInlineDiffService Interface

Two main methods for inline diff computation:

```csharp
public interface IInlineDiffService
{
    /// <summary>Compute inline changes between two lines.</summary>
    IReadOnlyList<InlineChange> ComputeInlineChanges(
        string originalLine,
        string proposedLine);

    /// <summary>Split a line into segments for rendering.</summary>
    IReadOnlyList<InlineSegment> GetInlineSegments(
        string content,
        IReadOnlyList<InlineChange> changes,
        DiffSide side);
}
```

### 2. InlineSegment Model

Rendering-focused counterpart to InlineChange:

```csharp
public sealed class InlineSegment
{
    public string Text { get; init; }
    public bool IsChanged { get; init; }
    public InlineChangeType Type { get; init; }
    public int Length => Text.Length;
    public bool IsEmpty => string.IsNullOrEmpty(Text);
    
    // Static factories
    public static InlineSegment Unchanged(string text);
    public static InlineSegment Added(string text);
    public static InlineSegment Removed(string text);
}
```

### 3. DiffService Integration

Added inline diff computation to the main diff service:

- **Levenshtein Distance**: Efficient similarity calculation
- **Similarity Threshold**: Skip inline diff for very different lines (< 30%)
- **Line Length Guard**: Skip for long lines (> 500 chars)
- **Adjacent Pair Detection**: Find Removed → Added pairs for inline diff

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Inline Diff Processing Flow                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  DiffService.ComputeDiff()                                               │
│           │                                                              │
│           ▼                                                              │
│  ┌─────────────────────┐                                                 │
│  │   BuildHunks()      │  Creates adjacent Removed/Added pairs          │
│  └──────────┬──────────┘                                                 │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────┐                                                 │
│  │ ComputeInlineDiffs()│  Process each hunk for inline changes          │
│  └──────────┬──────────┘                                                 │
│             │                                                            │
│             ▼                                                            │
│  ┌─────────────────────────────────────────────────────────────┐        │
│  │  For each adjacent Removed/Added line pair:                  │        │
│  │  ┌─────────────────────────────────────────────────────────┐│        │
│  │  │  1. Check ShouldComputeInlineDiff()                     ││        │
│  │  │     ├── Line length < MaxInlineDiffLineLength (500)     ││        │
│  │  │     └── Similarity >= InlineDiffSimilarityThreshold (30%)||        │
│  │  │                                                          ││        │
│  │  │  2. Call InlineDiffService.ComputeInlineChanges()       ││        │
│  │  │     └── Uses DiffPlex CreateCharacterDiffs              ││        │
│  │  │                                                          ││        │
│  │  │  3. Update DiffLine.InlineChanges                       ││        │
│  │  │  4. Link paired lines via PairedLine property           ││        │
│  │  └─────────────────────────────────────────────────────────┘│        │
│  └─────────────────────────────────────────────────────────────┘        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Modified Files

| File | Changes |
|------|---------|
| `src/AIntern.Services/DiffService.cs` | Added inline diff integration, Levenshtein algorithm |
| `src/AIntern.Core/Models/DiffLine.cs` | Changed InlineChanges to `set` accessor |
| `src/AIntern.Desktop/Extensions/ServiceCollectionExtensions.cs` | Registered IInlineDiffService |

---

## Algorithms

### Levenshtein Distance

Space-optimized single-row implementation:

- **Time Complexity**: O(m × n)
- **Space Complexity**: O(min(m, n))
- **Use**: Compute similarity ratio between modified lines

### Similarity Calculation

```csharp
double similarity = 1.0 - (levenshteinDistance / maxLength);
```

---

## Test Coverage

| Test Category | Count | Coverage |
|---------------|-------|----------|
| InlineSegmentTests | 6 | Factory methods, properties |
| InlineDiffServiceTests | 14 | ComputeInlineChanges, GetInlineSegments |
| DiffServiceTests (inline) | 4+ | Integration, Levenshtein |
| **Total New** | **20+** | |

---

## Usage Examples

### Basic Inline Diff
```csharp
var service = new InlineDiffService();
var changes = service.ComputeInlineChanges(
    "var count = 10;",
    "var count = 25;");

// Result: Unchanged "var count = ", Removed "10", Added "25", Unchanged ";"
```

### Getting Segments for Rendering
```csharp
// Get segments for original side (shows removed text)
var originalSegments = service.GetInlineSegments(
    "var count = 10;",
    changes,
    DiffSide.Original);

// Get segments for proposed side (shows added text)
var proposedSegments = service.GetInlineSegments(
    "var count = 25;",
    changes,
    DiffSide.Proposed);
```

---

## Breaking Changes

- `DiffLine.InlineChanges` changed from `init` to `set` accessor (backward compatible)

---

## Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| DiffPlex | 1.7.2 | Character-level diff via CreateCharacterDiffs |

### Prior Version Dependencies
| Version | Dependency |
|---------|------------|
| v0.4.2a | InlineChange, InlineChangeType, DiffSide models |
| v0.4.2b | DiffService, DiffOptions, IDiffService |

---

## Next Steps

**v0.4.2d: Diff Viewer UI** - Visual display of diff results with inline highlighting
